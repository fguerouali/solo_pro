<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo POS - Point de Vente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .table { transition: all 0.3s ease; }
        .table.available { background-color: #ffffff; border: 2px solid #4ade80; color: #166534; }
        .table.occupied { background-color: #fef9c3; border: 2px solid #facc15; color: #854d0e; }
        .table.paying { background-color: #cffafe; border: 2px solid #22d3ee; color: #155e75; }
        .modal { display: none; }
        .modal.flex { display: flex; }
        .header-font { font-family: 'Poppins', sans-serif; }
        .btn { @apply font-bold py-2 px-4 rounded-lg shadow-md transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-primary { @apply bg-gray-800 text-white hover:bg-gray-900; }
        .btn-secondary { @apply bg-gray-200 text-gray-800 hover:bg-gray-300; }
        .btn-green { @apply bg-green-600 text-white hover:bg-green-700; }
        .btn-red { @apply bg-red-600 text-white hover:bg-red-700; }
        .btn-cyan { @apply bg-cyan-600 text-white hover:bg-cyan-700; }
        .input-style { @apply mt-1 p-2 w-full border border-gray-300 rounded-lg shadow-sm focus:ring-gray-800 focus:border-gray-800; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Container Principal -->
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="header-font text-4xl font-extrabold text-gray-900">SOLO POS</h1>
                <p class="text-gray-500">Point de Vente</p>
            </div>
             <div id="status-indicator" class="text-right">
                <p class="font-semibold text-green-600"><i class="fas fa-check-circle"></i> Connecté</p>
                <p class="text-xs text-gray-500">Prêt à encaisser</p>
            </div>
        </header>

        <!-- Plan de table -->
        <main id="table-plan" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6">
            <!-- Les tables seront générées par JS -->
        </main>
    </div>

    <!-- Modal Prise de Commande -->
    <div id="order-modal" class="modal fixed z-10 inset-0 bg-black bg-opacity-50 justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 max-h-[90vh]">
            <!-- Colonne de gauche : Menu -->
            <div class="p-6 overflow-y-auto">
                <h3 id="order-modal-title" class="text-2xl font-bold mb-4">Table 1</h3>
                <div id="menu-items" class="space-y-4">
                    <!-- Les produits seront chargés ici -->
                </div>
            </div>
            <!-- Colonne de droite : Commande en cours -->
            <div class="p-6 bg-gray-50 rounded-r-2xl flex flex-col">
                <h4 class="text-xl font-semibold mb-4">Commande en cours</h4>
                <div id="current-order-items" class="flex-grow space-y-2 overflow-y-auto pr-2">
                    <p id="current-order-placeholder" class="text-gray-500">Aucun article.</p>
                </div>
                <div class="mt-4 border-t pt-4">
                    <label for="kitchen-note" class="block text-sm font-medium">Message pour la cuisine</label>
                    <input type="text" id="kitchen-note" class="input-style" placeholder="Ex: Sans oignons...">
                    <div class="flex justify-between items-center mt-4">
                        <span class="text-xl font-bold">Total</span>
                        <span id="current-order-total" class="text-2xl font-extrabold">0.00 Mad</span>
                    </div>
                    <div class="mt-4 flex gap-4">
                        <button id="cancel-order-btn" class="btn btn-secondary w-full">Annuler</button>
                        <button id="validate-order-btn" class="btn btn-primary w-full"><i class="fas fa-check mr-2"></i>Valider & Lancer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Encaissement -->
    <div id="payment-modal" class="modal fixed z-20 inset-0 bg-black bg-opacity-50 justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <h3 id="payment-modal-title" class="text-2xl font-bold mb-4">Encaissement Table 1</h3>
            <div class="text-center mb-4">
                <p class="text-gray-500">Total à Payer</p>
                <p id="payment-total" class="text-5xl font-extrabold text-gray-900">0.00 Mad</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Méthode de Paiement</label>
                    <div class="mt-2 grid grid-cols-2 gap-4">
                        <button data-method="Carte" class="payment-method-btn btn btn-secondary text-lg"><i class="fas fa-credit-card mr-2"></i>Carte</button>
                        <button data-method="Espèce" class="payment-method-btn btn btn-secondary text-lg"><i class="fas fa-money-bill-wave mr-2"></i>Espèce</button>
                    </div>
                </div>
                <div id="cash-payment-section" class="hidden">
                    <label for="cash-received" class="block text-sm font-medium">Montant Reçu</label>
                    <input type="number" id="cash-received" class="input-style text-center text-xl" min="0">
                    <div class="mt-2 text-center bg-gray-100 p-3 rounded-lg">
                        <p class="text-gray-500">Monnaie à rendre</p>
                        <p id="change-due" class="text-3xl font-bold text-cyan-600">0.00 Mad</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex gap-4">
                <button id="cancel-payment-btn" class="btn btn-secondary w-full">Retour</button>
                <button id="process-payment-btn" class="btn btn-green w-full" disabled>Valider Paiement</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, writeBatch, serverTimestamp, increment, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfigFromUser = {
            apiKey: "AIzaSyCzUX90zSN2zG9O97g7TNyTmTSNte9OT-E",
            authDomain: "solopro-6521a.firebaseapp.com",
            projectId: "solopro-6521a",
            storageBucket: "solopro-6521a.appspot.com",
            messagingSenderId: "126450282941",
            appId: "1:126450282941:web:10e5255e6ee7c75fa8e2d4"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigFromUser;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pizzeria-pro';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // --- INITIALISATION FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- COLLECTIONS REFS ---
        let productsCol, ordersCol, ingredientsCol;

        // --- ETAT GLOBAL DE L'APPLICATION ---
        let allProducts = [];
        let tables = [];
        let currentTableId = null;
        const NUMBER_OF_TABLES = 10;
        
        // --- INITIALISATION DE L'APP ---
        function initializeTables() {
            for (let i = 1; i <= NUMBER_OF_TABLES; i++) {
                tables.push({ id: i, status: 'available', order: [], total: 0, note: '' });
            }
            renderTablePlan();
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                productsCol = collection(db, `artifacts/${appId}/public/data/products`);
                ordersCol = collection(db, `artifacts/${appId}/public/data/orders`);
                ingredientsCol = collection(db, `artifacts/${appId}/public/data/ingredients`);
                
                onSnapshot(productsCol, snapshot => {
                    allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMenuItems();
                });
                
            } else {
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (error) { console.error("Auth failed:", error); }
            }
        });
        
        // --- GESTION MODALS ---
        const openModal = (id) => document.getElementById(id).classList.add('flex');
        const closeModal = (id) => document.getElementById(id).classList.remove('flex');
        
        // --- RENDERING ---
        function renderMenuItems() {
            const menuContainer = document.getElementById('menu-items');
            menuContainer.innerHTML = '';
            ['Pizza', 'Boisson', 'Dessert'].forEach(type => {
                const productsOfType = allProducts.filter(p => p.type === type);
                if (productsOfType.length > 0) {
                    let itemsHtml = productsOfType.map(p => `
                        <div data-id="${p.id}" class="add-item-btn flex justify-between items-center p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-gray-100">
                            <div>
                                <p class="font-semibold">${p.name}</p>
                                <p class="text-sm text-gray-500">${p.price.toFixed(2)} Mad</p>
                            </div>
                            <i class="fas fa-plus-circle text-green-500 text-xl"></i>
                        </div>
                    `).join('');
                    
                    menuContainer.innerHTML += `
                        <h4 class="text-lg font-bold mt-4 border-b pb-1">${type}s</h4>
                        <div class="space-y-2">${itemsHtml}</div>
                    `;
                }
            });
        }
        
        function renderCurrentOrder() {
            const table = tables.find(t => t.id === currentTableId);
            if (!table) return;

            const itemsContainer = document.getElementById('current-order-items');
            const placeholder = document.getElementById('current-order-placeholder');
            
            itemsContainer.innerHTML = '';
            if (table.order.length === 0) {
                itemsContainer.appendChild(placeholder);
            } else {
                table.order.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between bg-white p-2 rounded-md';
                    itemEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.quantity} x ${item.price.toFixed(2)} Mad</p>
                        </div>
                        <button data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                    `;
                    itemsContainer.appendChild(itemEl);
                });
            }
            
            table.total = table.order.reduce((acc, item) => acc + (item.quantity * item.price), 0);
            document.getElementById('current-order-total').textContent = `${table.total.toFixed(2)} Mad`;
            document.getElementById('kitchen-note').value = table.note || '';
        }

        // --- GESTION DES COMMANDES ---
        function openOrderModal(tableId) {
            currentTableId = tableId;
            document.getElementById('order-modal-title').textContent = `Table ${tableId}`;
            renderCurrentOrder();
            openModal('order-modal');
        }

        document.body.addEventListener('click', e => {
            const addBtn = e.target.closest('.add-item-btn');
            if(addBtn) {
                const productId = addBtn.dataset.id;
                const product = allProducts.find(p => p.id === productId);
                const table = tables.find(t => t.id === currentTableId);
                
                if (product && table) {
                    const existingItem = table.order.find(item => item.id === productId);
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        table.order.push({ ...product, quantity: 1 });
                    }
                    renderCurrentOrder();
                }
            }
            
            const removeBtn = e.target.closest('.remove-item-btn');
            if(removeBtn) {
                const index = parseInt(removeBtn.dataset.index);
                const table = tables.find(t => t.id === currentTableId);
                if (table && table.order[index]) {
                    table.order[index].quantity--;
                    if (table.order[index].quantity <= 0) {
                        table.order.splice(index, 1);
                    }
                    renderCurrentOrder();
                }
            }
        });

        document.getElementById('cancel-order-btn').addEventListener('click', () => {
            closeModal('order-modal');
            currentTableId = null;
        });
        
        function printTicket(htmlContent) {
            const frame = document.createElement('iframe');
            frame.style.position = 'absolute';
            frame.style.width = '0';
            frame.style.height = '0';
            frame.style.border = '0';
            document.body.appendChild(frame);
            
            const frameDoc = frame.contentWindow.document;
            frameDoc.open();
            frameDoc.write(`
                <html><head><title>${document.title}</title>
                <style>
                    body { font-family: monospace; margin: 0; padding: 5px; }
                    h3 { text-align: center; margin: 0; }
                    p, div { margin: 2px 0; }
                    .center { text-align: center; }
                    .items { border-top: 1px dashed black; border-bottom: 1px dashed black; padding: 5px 0; margin: 5px 0; }
                    .total { font-weight: bold; font-size: 1.1em; }
                    .flex-between { display: flex; justify-content: space-between; }
                </style>
                </head><body>${htmlContent}</body></html>
            `);
            frameDoc.close();

            setTimeout(() => {
                frame.contentWindow.focus();
                frame.contentWindow.print();
                document.body.removeChild(frame);
            }, 250);
        }

        document.getElementById('validate-order-btn').addEventListener('click', () => {
            const table = tables.find(t => t.id === currentTableId);
            if (!table || table.order.length === 0) return;
            
            table.status = 'occupied';
            table.note = document.getElementById('kitchen-note').value;

            // --- Impression ---
            const pizzaItems = table.order.filter(p => p.type === 'Pizza');
            const otherItems = table.order.filter(p => p.type !== 'Pizza');
            const noteHtml = table.note ? `<div><strong>NOTE:</strong> ${table.note}</div>` : '';

            if (pizzaItems.length > 0) {
                let pizzaContent = `<h3>PIZZA - T${table.id}</h3>`;
                pizzaItems.forEach(item => { pizzaContent += `<div><strong>${item.quantity} x ${item.name}</strong></div>`; });
                pizzaContent += noteHtml;
                printTicket(pizzaContent);
            }

            if (otherItems.length > 0) {
                let kitchenContent = `<h3>CUISINE - T${table.id}</h3>`;
                otherItems.forEach(item => { kitchenContent += `<div><strong>${item.quantity} x ${item.name}</strong></div>`; });
                kitchenContent += noteHtml;
                printTicket(kitchenContent);
            }

            renderTablePlan();
            closeModal('order-modal');
        });

        // --- GESTION DU PAIEMENT ---
        function renderTablePlan() {
            const plan = document.getElementById('table-plan');
            plan.innerHTML = '';
            tables.forEach(table => {
                const tableEl = document.createElement('div');
                tableEl.className = `table ${table.status} h-32 rounded-xl flex flex-col justify-center items-center cursor-pointer shadow-lg relative`;
                tableEl.dataset.id = table.id;
                
                let statusIcon = '<i class="fas fa-check-circle text-2xl mb-1"></i>';
                if (table.status === 'occupied') statusIcon = '<i class="fas fa-utensils text-2xl mb-1"></i>';
                if (table.status === 'paying') statusIcon = '<i class="fas fa-hand-holding-usd text-2xl mb-1"></i>';

                let checkoutBtn = '';
                if(table.status === 'occupied'){
                    checkoutBtn = `<button data-id="${table.id}" class="checkout-btn absolute bottom-2 right-2 btn btn-cyan text-xs py-1 px-2">Encaisser</button>`;
                }

                tableEl.innerHTML = `
                    ${statusIcon}
                    <p class="font-bold text-xl">Table ${table.id}</p>
                    <p class="text-sm font-semibold">${table.total.toFixed(2)} Mad</p>
                    ${checkoutBtn}
                `;
                plan.appendChild(tableEl);
            });
        }
        
        document.getElementById('table-plan').addEventListener('click', (e) => {
            const checkoutBtn = e.target.closest('.checkout-btn');
            if(checkoutBtn){
                e.stopPropagation(); // Prevent opening order modal
                const tableId = parseInt(checkoutBtn.dataset.id);
                openPaymentModal(tableId);
                return;
            }

            const tableEl = e.target.closest('.table');
            if (!tableEl) return;
            const tableId = parseInt(tableEl.dataset.id);
            openOrderModal(tableId);
        });

        function updatePaymentButtonState() {
            const table = tables.find(t => t.id === currentTableId);
            const paymentMethod = document.querySelector('.payment-method-btn.bg-gray-800')?.dataset.method;
            const processBtn = document.getElementById('process-payment-btn');

            if (!paymentMethod || !table) {
                processBtn.disabled = true;
                return;
            }

            if (paymentMethod === 'Espèce') {
                const received = parseFloat(document.getElementById('cash-received').value) || 0;
                processBtn.disabled = received < table.total;
            } else { // For 'Carte'
                processBtn.disabled = false;
            }
        }

        function openPaymentModal(tableId) {
            currentTableId = tableId;
            const table = tables.find(t => t.id === tableId);
            if (!table) return;

            document.getElementById('payment-modal-title').textContent = `Encaissement Table ${table.id}`;
            document.getElementById('payment-total').textContent = `${table.total.toFixed(2)} Mad`;
            
            // Reset payment UI
            document.getElementById('cash-payment-section').classList.add('hidden');
            document.getElementById('cash-received').value = '';
            document.getElementById('change-due').textContent = '0.00 Mad';
            document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('bg-gray-800', 'text-white'));
            
            table.status = 'paying';
            renderTablePlan();
            openModal('payment-modal');
            updatePaymentButtonState();
        }

        document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const table = tables.find(t => t.id === currentTableId);
                if (!table) return;

                document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('bg-gray-800', 'text-white'));
                btn.classList.add('bg-gray-800', 'text-white');
                const method = btn.dataset.method;

                if (method === 'Espèce') {
                    document.getElementById('cash-payment-section').classList.remove('hidden');
                    const cashInput = document.getElementById('cash-received');
                    if (cashInput.value === '') {
                        cashInput.value = table.total.toFixed(2);
                    }
                    cashInput.dispatchEvent(new Event('input'));
                } else {
                    document.getElementById('cash-payment-section').classList.add('hidden');
                }
                updatePaymentButtonState();
            });
        });

        document.getElementById('cash-received').addEventListener('input', (e) => {
            const table = tables.find(t => t.id === currentTableId);
            if (!table) return;
            const received = parseFloat(e.target.value) || 0;
            const change = received - table.total;
            document.getElementById('change-due').textContent = `${change >= 0 ? change.toFixed(2) : '0.00'} Mad`;
            updatePaymentButtonState();
        });
        
        document.getElementById('cancel-payment-btn').addEventListener('click', () => {
            const table = tables.find(t => t.id === currentTableId);
            if(table) table.status = table.order.length > 0 ? 'occupied' : 'available';
            renderTablePlan();
            closeModal('payment-modal');
        });

        document.getElementById('process-payment-btn').addEventListener('click', async () => {
            const table = tables.find(t => t.id === currentTableId);
            const paymentMethod = document.querySelector('.payment-method-btn.bg-gray-800')?.dataset.method;

            if (!table || !paymentMethod) return;

            const batch = writeBatch(db);
            const itemsForFirestore = table.order.map(item => ({ id: item.id, name: item.name, quantity: item.quantity, price: item.price }));

            const tempDeductions = new Map();
            for (const orderItem of table.order) {
                 const product = allProducts.find(p => p.id === orderItem.id);
                 if (!product) continue;
                 if (product.type === 'Pizza' && product.recipe) {
                     for (const recipeItem of product.recipe) {
                         const current = tempDeductions.get(recipeItem.id) || 0;
                         tempDeductions.set(recipeItem.id, current + recipeItem.quantity * orderItem.quantity);
                     }
                 } else if (product.linkedIngredientId) {
                     const current = tempDeductions.get(product.linkedIngredientId) || 0;
                     tempDeductions.set(product.linkedIngredientId, current + orderItem.quantity);
                 }
            }
            for (const [ingId, qty] of tempDeductions.entries()) {
                 const ingRef = doc(ingredientsCol, ingId);
                 batch.update(ingRef, { quantity: increment(-qty) });
            }

            const orderData = { items: itemsForFirestore, totalPrice: table.total, paymentMethod: paymentMethod, createdAt: serverTimestamp(), note: table.note };
            const newOrderRef = doc(ordersCol);
            batch.set(newOrderRef, orderData);

            try {
                await batch.commit();
            
                let receiptContent = `
                    <div class="center">
                        <h3>** SOLO PIZZERIA **</h3>
                        <p>Le ${new Date().toLocaleString('fr-FR')}</p>
                        <p>Table: ${table.id}</p>
                    </div>
                    <div class="items">
                `;
                table.order.forEach(item => {
                    receiptContent += `<div class="flex-between"><span>${item.quantity} ${item.name}</span> <span>${(item.quantity * item.price).toFixed(2)}</span></div>`;
                });
                receiptContent += `
                    </div>
                    <div class="flex-between total"><span>TOTAL</span> <span>${table.total.toFixed(2)} Mad</span></div>
                    <p class="center">Payé en: ${paymentMethod}</p>
                    <p class="center">MERCI DE VOTRE VISITE</p>
                `;
                printTicket(receiptContent);

                table.status = 'available';
                table.order = [];
                table.total = 0;
                table.note = '';
                
                renderTablePlan();
                closeModal('payment-modal');

            } catch (error) {
                console.error("Erreur lors de la finalisation de la vente:", error);
                alert("Une erreur est survenue. La vente n'a pas pu être enregistrée.");
            }
        });

        // --- Démarrage ---
        initializeTables();

    </script>
</body>
</html>

