<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo POS - Point de Vente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- SDK Epson ePOS pour l'impression directe -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/epos-print@5/epos-print-5.0.0.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .table { transition: all 0.3s ease; }
        .table.available { background-color: #ffffff; border: 2px solid #4ade80; color: #166534; }
        .table.occupied { background-color: #fef9c3; border: 2px solid #facc15; color: #854d0e; }
        .table.paying { background-color: #cffafe; border: 2px solid #22d3ee; color: #155e75; }
        .modal { display: none; }
        .modal.flex { display: flex; }
        .header-font { font-family: 'Poppins', sans-serif; }
        .btn { @apply font-bold py-2 px-4 rounded-lg shadow-md transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-primary { @apply bg-gray-800 text-white hover:bg-gray-900; }
        .btn-secondary { @apply bg-gray-200 text-gray-800 hover:bg-gray-300; }
        .btn-green { @apply bg-green-600 text-white hover:bg-green-700; }
        .btn-red { @apply bg-red-600 text-white hover:bg-red-700; }
        .btn-cyan { @apply bg-cyan-600 text-white hover:bg-cyan-700; }
        .input-style { @apply mt-1 p-2 w-full border border-gray-300 rounded-lg shadow-sm focus:ring-gray-800 focus:border-gray-800; }
        .category-btn.active { @apply bg-gray-800 text-white; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Container Principal -->
    <div class="container mx-auto p-4 max-w-7xl">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="header-font text-4xl font-extrabold text-gray-900">SOLO POS</h1>
                <p class="text-gray-500">Point de Vente</p>
            </div>
            <div id="status-indicator" class="text-right">
                <!-- Status will be updated by JS -->
            </div>
        </header>

        <!-- Plan de table -->
        <main id="table-plan" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6">
            <!-- Les tables seront générées par JS -->
        </main>
    </div>

    <!-- Modal Prise de Commande -->
    <div id="order-modal" class="modal fixed z-10 inset-0 bg-black bg-opacity-50 justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-5xl flex flex-col max-h-[90vh]">
            <!-- Header du Modal -->
            <div class="p-4 border-b flex justify-between items-center">
                 <h3 id="order-modal-title" class="text-2xl font-bold">Table 1</h3>
                 <button id="settings-btn-modal" class="btn btn-secondary py-1 px-3"><i class="fas fa-cog"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 flex-grow min-h-0">
                <!-- Colonne de gauche : Menu -->
                <div class="flex flex-col min-h-0 p-4">
                    <div class="mb-4">
                        <input type="text" id="menu-search-input" class="input-style" placeholder="Rechercher un produit...">
                    </div>
                    <div class="flex-shrink-0 mb-4 flex gap-2 flex-wrap">
                        <button class="category-btn btn btn-secondary active" data-category="all">Tout</button>
                        <button class="category-btn btn btn-secondary" data-category="Entrée">Entrées</button>
                        <button class="category-btn btn btn-secondary" data-category="Pizza">Pizzas</button>
                        <button class="category-btn btn btn-secondary" data-category="Dessert">Desserts</button>
                        <button class="category-btn btn btn-secondary" data-category="Boisson">Boissons</button>
                    </div>
                    <div id="menu-items" class="flex-grow overflow-y-auto space-y-2 pr-2">
                        <!-- Les produits seront chargés ici -->
                    </div>
                </div>
                <!-- Colonne de droite : Commande en cours -->
                <div class="p-6 bg-gray-50 rounded-r-2xl flex flex-col border-l">
                    <h4 class="text-xl font-semibold mb-4 flex-shrink-0">Commande en cours</h4>
                    <div id="current-order-items" class="flex-grow space-y-2 overflow-y-auto pr-2 min-h-0">
                        <p id="current-order-placeholder" class="text-gray-500">Aucun article.</p>
                    </div>
                    <div class="mt-4 border-t pt-4 flex-shrink-0">
                        <label for="kitchen-note" class="block text-sm font-medium">Message pour la cuisine</label>
                        <input type="text" id="kitchen-note" class="input-style" placeholder="Ex: Sans oignons...">
                        <div class="flex justify-between items-center mt-4">
                            <span class="text-xl font-bold">Total</span>
                            <span id="current-order-total" class="text-2xl font-extrabold">0.00 Mad</span>
                        </div>
                        <div class="mt-4 flex gap-4">
                            <button id="cancel-order-btn" class="btn btn-secondary w-full">Annuler</button>
                            <button id="validate-order-btn" class="btn btn-primary w-full"><i class="fas fa-check mr-2"></i>Valider & Imprimer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Encaissement -->
    <div id="payment-modal" class="modal fixed z-20 inset-0 bg-black bg-opacity-50 justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <h3 id="payment-modal-title" class="text-2xl font-bold mb-4">Encaissement Table 1</h3>
            <div class="text-center mb-4">
                <p class="text-gray-500">Total à Payer</p>
                <p id="payment-total" class="text-5xl font-extrabold text-gray-900">0.00 Mad</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Méthode de Paiement</label>
                    <div class="mt-2 grid grid-cols-2 gap-4">
                        <button data-method="Carte" class="payment-method-btn btn btn-secondary text-lg"><i class="fas fa-credit-card mr-2"></i>Carte</button>
                        <button data-method="Espèce" class="payment-method-btn btn btn-secondary text-lg"><i class="fas fa-money-bill-wave mr-2"></i>Espèce</button>
                    </div>
                </div>
                <div id="cash-payment-section" class="hidden">
                    <label for="cash-received" class="block text-sm font-medium">Montant Reçu</label>
                    <input type="number" id="cash-received" class="input-style text-center text-xl" min="0">
                    <div class="mt-2 text-center bg-gray-100 p-3 rounded-lg">
                        <p class="text-gray-500">Monnaie à rendre</p>
                        <p id="change-due" class="text-3xl font-bold text-cyan-600">0.00 Mad</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex gap-4">
                <button id="cancel-payment-btn" class="btn btn-secondary w-full">Retour</button>
                <button id="process-payment-btn" class="btn btn-green w-full" disabled>Valider & Imprimer Ticket</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Paramètres -->
    <div id="settings-modal" class="modal fixed z-30 inset-0 bg-black bg-opacity-50 justify-center items-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6">Paramètres d'Impression</h3>
            <div class="space-y-4">
                <div>
                    <label for="printer-pizza" class="block text-sm font-medium"><i class="fas fa-pizza-slice mr-2"></i>Adresse IP Imprimante Pizzaiolo</label>
                    <input type="text" id="printer-pizza" class="input-style" placeholder="Ex: 192.168.1.101">
                </div>
                <div>
                    <label for="printer-kitchen" class="block text-sm font-medium"><i class="fas fa-utensils mr-2"></i>Adresse IP Imprimante Cuisine</label>
                    <input type="text" id="printer-kitchen" class="input-style" placeholder="Ex: 192.168.1.100">
                </div>
                <div>
                    <label for="printer-cashier" class="block text-sm font-medium"><i class="fas fa-cash-register mr-2"></i>Adresse IP Imprimante Caisse</label>
                    <input type="text" id="printer-cashier" class="input-style" placeholder="Ex: 192.168.1.102">
                </div>
                <div class="bg-blue-50 text-blue-800 p-3 rounded-lg text-sm">
                    <p><i class="fas fa-info-circle mr-2"></i>Cette solution nécessite des imprimantes réseau compatibles (Ex: Epson TM-T series). L'application communiquera directement avec elles.</p>
                </div>
            </div>
             <div class="mt-6 flex justify-end gap-4">
                <button id="cancel-settings-btn" class="btn btn-secondary">Fermer</button>
                <button id="save-settings-btn" class="btn btn-primary">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Toast/Notification -->
    <div id="toast" class="hidden fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, writeBatch, serverTimestamp, increment, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfigFromUser = {
            apiKey: "AIzaSyCzUX90zSN2zG9O97g7TNyTmTSNte9OT-E",
            authDomain: "solopro-6521a.firebaseapp.com",
            projectId: "solopro-6521a",
            storageBucket: "solopro-6521a.appspot.com",
            messagingSenderId: "126450282941",
            appId: "1:126450282941:web:10e5255e6ee7c75fa8e2d4"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigFromUser;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pizzeria-pro';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        // --- INITIALISATION FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- COLLECTIONS REFS ---
        let productsCol, ordersCol, ingredientsCol;

        // --- ETAT GLOBAL DE L'APPLICATION ---
        let allProducts = [];
        let tables = [];
        let currentTableId = null;
        let printerSettings = { kitchen: '', pizza: '', cashier: '' };
        const NUMBER_OF_TABLES = 10;
        
        // --- INITIALISATION DE L'APP ---
        function initializeTables() {
            for (let i = 1; i <= NUMBER_OF_TABLES; i++) {
                tables.push({ id: i, status: 'available', order: [], total: 0, note: '' });
            }
            renderTablePlan();
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const statusIndicator = document.getElementById('status-indicator');
                statusIndicator.innerHTML = `<p class="font-semibold text-green-600"><i class="fas fa-check-circle"></i> Connecté à Firebase</p>`;

                productsCol = collection(db, `artifacts/${appId}/public/data/products`);
                ordersCol = collection(db, `artifacts/${appId}/public/data/orders`);
                ingredientsCol = collection(db, `artifacts/${appId}/public/data/ingredients`);
                
                onSnapshot(productsCol, snapshot => {
                    allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderMenuItems();
                });
                
            } else {
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (error) { console.error("Auth failed:", error); }
            }
        });
        
        // --- HELPERS ---
        const showToast = (message, isError = false) => { 
            const toast = document.getElementById('toast'); 
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message; 
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
            toast.classList.remove('hidden'); 
            setTimeout(() => toast.classList.add('hidden'), 3000); 
        };

        // --- GESTION MODALS ---
        const openModal = (id) => document.getElementById(id).classList.add('flex');
        const closeModal = (id) => document.getElementById(id).classList.remove('flex');
        
        // --- RENDERING ---
        function renderMenuItems(searchTerm = '', category = 'all') {
            const menuContainer = document.getElementById('menu-items');
            menuContainer.innerHTML = '';
            const normalizedSearch = searchTerm.toLowerCase().trim();

            const filteredProducts = allProducts.filter(p => {
                const inCategory = category === 'all' || p.type === category;
                const matchesSearch = normalizedSearch === '' || p.name.toLowerCase().includes(normalizedSearch);
                return inCategory && matchesSearch;
            });
            
            if (filteredProducts.length === 0) {
                menuContainer.innerHTML = `<p class="text-gray-500 text-center">Aucun produit trouvé.</p>`;
                return;
            }

            const productsByType = filteredProducts.reduce((acc, p) => {
                if (!acc[p.type]) acc[p.type] = [];
                acc[p.type].push(p);
                return acc;
            }, {});

            ['Entrée', 'Pizza', 'Dessert', 'Boisson', 'Autre'].forEach(type => {
                if (productsByType[type] && productsByType[type].length > 0) {
                    let itemsHtml = productsByType[type].map(p => `
                        <div data-id="${p.id}" class="add-item-btn flex justify-between items-center p-3 bg-white rounded-lg shadow-sm cursor-pointer hover:bg-gray-100">
                            <div>
                                <p class="font-semibold">${p.name}</p>
                                <p class="text-sm text-gray-500">${p.price.toFixed(2)} Mad</p>
                            </div>
                            <i class="fas fa-plus-circle text-green-500 text-xl"></i>
                        </div>
                    `).join('');
                    
                    menuContainer.innerHTML += `
                        <h4 class="text-lg font-bold mt-4 border-b pb-1">${type}s</h4>
                        <div class="space-y-2">${itemsHtml}</div>
                    `;
                }
            });
        }
        
        function renderCurrentOrder() {
            const table = tables.find(t => t.id === currentTableId);
            if (!table) return;

            const itemsContainer = document.getElementById('current-order-items');
            const placeholder = document.getElementById('current-order-placeholder');
            
            itemsContainer.innerHTML = '';
            if (table.order.length === 0) {
                itemsContainer.appendChild(placeholder);
            } else {
                table.order.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between bg-white p-2 rounded-md';
                    itemEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.quantity} x ${item.price.toFixed(2)} Mad</p>
                        </div>
                        <button data-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                    `;
                    itemsContainer.appendChild(itemEl);
                });
            }
            
            table.total = table.order.reduce((acc, item) => acc + (item.quantity * item.price), 0);
            document.getElementById('current-order-total').textContent = `${table.total.toFixed(2)} Mad`;
            document.getElementById('kitchen-note').value = table.note || '';
        }

        // --- GESTION DES COMMANDES ---
        function openOrderModal(tableId) {
            currentTableId = tableId;
            document.getElementById('order-modal-title').textContent = `Table ${tableId}`;
            renderCurrentOrder();
            // Reset filters
            document.getElementById('menu-search-input').value = '';
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.category-btn[data-category="all"]').classList.add('active');
            renderMenuItems();
            openModal('order-modal');
        }

        document.body.addEventListener('click', e => {
            const addBtn = e.target.closest('.add-item-btn');
            if(addBtn) {
                const productId = addBtn.dataset.id;
                const product = allProducts.find(p => p.id === productId);
                const table = tables.find(t => t.id === currentTableId);
                
                if (product && table) {
                    const existingItem = table.order.find(item => item.id === productId);
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        table.order.push({ ...product, quantity: 1 });
                    }
                    renderCurrentOrder();
                }
            }
            
            const removeBtn = e.target.closest('.remove-item-btn');
            if(removeBtn) {
                const index = parseInt(removeBtn.dataset.index);
                const table = tables.find(t => t.id === currentTableId);
                if (table && table.order[index]) {
                    table.order[index].quantity--;
                    if (table.order[index].quantity <= 0) {
                        table.order.splice(index, 1);
                    }
                    renderCurrentOrder();
                }
            }
        });

        document.getElementById('cancel-order-btn').addEventListener('click', () => {
            closeModal('order-modal');
            currentTableId = null;
        });
        
        document.getElementById('validate-order-btn').addEventListener('click', async () => {
            const table = tables.find(t => t.id === currentTableId);
            if (!table || table.order.length === 0) return;
            
            table.status = 'occupied';
            table.note = document.getElementById('kitchen-note').value;

            const pizzaItems = table.order.filter(p => p.type === 'Pizza');
            const otherItems = table.order.filter(p => p.type !== 'Pizza' && p.type !== 'Boisson');

            if (pizzaItems.length > 0) {
                await sendToPrinter('pizza', { tableId: table.id, items: pizzaItems, note: table.note });
            }

            if (otherItems.length > 0) {
                await sendToPrinter('kitchen', { tableId: table.id, items: otherItems, note: table.note });
            }

            renderTablePlan();
            closeModal('order-modal');
        });

        // --- GESTION FILTRES MENU ---
        document.getElementById('menu-search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value;
            const activeCategory = document.querySelector('.category-btn.active').dataset.category;
            renderMenuItems(searchTerm, activeCategory);
        });

        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const category = btn.dataset.category;
                const searchTerm = document.getElementById('menu-search-input').value;
                renderMenuItems(searchTerm, category);
            });
        });

        // --- GESTION DU PAIEMENT ---
        function renderTablePlan() {
            const plan = document.getElementById('table-plan');
            plan.innerHTML = '';
            tables.forEach(table => {
                const tableEl = document.createElement('div');
                tableEl.className = `table ${table.status} h-32 rounded-xl flex flex-col justify-center items-center cursor-pointer shadow-lg relative`;
                tableEl.dataset.id = table.id;
                
                let statusIcon = '<i class="fas fa-check-circle text-2xl mb-1"></i>';
                if (table.status === 'occupied') statusIcon = '<i class="fas fa-utensils text-2xl mb-1"></i>';
                if (table.status === 'paying') statusIcon = '<i class="fas fa-hand-holding-usd text-2xl mb-1"></i>';

                let checkoutBtn = '';
                if(table.status === 'occupied'){
                    checkoutBtn = `<button data-id="${table.id}" class="checkout-btn absolute bottom-2 right-2 btn btn-cyan text-xs py-1 px-2">Encaisser</button>`;
                }

                tableEl.innerHTML = `
                    ${statusIcon}
                    <p class="font-bold text-xl">Table ${table.id}</p>
                    <p class="text-sm font-semibold">${table.total.toFixed(2)} Mad</p>
                    ${checkoutBtn}
                `;
                plan.appendChild(tableEl);
            });
        }
        
        document.getElementById('table-plan').addEventListener('click', (e) => {
            const checkoutBtn = e.target.closest('.checkout-btn');
            if(checkoutBtn){
                e.stopPropagation(); 
                const tableId = parseInt(checkoutBtn.dataset.id);
                openPaymentModal(tableId);
                return;
            }

            const tableEl = e.target.closest('.table');
            if (!tableEl) return;
            const tableId = parseInt(tableEl.dataset.id);
            openOrderModal(tableId);
        });

        function updatePaymentButtonState() {
            const table = tables.find(t => t.id === currentTableId);
            const paymentMethod = document.querySelector('.payment-method-btn.bg-gray-800')?.dataset.method;
            const processBtn = document.getElementById('process-payment-btn');

            if (!paymentMethod || !table) {
                processBtn.disabled = true;
                return;
            }

            if (paymentMethod === 'Espèce') {
                const received = parseFloat(document.getElementById('cash-received').value) || 0;
                processBtn.disabled = received < table.total;
            } else { // For 'Carte'
                processBtn.disabled = false;
            }
        }

        function openPaymentModal(tableId) {
            currentTableId = tableId;
            const table = tables.find(t => t.id === tableId);
            if (!table) return;

            document.getElementById('payment-modal-title').textContent = `Encaissement Table ${table.id}`;
            document.getElementById('payment-total').textContent = `${table.total.toFixed(2)} Mad`;
            
            document.getElementById('cash-payment-section').classList.add('hidden');
            document.getElementById('cash-received').value = '';
            document.getElementById('change-due').textContent = '0.00 Mad';
            document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('bg-gray-800', 'text-white'));
            
            table.status = 'paying';
            renderTablePlan();
            openModal('payment-modal');
            updatePaymentButtonState();
        }

        document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const table = tables.find(t => t.id === currentTableId);
                if (!table) return;

                document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('bg-gray-800', 'text-white'));
                btn.classList.add('bg-gray-800', 'text-white');
                const method = btn.dataset.method;

                if (method === 'Espèce') {
                    document.getElementById('cash-payment-section').classList.remove('hidden');
                    const cashInput = document.getElementById('cash-received');
                    if (cashInput.value === '') {
                        cashInput.value = table.total.toFixed(2);
                    }
                    cashInput.dispatchEvent(new Event('input'));
                } else {
                    document.getElementById('cash-payment-section').classList.add('hidden');
                }
                updatePaymentButtonState();
            });
        });

        document.getElementById('cash-received').addEventListener('input', (e) => {
            const table = tables.find(t => t.id === currentTableId);
            if (!table) return;
            const received = parseFloat(e.target.value) || 0;
            const change = received - table.total;
            document.getElementById('change-due').textContent = `${change >= 0 ? change.toFixed(2) : '0.00'} Mad`;
            updatePaymentButtonState();
        });
        
        document.getElementById('cancel-payment-btn').addEventListener('click', () => {
            const table = tables.find(t => t.id === currentTableId);
            if(table) table.status = table.order.length > 0 ? 'occupied' : 'available';
            renderTablePlan();
            closeModal('payment-modal');
        });

        document.getElementById('process-payment-btn').addEventListener('click', async () => {
            const table = tables.find(t => t.id === currentTableId);
            const paymentMethod = document.querySelector('.payment-method-btn.bg-gray-800')?.dataset.method;
            if (!table || !paymentMethod) return;

            const batch = writeBatch(db);
            const itemsForFirestore = table.order.map(item => ({ id: item.id, name: item.name, quantity: item.quantity, price: item.price }));
            const tempDeductions = new Map();
            for (const orderItem of table.order) {
                 const product = allProducts.find(p => p.id === orderItem.id);
                 if (!product) continue;
                 if (product.recipe && product.recipe.length > 0) {
                     for (const recipeItem of product.recipe) {
                         const current = tempDeductions.get(recipeItem.id) || 0;
                         tempDeductions.set(recipeItem.id, current + recipeItem.quantity * orderItem.quantity);
                     }
                 } else if (product.linkedIngredientId) {
                     const current = tempDeductions.get(product.linkedIngredientId) || 0;
                     tempDeductions.set(product.linkedIngredientId, current + orderItem.quantity);
                 }
            }
            for (const [ingId, qty] of tempDeductions.entries()) {
                 const ingRef = doc(ingredientsCol, ingId);
                 batch.update(ingRef, { quantity: increment(-qty) });
            }
            const orderData = { items: itemsForFirestore, totalPrice: table.total, paymentMethod: paymentMethod, createdAt: serverTimestamp(), note: table.note };
            const newOrderRef = doc(ordersCol);
            batch.set(newOrderRef, orderData);

            try {
                await batch.commit();
                await sendToPrinter('cashier', { table, paymentMethod });

                table.status = 'available';
                table.order = [];
                table.total = 0;
                table.note = '';
                
                renderTablePlan();
                closeModal('payment-modal');

            } catch (error) {
                console.error("Erreur lors de la finalisation de la vente:", error);
                showToast("Une erreur est survenue. La vente n'a pas pu être enregistrée.", true);
            }
        });

        // --- GESTION IMPRESSION DIRECTE (EPSON EPOS) ---
        function sendToPrinter(type, data) {
            return new Promise((resolve, reject) => {
                const ip = printerSettings[type];
                if (!ip) {
                    showToast(`Imprimante '${type}' non configurée.`, true);
                    return reject(new Error(`Imprimante '${type}' non configurée.`));
                }

                let eposDevice = new epson.ePOSDevice();
                eposDevice.connect(ip, 8043, (connectResult) => {
                    if (connectResult !== 'OK') {
                        console.error('Erreur de connexion imprimante:', connectResult);
                        showToast(`Connexion impossible à l'imprimante ${type}.`, true);
                        return reject(new Error(`Connexion impossible à l'imprimante ${type}.`));
                    }
                    
                    eposDevice.createDevice('local_printer', eposDevice.DEVICE_TYPE_PRINTER, { 'crypto': true, 'buffer': false }, (deviceObj, returnCode) => {
                        if (returnCode !== 'OK') {
                            console.error('Erreur création device imprimante:', returnCode);
                            showToast(`Erreur initialisation imprimante ${type}.`, true);
                            eposDevice.disconnect();
                            return reject(new Error(`Erreur initialisation imprimante ${type}.`));
                        }

                        const printer = deviceObj;
                        printer.onreceive = function (response) {
                            if (response.success) {
                                showToast(`Impression ${type} réussie.`);
                                resolve();
                            } else {
                                console.error('Erreur impression ePOS:', response);
                                showToast(`Échec de l'impression ${type}: ${response.code}`, true);
                                reject(new Error(response.code));
                            }
                            eposDevice.disconnect();
                        };
                        printer.onerror = function (error) {
                            console.error('Erreur imprimante ePOS:', error);
                            showToast(`Erreur communication imprimante ${type}.`, true);
                            eposDevice.disconnect();
                            reject(error);
                        };
                        
                        // Build ticket content
                        if (type === 'cashier') {
                            printer.addTextAlign(printer.ALIGN_CENTER);
                            printer.addTextFont(printer.FONT_B);
                            printer.addText('** SOLO PIZZERIA **\n');
                            printer.addText(`Le ${new Date().toLocaleString('fr-FR')}\n`);
                            printer.addText(`Table: ${data.table.id}\n`);
                            printer.addFeedLine(1);
                            printer.addTextLine();
                            
                            printer.addTextAlign(printer.ALIGN_LEFT);
                            data.table.order.forEach(item => {
                                const itemTotal = (item.quantity * item.price).toFixed(2);
                                const itemName = `${item.quantity} ${item.name}`;
                                printer.addText(itemName.padEnd(25) + itemTotal.padStart(10) + '\n');
                            });
                            
                            printer.addTextLine();
                            printer.addTextAlign(printer.ALIGN_RIGHT);
                            printer.addTextSize(2, 2);
                            printer.addText(`TOTAL: ${data.table.total.toFixed(2)} Mad\n`);
                            printer.addTextSize(1, 1);
                            printer.addTextAlign(printer.ALIGN_CENTER);
                            printer.addText(`Payé en: ${data.paymentMethod}\n\n`);
                            printer.addText('MERCI DE VOTRE VISITE\n');
                        } else { // kitchen or pizza
                            printer.addTextSize(2, 2);
                            printer.addTextAlign(printer.ALIGN_CENTER);
                            printer.addTextStyle(false, false, true); // bold
                            printer.addText(`${type.toUpperCase()} - T${data.tableId}\n`);
                            printer.addTextStyle(false, false, false);
                            printer.addTextSize(1, 1);
                            printer.addTextLine();
                            
                            printer.addTextAlign(printer.ALIGN_LEFT);
                            printer.addTextSize(1, 2);
                            data.items.forEach(item => {
                                printer.addText(`- ${item.quantity} x ${item.name}\n`);
                            });
                            
                            if (data.note) {
                                printer.addTextLine();
                                printer.addTextSize(1, 1);
                                printer.addTextStyle(false, false, true);
                                printer.addText(`NOTE: ${data.note}\n`);
                            }
                        }

                        printer.addFeedLine(2);
                        printer.addCut(printer.CUT_FEED);
                        printer.send();
                    });
                });
            });
        }
        
        function loadSettings() {
            const savedSettings = localStorage.getItem('soloPosPrinterSettings');
            if (savedSettings) {
                printerSettings = JSON.parse(savedSettings);
            }
            document.getElementById('printer-kitchen').value = printerSettings.kitchen || '';
            document.getElementById('printer-pizza').value = printerSettings.pizza || '';
            document.getElementById('printer-cashier').value = printerSettings.cashier || '';
            checkPrintersStatus();
        }

        async function checkPrintersStatus() {
            const statusIndicator = document.getElementById('status-indicator');
            if (!printerSettings.kitchen && !printerSettings.pizza && !printerSettings.cashier) {
                 statusIndicator.innerHTML = `<p class="font-semibold text-yellow-600 cursor-pointer" id="settings-btn"><i class="fas fa-exclamation-triangle"></i> Imprimantes non configurées</p>`;
            } else {
                statusIndicator.innerHTML = `<p class="font-semibold text-green-600 cursor-pointer" id="settings-btn"><i class="fas fa-print"></i> Imprimantes configurées</p>`;
            }
             document.getElementById('settings-btn').addEventListener('click', () => openModal('settings-modal'));
        }
        
        document.getElementById('settings-btn-modal').addEventListener('click', () => openModal('settings-modal'));
        document.getElementById('cancel-settings-btn').addEventListener('click', () => closeModal('settings-modal'));
        document.getElementById('save-settings-btn').addEventListener('click', () => {
            printerSettings.kitchen = document.getElementById('printer-kitchen').value.trim();
            printerSettings.pizza = document.getElementById('printer-pizza').value.trim();
            printerSettings.cashier = document.getElementById('printer-cashier').value.trim();
            localStorage.setItem('soloPosPrinterSettings', JSON.stringify(printerSettings));
            checkPrintersStatus();
            closeModal('settings-modal');
            showToast('Paramètres d\'impression sauvegardés.');
        });

        // --- Démarrage ---
        initializeTables();
        loadSettings();

    </script>
</body>
</html>

