<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>solo - Gestion Pizzeria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .tab-link.active { 
            border-color: #1f2937; /* gray-800 */
            color: #1f2937; /* gray-800 */
            font-weight: 600;
        }

        .low-stock { background-color: #fee2e2 !important; }
        .low-stock-text { color: #b91c1c; font-weight: 600; }
        
        .modal { display: none; }
        .modal.flex { display: flex; }

        .header-font { font-family: 'Poppins', sans-serif; font-weight: 800; }

        .btn-primary { @apply bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-900 transition-all transform hover:scale-105; }
        .btn-secondary { @apply bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-all; }
        .input-style { @apply p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-800 focus:border-gray-800; }
        
        .kpi-filter-btn.active {
            @apply bg-gray-800 text-white shadow-inner;
        }

        /* Spinner Styles */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block; /* Or block, depending on layout */
            margin: 0 auto; /* Center if block */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- En-tête -->
        <header class="mb-8 text-center">
            <h1 class="header-font text-5xl md:text-6xl font-extrabold text-gray-900 tracking-tight">
                solo
            </h1>
            <p class="text-gray-500 uppercase tracking-widest mt-1 text-sm">Pizzeria Napoletana</p>
        </header>

        <!-- Barre de navigation par onglets -->
        <div class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4 justify-center flex-wrap" aria-label="Tabs">
                    <button class="tab-link active" data-tab="dashboard"><i class="fas fa-chart-line mr-2"></i>Tableau de Bord</button>
                    <button class="tab-link" data-tab="ingredients"><i class="fas fa-box mr-2"></i>Stock</button>
                    <button class="tab-link" data-tab="products"><i class="fas fa-utensils mr-2"></i>Produits</button>
                    <button class="tab-link" data-tab="purchases"><i class="fas fa-truck mr-2"></i>Achats</button>
                    <button class="tab-link" data-tab="orders"><i class="fas fa-receipt mr-2"></i>Ventes & Pertes</button>
                </nav>
            </div>
        </div>

        <!-- Contenu des onglets -->
        <main>
            <!-- Tableau de Bord -->
            <div id="dashboard-content" class="tab-content active">
                 <!-- Bouton pour afficher les filtres -->
                <div class="flex justify-between items-center mb-4">
                    <div>
                         <h2 class="text-2xl font-semibold text-gray-800">Indicateurs de Performance</h2>
                         <p id="kpi-filter-label" class="text-sm text-gray-500">Période : Tout le temps</p>
                    </div>
                    <button id="toggle-kpi-filters-btn" class="btn-secondary"><i class="fas fa-filter mr-2"></i>Filtrer</button>
                </div>

                <!-- Conteneur des filtres (caché par défaut) -->
                <div id="kpi-filter-container" class="hidden mb-6 bg-white p-4 rounded-2xl shadow-lg">
                    <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4">
                        <!-- Filtres Prédéfinis -->
                        <div class="flex gap-2">
                             <button data-filter="today" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Aujourd'hui</button>
                             <button data-filter="week" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Cette semaine</button>
                             <button data-filter="month" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Ce mois</button>
                        </div>
                        <!-- Plage de Dates Personnalisée -->
                        <div class="flex items-center gap-2">
                            <input type="date" id="kpi-start-date" class="input-style p-1 text-sm">
                            <span>à</span>
                            <input type="date" id="kpi-end-date" class="input-style p-1 text-sm">
                            <button id="kpi-filter-range-btn" class="btn-primary py-1 px-3 text-sm">Appliquer</button>
                        </div>
                        <button id="kpi-reset-filter-btn" class="text-gray-500 hover:text-gray-800 text-sm font-medium">Réinitialiser</button>
                    </div>
                </div>


                <!-- KPIs -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6 mb-8">
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Ventes</h3>
                        <p id="kpi-total-sales" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Achats (Reçus)</h3>
                        <p id="kpi-total-purchases" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Achats (Non Payés)</h3>
                        <p id="kpi-unpaid-purchases" class="text-3xl font-bold text-red-600 mt-1">0.00 Mad</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Pertes</h3>
                        <p id="kpi-total-losses" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Ventes (Nbre)</h3>
                        <p id="kpi-total-orders" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
                </div>
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Alertes de Stock</h2>
                <div id="low-stock-alerts" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div id="low-stock-placeholder" class="text-center col-span-full py-10 text-gray-500">
                        <i class="fas fa-check-circle fa-2x text-green-500 mb-2"></i><p>Aucune alerte de stock bas pour le moment.</p>
                    </div>
                </div>
            </div>

            <!-- Ingrédients -->
            <div id="ingredients-content" class="tab-content">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Gestion du Stock</h2>
                    <div class="flex gap-2">
                        <button id="import-ingredients-btn" class="btn-secondary"><i class="fas fa-upload mr-2"></i>Importer</button>
                        <button id="export-ingredients-btn" class="btn-secondary"><i class="fas fa-download mr-2"></i>Exporter</button>
                        <button id="add-ingredient-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Ajouter</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <table id="ingredients-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingrédient</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité en stock</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coût / Unité</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ingredients-list" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                     <div id="ingredients-placeholder" class="hidden text-center py-10 text-gray-500">
                        <p>Aucun ingrédient. Ajoutez-en un pour commencer !</p>
                    </div>
                </div>
            </div>

            <!-- Produits -->
            <div id="products-content" class="tab-content">
                 <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Gestion des Produits</h2>
                    <div class="flex gap-2">
                        <button id="import-products-btn" class="btn-secondary"><i class="fas fa-upload mr-2"></i>Importer</button>
                        <button id="export-products-btn" class="btn-secondary"><i class="fas fa-download mr-2"></i>Exporter</button>
                        <button id="add-product-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Créer un Produit</button>
                    </div>
                </div>
                <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                     <div id="products-placeholder" class="text-center col-span-full py-10 text-gray-500">
                        <p>Aucun produit créé. Créez votre premier produit !</p>
                    </div>
                </div>
            </div>
            
            <!-- Achats / Fournisseurs -->
            <div id="purchases-content" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Section Fournisseurs -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-2xl font-semibold text-gray-800">Fournisseurs</h2>
                             <button id="add-supplier-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Ajouter</button>
                        </div>
                        <div id="suppliers-list" class="space-y-3">
                            <div id="suppliers-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-lg">
                                <p>Aucun fournisseur ajouté.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Section Commandes Fournisseurs -->
                    <div>
                         <div class="flex justify-between items-center mb-4">
                             <h2 class="text-2xl font-semibold text-gray-800">Commandes Fournisseurs</h2>
                             <button id="add-purchase-order-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Nouvelle Commande</button>
                        </div>
                        <div id="purchase-orders-list" class="space-y-3">
                            <div id="purchase-orders-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-lg">
                                <p>Aucune commande fournisseur.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ventes -->
            <div id="orders-content" class="tab-content">
                 <h2 class="text-2xl font-semibold text-gray-800 mb-4">Nouvelle Vente</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                       <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg">
                           <h3 class="text-lg font-medium mb-4">Ajouter des produits à la vente</h3>
                           <form id="add-to-order-form" class="flex items-end gap-4">
                               <div class="flex-grow">
                                   <label for="order-product-select" class="block text-sm font-medium text-gray-700">Produit</label>
                                   <select id="order-product-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-800 focus:border-gray-800"></select>
                               </div>
                               <div>
                                   <label for="order-product-quantity" class="block text-sm font-medium text-gray-700">Quantité</label>
                                   <input type="number" id="order-product-quantity" value="1" min="1" class="mt-1 block w-24 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-800 focus:border-gray-800">
                               </div>
                               <button type="submit" class="bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-900 h-10">Ajouter</button>
                           </form>
                       </div>
                       <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                           <h3 class="text-lg font-medium mb-4">Détail Vente</h3>
                           <div class="mb-4">
                               <label for="sale-date" class="block text-sm font-medium text-gray-700">Date de la vente</label>
                               <input type="date" id="sale-date" class="mt-1 block w-full input-style">
                           </div>
                           <ul id="current-order-list" class="space-y-2 mb-4">
                               <li id="order-placeholder" class="text-gray-500">La vente est vide.</li>
                           </ul>
                           <div class="border-t pt-4">
                               <div class="flex justify-between items-center">
                                   <label for="current-order-total-input" class="text-lg font-semibold text-gray-800">Total (Ajustable)</label>
                                   <div class="flex items-center">
                                       <input type="number" step="0.01" id="current-order-total-input" class="text-2xl font-bold text-gray-900 text-right w-40 input-style p-1" placeholder="0.00">
                                       <span class="text-xl font-bold text-gray-900 ml-2">Mad</span>
                                   </div>
                               </div>
                           </div>
                           <button id="process-order-btn" class="w-full mt-4 bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                               Valider & Déduire du Stock
                           </button>
                       </div>
                 </div>

                 <!-- Section Historique -->
                 <div class="mt-12">
                       <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                           <h2 class="text-2xl font-semibold text-gray-800">Historique</h2>
                            <div class="flex items-center gap-2">
                                <label for="history-date-filter" class="text-sm font-medium text-gray-700">Filtrer par date :</label>
                                <input type="date" id="history-date-filter" class="input-style p-1 text-sm">
                            </div>
                           <div class="flex items-center gap-2 flex-wrap">
                               <button id="declare-loss-btn" class="btn-secondary bg-yellow-400 hover:bg-yellow-500 text-yellow-900"><i class="fas fa-exclamation-triangle mr-2"></i>Déclarer une perte</button>
                               <button id="import-api-sales-btn" class="btn-secondary bg-blue-400 hover:bg-blue-500 text-blue-900"><i class="fas fa-cloud-download-alt mr-2"></i>Importer Ventes (API)</button>
                               <button id="import-orders-btn" class="btn-secondary"><i class="fas fa-upload mr-2"></i>Importer Ventes (CSV)</button>
                               <button id="export-orders-btn" class="btn-secondary"><i class="fas fa-download mr-2"></i>Exporter Ventes</button>
                           </div>
                       </div>
                       <!-- Ventes -->
                       <h3 class="text-xl font-semibold text-gray-700 mb-3">Ventes</h3>
                       <div id="order-history-list" class="space-y-4">
                           <div id="order-history-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-2xl shadow-lg">
                               <i class="fas fa-history fa-2x text-gray-400 mb-2"></i>
                               <p>Aucune vente dans l'historique.</p>
                           </div>
                       </div>
                       <!-- Pertes -->
                       <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-3">Pertes</h3>
                       <div id="loss-history-list" class="space-y-4">
                           <div id="loss-history-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-2xl shadow-lg">
                               <i class="fas fa-box-open fa-2x text-gray-400 mb-2"></i>
                               <p>Aucune perte déclarée.</p>
                           </div>
                       </div>
                 </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="ingredient-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <h3 id="ingredient-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Ajouter un ingrédient</h3>
            <form id="ingredient-form">
                <input type="hidden" id="ingredient-id">
                <div class="space-y-4">
                    <div><label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label><input type="text" id="ingredient-name" required class="mt-1 w-full input-style"></div>
                    <div><label for="ingredient-quantity" class="block text-sm font-medium text-gray-700">Quantité</label><input type="number" id="ingredient-quantity" min="0" step="any" required class="mt-1 w-full input-style"></div>
                    <div><label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unité (kg, L, pièces...)</label><input type="text" id="ingredient-unit" required class="mt-1 w-full input-style"></div>
                    <div><label for="ingredient-cost" class="block text-sm font-medium text-gray-700">Coût par unité (Mad)</label><input type="number" id="ingredient-cost" min="0" step="any" placeholder="1.50" class="mt-1 w-full input-style"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-ingredient">Annuler</button><button type="submit" class="btn-primary">Sauvegarder</button></div>
            </form>
        </div>
    </div>
    
    <div id="product-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-2xl">
            <h3 id="product-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Créer un Produit</h3>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2"><label for="product-name" class="block text-sm font-medium text-gray-700">Nom du Produit</label><input type="text" id="product-name" required class="mt-1 w-full input-style"></div>
                    <div><label for="product-price" class="block text-sm font-medium text-gray-700">Prix de Vente (Mad)</label><input type="number" id="product-price" min="0" step="0.01" required class="mt-1 w-full input-style"></div>
                </div>
                <div class="mt-4"><label for="product-type" class="block text-sm font-medium text-gray-700">Type de produit</label>
                    <select id="product-type" class="mt-1 w-full input-style">
                        <option value="Entrée">Entrée</option>
                        <option value="Pizza">Pizza</option>
                        <option value="Dessert">Dessert</option>
                        <option value="Boisson">Boisson</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div id="recipe-section" class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                         <h4 class="text-lg font-medium text-gray-800">Recette</h4>
                         <p class="text-sm font-semibold text-gray-600">Coût de revient: <span id="current-recipe-cost">0.00 Mad</span></p>
                    </div>
                    <div id="recipe-ingredients-list" class="space-y-2 mb-3"></div>
                    <div class="flex items-end gap-3"><div class="flex-grow"><label class="block text-sm font-medium">Ingrédient</label><select id="recipe-ingredient-select" class="mt-1 w-full input-style"></select></div><div><label class="block text-sm font-medium">Quantité</label><input type="number" id="recipe-quantity" min="0" step="any" class="mt-1 w-28 input-style"></div><button type="button" id="add-recipe-ingredient-btn" class="btn-secondary h-10">Ajouter</button></div>
                </div>
                
                <!-- MODIFICATION: Ajout champ quantité pour produits liés -->
                <div id="linked-ingredient-section" class="mt-6 hidden">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Article en Stock</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label for="linked-ingredient-select" class="block text-sm font-medium">Lier à l'article</label>
                            <select id="linked-ingredient-select" class="mt-1 w-full input-style"></select>
                        </div>
                        <div>
                            <label for="linked-ingredient-quantity" class="block text-sm font-medium">Quantité Consommée</label>
                            <input type="number" id="linked-ingredient-quantity" value="1" min="0" step="any" class="mt-1 w-full input-style">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Quantité de l'article en stock consommée par vente de 1 produit.</p>
                </div>
                <!-- FIN MODIFICATION -->

                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-product">Annuler</button><button type="submit" class="btn-primary">Sauvegarder Produit</button></div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal fixed z-20 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <h3 id="import-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Importer un fichier CSV</h3>
            <div id="import-instructions" class="text-sm text-gray-600 bg-gray-100 p-3 rounded-lg mb-4"></div>
            <div><label for="csv-file-input" class="block text-sm font-medium text-gray-700">Choisir un fichier .csv</label><input type="file" id="csv-file-input" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100"/></div>
            <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-import">Annuler</button><button type="button" class="btn-primary" id="process-import-btn" disabled>Lancer l'importation</button></div>
        </div>
    </div>

    <!-- Modal Import API Sales (Updated for Proxy) -->
     <div id="api-import-modal" class="modal fixed z-20 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Importer Ventes via API</h3>
            <form id="api-import-form">
                <div class="space-y-4">
                    <div>
                        <label for="api-start-date" class="block text-sm font-medium text-gray-700">Date de début</label>
                        <input type="date" id="api-start-date" required class="mt-1 w-full input-style">
                    </div>
                    <div>
                        <label for="api-end-date" class="block text-sm font-medium text-gray-700">Date de fin</label>
                        <input type="date" id="api-end-date" required class="mt-1 w-full input-style">
                    </div>
                    <!-- Champ jeton supprimé -->
                     <div id="api-import-loader" class="hidden text-center py-4">
                        <div class="loader"></div>
                        <p class="text-sm text-gray-500 mt-2">Authentification et importation...</p>
                    </div>
                     <p id="api-import-status" class="text-sm text-center text-gray-600 mt-2"></p>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="btn-secondary" id="cancel-api-import">Annuler</button>
                    <button type="submit" class="btn-primary" id="process-api-import-btn">Lancer l'importation</button>
                </div>
            </form>
        </div>
    </div>

    <div id="supplier-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <h3 id="supplier-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Ajouter un Fournisseur</h3>
            <form id="supplier-form">
                <input type="hidden" id="supplier-id">
                <div class="space-y-4">
                    <div><label for="supplier-name" class="block text-sm font-medium">Nom</label><input type="text" id="supplier-name" required class="mt-1 w-full input-style"></div>
                    <div><label for="supplier-contact" class="block text-sm font-medium">Contact (email, tél...)</label><input type="text" id="supplier-contact" class="mt-1 w-full input-style"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-supplier">Annuler</button><button type="submit" class="btn-primary">Sauvegarder</button></div>
            </form>
        </div>
    </div>

    <div id="purchase-order-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-2xl">
            <h3 id="po-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Nouvelle Commande Fournisseur</h3>
            <form id="purchase-order-form">
                <input type="hidden" id="po-id">
                <div><label for="po-supplier-select" class="block text-sm font-medium">Fournisseur</label><select id="po-supplier-select" required class="mt-1 w-full input-style"></select></div>
                <!-- Statut de Paiement -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">Statut de Paiement</label>
                    <div class="mt-2 flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="po-payment-status" value="unpaid" class="h-4 w-4 text-gray-800 border-gray-300 focus:ring-gray-700" checked>
                            <span class="ml-2 text-sm text-gray-700">Non Payé</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="po-payment-status" value="paid" class="h-4 w-4 text-gray-800 border-gray-300 focus:ring-gray-700">
                            <span class="ml-2 text-sm text-gray-700">Payé</span>
                        </label>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Articles</h4>
                    <!-- MODIFICATION ICI: La liste sera remplie par JS avec des inputs -->
                    <div id="po-items-list" class="space-y-2 mb-3">
                        <!-- Le contenu sera généré par renderCurrentPurchaseOrderItems -->
                    </div>
                    <!-- FIN MODIFICATION -->
                    <div class="grid grid-cols-1 md:grid-cols-4 items-end gap-3">
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Ingrédient</label><select id="po-ingredient-select" class="mt-1 w-full input-style"></select></div>
                        <div><label class="block text-sm font-medium">Quantité</label><input type="number" id="po-quantity" min="0" step="any" class="mt-1 w-full input-style"></div>
                        <div><label class="block text-sm font-medium">Prix/Unité (Mad)</label><input type="number" id="po-price" min="0" step="any" class="mt-1 w-full input-style"></div>
                    </div>
                     <button type="button" id="add-po-item-btn" class="btn-secondary h-10 w-full mt-3">Ajouter à la commande</button>
                </div>
                <div class="border-t pt-4 mt-4">
                    <div class="flex justify-between items-center">
                        <label for="po-total-cost-input" class="text-lg font-semibold text-gray-800">Total Commande (Ajustable)</label>
                         <div class="flex items-center">
                            <input type="number" step="0.01" id="po-total-cost-input" class="text-2xl font-bold text-gray-900 text-right w-48 input-style p-1" placeholder="0.00">
                             <span class="text-xl font-bold text-gray-900 ml-2">Mad</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4"><label for="po-invoice-file" class="block text-sm font-medium text-gray-700">Facture (Optionnel)</label><input type="file" id="po-invoice-file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100"/></div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-purchase-order">Annuler</button><button type="submit" class="btn-primary">Enregistrer Commande</button></div>
            </form>
        </div>
    </div>

    <div id="loss-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Déclarer une Perte</h3>
            <form id="loss-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Type de perte</label>
                        <div class="mt-2 flex gap-4">
                            <label class="flex items-center"><input type="radio" name="loss-type" value="product" class="h-4 w-4 text-gray-800 border-gray-300 focus:ring-gray-700" checked>&nbsp;Produit Fini</label>
                            <label class="flex items-center"><input type="radio" name="loss-type" value="ingredient" class="h-4 w-4 text-gray-800 border-gray-300 focus:ring-gray-700">&nbsp;Ingrédient Brut</label>
                        </div>
                    </div>
                    
                    <div id="loss-product-section">
                        <label for="loss-product-select" class="block text-sm font-medium text-gray-700">Produit</label>
                        <select id="loss-product-select" required class="mt-1 w-full input-style"></select>
                    </div>
                    <div id="loss-ingredient-section" class="hidden">
                         <label for="loss-ingredient-select" class="block text-sm font-medium text-gray-700">Ingrédient</label>
                        <select id="loss-ingredient-select" class="mt-1 w-full input-style"></select>
                    </div>
                     <div>
                        <label for="loss-quantity" class="block text-sm font-medium text-gray-700">Quantité Perdue</label>
                        <input type="number" id="loss-quantity" min="0" step="any" required class="mt-1 w-full input-style">
                    </div>
                     <div>
                        <label for="loss-reason" class="block text-sm font-medium text-gray-700">Raison / Note (optionnel)</label>
                        <textarea id="loss-reason" rows="3" class="mt-1 w-full input-style"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="btn-secondary" id="cancel-loss">Annuler</button>
                    <button type="submit" class="btn-primary bg-yellow-500 hover:bg-yellow-600">Confirmer la Perte</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>

    <!-- CSS Additionnel -->
    <style>
        .tab-link { @apply whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors; }
    </style>

    <script type="module">
        // --- IMPORTS FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc, serverTimestamp, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURATION ---
        const firebaseConfigFromUser = {
            apiKey: "AIzaSyCzUX90zSN2zG9O97g7TNyTmTSNte9OT-E",
            authDomain: "solopro-6521a.firebaseapp.com",
            projectId: "solopro-6521a",
            storageBucket: "solopro-6521a.appspot.com",
            messagingSenderId: "126450282941",
            appId: "1:126450282941:web:10e5255e6ee7c75fa8e2d4"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigFromUser;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pizzeria-pro';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
        
        // --- URL du Proxy ---
        // !!! REMPLACEZ PAR L'URL RÉELLE DE VOTRE PROXY DÉPLOYÉ SUR RENDER !!!
        // Par exemple: "https://solo-proxy.onrender.com"
        const PROXY_URL = "https://solo-proxy.onrender.com"; // <= MODIFIEZ CETTE LIGNE


        // --- INITIALISATION FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- COLLECTIONS REFS ---
        let ingredientsCol, productsCol, ordersCol, suppliersCol, purchaseOrdersCol, lossesCol;

        // --- ETAT GLOBAL ---
        let allIngredients = [];
        let allProducts = [];
        let orderHistory = [];
        let allSuppliers = [];
        let allLosses = [];
        let allPurchaseOrders = [];
        let currentRecipe = [];
        let currentOrder = [];
        let currentPurchaseOrderItems = [];
        let importType = '';

        // --- SEUILS ---
        const LOW_STOCK_THRESHOLD = 10;
        
        // --- AUTHENTIFICATION ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                ingredientsCol = collection(db, `artifacts/${appId}/public/data/ingredients`);
                productsCol = collection(db, `artifacts/${appId}/public/data/products`);
                ordersCol = collection(db, `artifacts/${appId}/public/data/orders`);
                suppliersCol = collection(db, `artifacts/${appId}/public/data/suppliers`);
                purchaseOrdersCol = collection(db, `artifacts/${appId}/public/data/purchaseOrders`);
                lossesCol = collection(db, `artifacts/${appId}/public/data/losses`);
                listenToAllCollections();
                document.getElementById('sale-date').value = getTodayDateString();
                 // Set default dates for API import modal
                document.getElementById('api-start-date').value = getTodayDateString();
                document.getElementById('api-end-date').value = getTodayDateString();
            } else {
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (error) { console.error("Auth failed:", error); }
            }
        });
        
        function listenToAllCollections() {
            onSnapshot(suppliersCol, snapshot => { allSuppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderSuppliers(); populateSupplierSelects(); });
            onSnapshot(purchaseOrdersCol, snapshot => { allPurchaseOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); allPurchaseOrders.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); renderPurchaseOrders(allPurchaseOrders); updateAndRenderKPIs(); });
            onSnapshot(ingredientsCol, snapshot => { allIngredients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); allIngredients.sort((a,b) => a.name.localeCompare(b.name)); renderIngredients(); updateAndRenderKPIs(); populateIngredientSelects(); renderProducts(); });
            onSnapshot(productsCol, snapshot => { allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); allProducts.sort((a,b) => a.name.localeCompare(b.name)); renderProducts(); populateProductSelects(); updateAndRenderKPIs(); });
            onSnapshot(ordersCol, snapshot => { orderHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); orderHistory.sort((a, b) => (b.saleDate?.seconds || b.createdAt?.seconds || 0) - (a.saleDate?.seconds || a.createdAt?.seconds || 0)); renderOrderHistory(orderHistory); updateAndRenderKPIs(); });
            onSnapshot(lossesCol, snapshot => { allLosses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); allLosses.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); renderLossHistory(); updateAndRenderKPIs(); });
        }
        
        // --- HELPERS ---
        const showToast = (message) => { const toast = document.getElementById('toast'); document.getElementById('toast-message').textContent = message; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 3000); };
        const openModal = (id) => document.getElementById(id).classList.add('flex');
        const closeModal = (id) => document.getElementById(id).classList.remove('flex');
        
        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

		const formatDateToDDMMYYYY = (date) => {
		            if (!date) return 'Date inconnue';
		            const d = date.seconds ? new Date(date.seconds * 1000) : date;
		            if (isNaN(d.getTime())) return 'Date invalide';
		            const day = String(d.getDate()).padStart(2, '0');
		            const month = String(d.getMonth() + 1).padStart(2, '0');
		            const year = d.getFullYear();
					// Ajout de l'heure et des minutes
		            const hours = String(d.getHours()).padStart(2, '0');
		            const minutes = String(d.getMinutes()).padStart(2, '0');
		            return `${day}/${month}/${year} à ${hours}h${minutes}`;
		        };

        const toDate = (timestamp) => {
            if (!timestamp) return null;
            return timestamp.seconds ? new Date(timestamp.seconds * 1000) : timestamp;
        };

        // --- NAVIGATION ---
        document.querySelectorAll('.tab-link').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active')); tab.classList.add('active'); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`${tab.dataset.tab}-content`).classList.add('active'); }); });
        
        // --- RENDERING & KPIs ---
        const updateAndRenderKPIs = (startDate, endDate, label = "Période : Tout le temps") => {
             // Update filter label
            document.getElementById('kpi-filter-label').textContent = label;

             // Filter data based on date range if provided
            const filteredOrders = !startDate ? orderHistory : orderHistory.filter(o => {
                const orderDate = toDate(o.saleDate || o.createdAt);
                return orderDate && orderDate >= startDate && orderDate <= endDate;
            });

            const filteredPurchases = !startDate ? allPurchaseOrders.filter(p => p.status === 'received') : allPurchaseOrders.filter(p => {
                const receivedDate = toDate(p.receivedAt);
                return p.status === 'received' && receivedDate && receivedDate >= startDate && receivedDate <= endDate;
            });
            
            // *** NEW: Filter for unpaid *and* received purchases ***
            // Filter by received date, but check paymentStatus
            const filteredUnpaidPurchases = !startDate 
                ? allPurchaseOrders.filter(p => p.status === 'received' && p.paymentStatus !== 'paid')
                : allPurchaseOrders.filter(p => {
                    // Filter based on *received* date for "Achats" period
                    const receivedDate = toDate(p.receivedAt); 
                    return p.status === 'received' && 
                           p.paymentStatus !== 'paid' &&
                           receivedDate && 
                           receivedDate >= startDate && 
                           receivedDate <= endDate;
                });
            // *** END NEW ***


            const filteredLosses = !startDate ? allLosses : allLosses.filter(l => {
                const lossDate = toDate(l.createdAt);
                return lossDate && lossDate >= startDate && lossDate <= endDate;
            });
            
            // --- KPI Calculations ---
            const totalSales = filteredOrders.reduce((sum, order) => sum + order.totalPrice, 0);
            const totalPurchases = filteredPurchases.reduce((sum, po) => sum + (po.totalCost || 0), 0); // This is total *received* purchases
            // *** NEW: Calculate total unpaid purchases (from the *received* ones in the period) ***
            const totalUnpaidPurchases = filteredUnpaidPurchases.reduce((sum, po) => sum + (po.totalCost || 0), 0);
            // *** END NEW ***
            const totalOrders = filteredOrders.length;
            const totalLossesValue = filteredLosses.reduce((sum, loss) => {
                let lossCost = 0;
                if (loss.type === 'product') {
                    const product = allProducts.find(p => p.id === loss.itemId);
                    if (product) lossCost = calculateProductCost(product) * loss.quantity;
                } else {
                    const ingredient = allIngredients.find(i => i.id === loss.itemId);
                    if (ingredient) lossCost = (ingredient.cost || 0) * loss.quantity;
                }
                return sum + lossCost;
            }, 0);

            // --- Update KPI DOM ---
            document.getElementById('kpi-total-sales').textContent = `${totalSales.toFixed(2)} Mad`;
            document.getElementById('kpi-total-purchases').textContent = `${totalPurchases.toFixed(2)} Mad`;
            document.getElementById('kpi-unpaid-purchases').textContent = `${totalUnpaidPurchases.toFixed(2)} Mad`; // *** NEW ***
            document.getElementById('kpi-total-losses').textContent = `${totalLossesValue.toFixed(2)} Mad`;
            document.getElementById('kpi-total-orders').textContent = totalOrders;

            // --- Low Stock Alerts (unfiltered) ---
            const container = document.getElementById('low-stock-alerts');
            const placeholder = document.getElementById('low-stock-placeholder');
            container.innerHTML = '';
            const lowStockItems = allIngredients.filter(ing => ing.quantity < LOW_STOCK_THRESHOLD);
            if (lowStockItems.length === 0) {
                container.innerHTML = '';
                container.appendChild(placeholder);
            } else {
                lowStockItems.forEach(item => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow';
                    alertDiv.innerHTML = `<p class="font-bold">${item.name}</p><p>Stock restant: ${item.quantity} ${item.unit}</p>`;
                    container.appendChild(alertDiv);
                });
            }
        };

        const renderIngredients = () => { const list = document.getElementById('ingredients-list'); const placeholder = document.getElementById('ingredients-placeholder'); const table = document.getElementById('ingredients-table'); list.innerHTML = ''; if(allIngredients.length === 0) { table.style.display = 'none'; placeholder.style.display = 'block'; } else { table.style.display = ''; placeholder.style.display = 'none'; allIngredients.forEach(ing => { const isLow = ing.quantity < LOW_STOCK_THRESHOLD; const row = document.createElement('tr'); row.className = isLow ? 'low-stock' : ''; const costDisplay = (ing.cost && ing.cost > 0) ? `${ing.cost.toFixed(2)} Mad` : 'N/A'; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${ing.name}</td><td class="px-6 py-4 whitespace-nowrap"><span class="${isLow ? 'low-stock-text' : ''}">${ing.quantity}</span> <span class="text-gray-500">${ing.unit}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${costDisplay}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><button data-id="${ing.id}" class="edit-ingredient-btn text-gray-600 hover:text-gray-900 mr-4">Modifier</button><button data-id="${ing.id}" class="delete-ingredient-btn text-red-600 hover:text-red-900">Supprimer</button></td>`; list.appendChild(row); }); } };
        
        const calculateProductCost = (product) => {
            if (!product) return 0;
            if (product.recipe && product.recipe.length > 0) {
                return product.recipe.reduce((total, recipeItem) => {
                    const ingredient = allIngredients.find(ing => ing.id === recipeItem.id);
                    const ingredientCost = ingredient ? (ingredient.cost || 0) : 0;
                    return total + (ingredientCost * recipeItem.quantity);
                }, 0);
            } else if (product.linkedIngredientId) {
                const linkedIngredient = allIngredients.find(i => i.id === product.linkedIngredientId);
                return linkedIngredient ? (linkedIngredient.cost || 0) : 0;
            }
            return 0;
        };

        const renderProducts = () => { const container = document.getElementById('products-list'); const placeholder = document.getElementById('products-placeholder'); container.innerHTML = ''; if(allProducts.length === 0) { container.innerHTML = ''; container.appendChild(placeholder); } else { allProducts.forEach(product => { const card = document.createElement('div'); card.className = 'bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col justify-between'; const typeIcon = { Entrée: '<i class="fas fa-concierge-bell"></i>', Pizza: '<i class="fas fa-pizza-slice"></i>', Boisson: '<i class="fas fa-wine-bottle"></i>', Dessert: '<i class="fas fa-ice-cream"></i>', Autre: '<i class="fas fa-box"></i>' }; 
        
        let contentHtml = '';
        if (product.recipe && product.recipe.length > 0) {
            let recipeHtml = product.recipe.map(r => {
                const ingredientDetails = allIngredients.find(ing => ing.id === r.id);
                let costHtml = '';
                if (ingredientDetails && ingredientDetails.cost > 0) {
                    const itemCost = r.quantity * ingredientDetails.cost;
                    costHtml = `<span class="font-semibold text-gray-600">${itemCost.toFixed(2)} Mad</span>`;
                }
                return `<li class="flex justify-between items-center">
                            <span>- ${r.quantity} ${r.unit} ${r.name}</span>
                            ${costHtml}
                        </li>`;
            }).join('');

            contentHtml = `<div class="mt-2">
                                <h4 class="font-semibold text-sm text-gray-600">Recette:</h4>
                                <ul class="text-gray-500 text-sm space-y-1 mt-1">${recipeHtml}</ul>
                            </div>`;

        } else if (product.linkedIngredientId) {
            const linkedIngredient = allIngredients.find(i => i.id === product.linkedIngredientId);
            contentHtml = `<div class="mt-2"><h4 class="font-semibold text-sm text-gray-600">Article en stock:</h4><p class="text-gray-500 text-sm">${linkedIngredient ? linkedIngredient.name : 'Non lié'}</p></div>`;
        }
        
        const productCost = calculateProductCost(product); card.innerHTML = `<div class="p-6"><div class="flex justify-between items-start"><div><h3 class="text-xl font-bold text-gray-900">${product.name}</h3><p class="text-gray-500 text-xs">Coût de revient: ${productCost.toFixed(2)} Mad</p></div><span class="text-gray-400 text-xl">${typeIcon[product.type]}</span></div><div class="flex-grow">${contentHtml}</div><p class="text-gray-800 font-bold text-2xl text-right mt-4">${product.price.toFixed(2)} Mad</p></div><div class="bg-gray-50 px-6 py-3 flex justify-end gap-3"><button data-id="${product.id}" class="edit-product-btn text-gray-600 hover:text-gray-900 font-medium">Modifier</button><button data-id="${product.id}" class="delete-product-btn text-red-600 hover:text-red-900 font-medium">Supprimer</button></div>`; container.appendChild(card); }); } };
        const renderOrderHistory = (history) => { const container = document.getElementById('order-history-list'); const placeholder = document.getElementById('order-history-placeholder'); container.innerHTML = ''; if (history.length === 0) { container.innerHTML = ''; container.appendChild(placeholder); } else { history.forEach(order => { const card = document.createElement('div'); card.className = 'bg-white p-4 rounded-xl shadow-md'; const displayDate = formatDateToDDMMYYYY(order.saleDate || order.createdAt); const itemsHtml = order.items.map(item => `<li>${item.quantity} x ${item.name}</li>`).join('');const billNoHtml = order.billNo ? `<p class="text-xs text-gray-500 font-mono">Facture API: ${order.billNo}</p>` : ''; card.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-gray-700">Vente du ${displayDate}</p>${billNoHtml}<ul class="list-disc list-inside text-sm text-gray-600 mt-2">${itemsHtml}</ul></div><div class="flex items-center gap-4 text-right"><p class="font-bold text-lg text-gray-800">${order.totalPrice.toFixed(2)} Mad</p><button data-id="${order.id}" class="delete-order-btn text-gray-400 hover:text-red-600 transition-colors"><i class="fas fa-trash-alt"></i></button></div></div>`; container.appendChild(card)}); } };
        const renderSuppliers = () => { const container = document.getElementById('suppliers-list'); const placeholder = document.getElementById('suppliers-placeholder'); container.innerHTML = ''; if (allSuppliers.length === 0) { container.innerHTML = ''; container.appendChild(placeholder); } else { allSuppliers.forEach(sup => { const div = document.createElement('div'); div.className = "bg-white p-3 rounded-lg shadow-sm flex justify-between items-center"; div.innerHTML = `<div><p class="font-semibold">${sup.name}</p><p class="text-sm text-gray-500">${sup.contact || ''}</p></div><div><button data-id="${sup.id}" class="edit-supplier-btn text-gray-400 hover:text-gray-800 mr-2"><i class="fas fa-edit"></i></button><button data-id="${sup.id}" class="delete-supplier-btn text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div>`; container.appendChild(div); }); } };
        const renderPurchaseOrders = (purchaseOrders) => { 
            const container = document.getElementById('purchase-orders-list'); 
            const placeholder = document.getElementById('purchase-orders-placeholder'); 
            container.innerHTML = ''; 
            if (purchaseOrders.length === 0) { 
                container.innerHTML = ''; 
                container.appendChild(placeholder); 
            } else { 
                purchaseOrders.forEach(po => { 
                    const supplier = allSuppliers.find(s => s.id === po.supplierId); 
                    const div = document.createElement('div'); 
                    const isReceived = po.status === 'received'; 
                    // *** NEW: Check payment status ***
                    const isPaid = po.paymentStatus === 'paid';
                    // *** END NEW ***
                    div.className = `bg-white p-3 rounded-lg shadow-sm`; 
                    // Display price per unit in the list
                    const itemsHtml = po.items.map(i => `<li>${i.quantity} ${i.unit} - ${i.name} (${(i.price || 0).toFixed(2)} Mad/unité)</li>`).join(''); 
                    // Use the saved totalCost, which might be the manually adjusted one
                    const totalDisplay = `<p class="font-bold text-lg text-gray-800">${(po.totalCost || 0).toFixed(2)} Mad</p>`; 
                    
                    // *** NEW: Actions logic updated ***
                    const actionsHtml = `
                    <div class="flex justify-between items-center mt-3 pt-3 border-t">
                        <div>
                            <button data-id="${po.id}" class="reorder-po-btn text-blue-500 hover:text-blue-800 text-sm font-medium mr-3"><i class="fas fa-redo mr-1"></i> Relancer</button>
                            ${!isReceived ? `<button data-id="${po.id}" class="edit-po-btn text-gray-500 hover:text-gray-800 text-sm font-medium mr-3"><i class="fas fa-edit mr-1"></i> Modifier</button>` : ''}
                            ${!isReceived ? `<button data-id="${po.id}" class="delete-po-btn text-red-500 hover:text-red-800 text-sm font-medium"><i class="fas fa-trash mr-1"></i> Supprimer</button>` : ''}
                        </div>
                        <div class="flex gap-2">
                            ${!isPaid ? `<button data-id="${po.id}" class="pay-po-btn btn-secondary bg-green-100 hover:bg-green-200 text-green-800 text-sm py-1 px-3"><i class="fas fa-check mr-1"></i> Marquer Payé</button>` : ''}
                            ${!isReceived ? `<button data-id="${po.id}" class="receive-po-btn btn-primary text-sm py-1 px-3">Réceptionner</button>` : ''}
                        </div>
                    </div>`; 
                    // *** END NEW ***
                    
                    // *** NEW: Payment status tag added ***
                    const paymentTag = `<span class="text-xs font-bold py-1 px-2 rounded-full ${isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${isPaid ? 'Payé' : 'Non Payé'}</span>`;
                    // *** END NEW ***

                    div.innerHTML = `<div class="p-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${supplier ? supplier.name : 'Fournisseur inconnu'}</p>
                                <p class="text-xs text-gray-500">${formatDateToDDMMYYYY(po.createdAt)}</p>
                                <ul class="text-sm mt-2 list-disc list-inside">${itemsHtml}</ul>
                            </div>
                            <div class="text-right">
                                <div class="flex flex-col items-end gap-1">
                                    <span class="text-xs font-bold py-1 px-2 rounded-full ${isReceived ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${isReceived ? 'Reçue' : 'En attente'}</span>
                                    ${paymentTag} <!-- NEW TAG ADDED -->
                                </div>
                                ${isReceived ? `<p class="text-xs text-gray-500 mt-1">Reçue le ${formatDateToDDMMYYYY(po.receivedAt)}</p>` : ''}
                                ${totalDisplay} 
                                ${po.invoiceUrl ? `<a href="${po.invoiceUrl}" target="_blank" class="block text-sm text-gray-600 hover:text-gray-900 mt-2"><i class="fas fa-file-invoice"></i> Facture</a>` : ''}
                            </div>
                        </div>
                    </div>${actionsHtml}`; 
                    container.appendChild(div); 
                }); 
            } 
        };
        const renderLossHistory = () => { const container = document.getElementById('loss-history-list'); const placeholder = document.getElementById('loss-history-placeholder'); container.innerHTML = ''; if (allLosses.length === 0) { container.innerHTML = ''; container.appendChild(placeholder); } else { allLosses.forEach(loss => { const card = document.createElement('div'); card.className = 'bg-yellow-50 p-4 rounded-xl shadow-md border-l-4 border-yellow-400'; const date = loss.createdAt ? new Date(loss.createdAt.seconds * 1000).toLocaleString('fr-FR') : 'Date inconnue'; const reasonHtml = loss.reason ? `<p class="text-sm text-gray-500 italic mt-1">"${loss.reason}"</p>` : ''; card.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-yellow-800">Perte du ${date}</p><p class="text-gray-700 mt-2"><span class="font-semibold">${loss.quantity} ${loss.unit || ''}</span> de <span class="font-semibold">${loss.itemName}</span></p>${reasonHtml}</div><div class="flex items-center gap-4 text-right"><button data-id="${loss.id}" class="delete-loss-btn text-gray-400 hover:text-red-600 transition-colors"><i class="fas fa-trash-alt"></i></button></div></div>`; container.appendChild(card); }); } };
        
        // --- KPI FILTERS ---
        document.getElementById('toggle-kpi-filters-btn').addEventListener('click', () => {
            document.getElementById('kpi-filter-container').classList.toggle('hidden');
        });

        document.querySelectorAll('.kpi-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.kpi-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('kpi-start-date').value = '';
                document.getElementById('kpi-end-date').value = '';

                const filterType = btn.dataset.filter;
                const now = new Date();
                let startDate, endDate = new Date(), label;
                endDate.setHours(23, 59, 59, 999);

                if (filterType === 'today') {
                    startDate = new Date();
                    startDate.setHours(0, 0, 0, 0);
                    label = "Période : Aujourd'hui";
                } else if (filterType === 'week') {
                    startDate = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1))); // Monday
                    startDate.setHours(0, 0, 0, 0);
                    label = "Période : Cette semaine";
                } else if (filterType === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    startDate.setHours(0, 0, 0, 0);
                    label = "Période : Ce mois";
                }
                updateAndRenderKPIs(startDate, endDate, label);
                document.getElementById('kpi-filter-container').classList.add('hidden');
            });
        });

        document.getElementById('kpi-filter-range-btn').addEventListener('click', () => {
             document.querySelectorAll('.kpi-filter-btn').forEach(b => b.classList.remove('active'));
            const startValue = document.getElementById('kpi-start-date').value;
            const endValue = document.getElementById('kpi-end-date').value;
            if (!startValue || !endValue) return showToast("Veuillez sélectionner une date de début et de fin.");

            const startDate = new Date(startValue);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endValue);
            endDate.setHours(23, 59, 59, 999);
            
            const label = `Période : du ${formatDateToDDMMYYYY(startDate)} au ${formatDateToDDMMYYYY(endDate)}`;
            updateAndRenderKPIs(startDate, endDate, label);
            document.getElementById('kpi-filter-container').classList.add('hidden');
        });

        document.getElementById('kpi-reset-filter-btn').addEventListener('click', () => {
            document.querySelectorAll('.kpi-filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('kpi-start-date').value = '';
            document.getElementById('kpi-end-date').value = '';
            updateAndRenderKPIs(); // No args means all time
            document.getElementById('kpi-filter-container').classList.add('hidden');
        });

        // --- INGREDIENTS ---
        document.getElementById('add-ingredient-btn').addEventListener('click', () => { document.getElementById('ingredient-modal-title').textContent = 'Ajouter un ingrédient'; document.getElementById('ingredient-form').reset(); document.getElementById('ingredient-id').value = ''; openModal('ingredient-modal'); }); document.getElementById('cancel-ingredient').addEventListener('click', () => closeModal('ingredient-modal')); document.getElementById('ingredient-form').addEventListener('submit', async (e) => { e.preventDefault(); const id = document.getElementById('ingredient-id').value; const data = { name: document.getElementById('ingredient-name').value, quantity: parseFloat(document.getElementById('ingredient-quantity').value), unit: document.getElementById('ingredient-unit').value, cost: parseFloat(document.getElementById('ingredient-cost').value) || 0 }; try { if (id) await updateDoc(doc(ingredientsCol, id), data); else await addDoc(ingredientsCol, {...data, createdAt: serverTimestamp()}); showToast(id ? 'Ingrédient mis à jour !' : 'Ingrédient ajouté !'); closeModal('ingredient-modal'); } catch(error) { console.error(error); showToast("Erreur lors de l'opération."); } }); document.getElementById('ingredients-list').addEventListener('click', async e => { const target = e.target.closest('[data-id]'); if (!target) return; const id = target.dataset.id; if (target.classList.contains('delete-ingredient-btn')) { if(confirm('Voulez-vous vraiment supprimer cet ingrédient ?')) { await deleteDoc(doc(ingredientsCol, id)); showToast('Ingrédient supprimé.'); } } else if (target.classList.contains('edit-ingredient-btn')) { const docSnap = await getDoc(doc(ingredientsCol, id)); const data = docSnap.data(); document.getElementById('ingredient-modal-title').textContent = 'Modifier un ingrédient'; document.getElementById('ingredient-id').value = docSnap.id; document.getElementById('ingredient-name').value = data.name; document.getElementById('ingredient-quantity').value = data.quantity; document.getElementById('ingredient-unit').value = data.unit; document.getElementById('ingredient-cost').value = data.cost || ''; openModal('ingredient-modal'); } });
        
        // --- PRODUITS ---
        const populateIngredientSelects = () => {  const recipeSelect = document.getElementById('recipe-ingredient-select');  const linkedSelect = document.getElementById('linked-ingredient-select');  const poSelect = document.getElementById('po-ingredient-select'); const lossIngredientSelect = document.getElementById('loss-ingredient-select'); const options = allIngredients.map(ing => `<option value="${ing.id}">${ing.name} (${ing.unit})</option>`).join('');  recipeSelect.innerHTML = `<option value="">Choisir...</option>${options}`;  linkedSelect.innerHTML = `<option value="">Choisir...</option>${options}`; poSelect.innerHTML = `<option value="">Choisir...</option>${options}`; lossIngredientSelect.innerHTML = `<option value="">Choisir...</option>${options}`};
        const populateProductSelects = () => { const orderSelect = document.getElementById('order-product-select'); const lossSelect = document.getElementById('loss-product-select'); const options = allProducts.map(product => `<option value="${product.id}">${product.name}</option>`).join(''); orderSelect.innerHTML = options; lossSelect.innerHTML = options; }
        document.getElementById('add-product-btn').addEventListener('click', () => { 
            document.getElementById('product-modal-title').textContent = 'Créer un Produit'; 
            document.getElementById('product-form').reset(); 
            document.getElementById('product-id').value = ''; 
            document.getElementById('product-type').dispatchEvent(new Event('change')); 
            currentRecipe = []; 
            renderCurrentRecipe(); 
            // *** NEW: Reset linked quantity field on add ***
            document.getElementById('linked-ingredient-quantity').value = 1;
            // *** END NEW ***
            openModal('product-modal'); 
        });
        document.getElementById('cancel-product').addEventListener('click', () => closeModal('product-modal')); 
        
        document.getElementById('product-type').addEventListener('change', (e) => { 
            const productType = e.target.value;
            const hasRecipe = ['Pizza', 'Dessert', 'Entrée'].includes(productType);
            document.getElementById('recipe-section').style.display = hasRecipe ? 'block' : 'none';
            document.getElementById('linked-ingredient-section').style.display = hasRecipe ? 'none' : 'block';
        }); 
        
        document.getElementById('add-recipe-ingredient-btn').addEventListener('click', () => { const select = document.getElementById('recipe-ingredient-select'); const ingredientId = select.value; const quantity = parseFloat(document.getElementById('recipe-quantity').value); if (!ingredientId || isNaN(quantity) || quantity <= 0) return showToast("Veuillez sélectionner un ingrédient et une quantité valide."); const ingredient = allIngredients.find(ing => ing.id === ingredientId); currentRecipe.push({ id: ingredient.id, name: ingredient.name, quantity: quantity, unit: ingredient.unit }); renderCurrentRecipe(); document.getElementById('recipe-quantity').value = ''; select.value = ''; });
        
        const updateRecipeCost = () => {
             const cost = currentRecipe.reduce((total, recipeItem) => {
                const ingredient = allIngredients.find(ing => ing.id === recipeItem.id);
                return total + ((ingredient?.cost || 0) * recipeItem.quantity);
             }, 0);
            document.getElementById('current-recipe-cost').textContent = `${cost.toFixed(2)} Mad`;
        };
        
        const renderCurrentRecipe = () => { const list = document.getElementById('recipe-ingredients-list'); list.innerHTML = ''; currentRecipe.forEach((item, index) => { const li = document.createElement('div'); li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded'; li.innerHTML = `<span>${item.quantity} ${item.unit} de ${item.name}</span><button type="button" data-index="${index}" class="remove-recipe-item text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>`; list.appendChild(li); }); updateRecipeCost(); }; 
        document.getElementById('recipe-ingredients-list').addEventListener('click', e => { const button = e.target.closest('.remove-recipe-item'); if (button) { currentRecipe.splice(button.dataset.index, 1); renderCurrentRecipe(); } }); 
        
        document.getElementById('product-form').addEventListener('submit', async e => { 
            e.preventDefault(); 
            const id = document.getElementById('product-id').value; 
            const type = document.getElementById('product-type').value; 
            const data = { name: document.getElementById('product-name').value, price: parseFloat(document.getElementById('product-price').value), type: type }; 
            
            const hasRecipe = ['Pizza', 'Dessert', 'Entrée'].includes(type);

            if (hasRecipe) {
                if (currentRecipe.length === 0) return showToast("La recette ne peut pas être vide pour ce type de produit.");
                data.recipe = currentRecipe;
                if (data.hasOwnProperty('linkedIngredientId')) {
                    delete data.linkedIngredientId;
                }
                 if (data.hasOwnProperty('linkedIngredientQuantity')) { // Clean up
                    delete data.linkedIngredientQuantity;
                }
            } else {
                const linkedId = document.getElementById('linked-ingredient-select').value;
                // *** NEW: Get linked quantity ***
                const linkedQty = parseFloat(document.getElementById('linked-ingredient-quantity').value);
                // *** END NEW ***

                if (!linkedId) return showToast("Veuillez lier ce produit à un article en stock.");
                // *** NEW: Validate linked quantity ***
                if (isNaN(linkedQty) || linkedQty <= 0) {
                    return showToast("Veuillez entrer une quantité consommée valide (positive).");
                }
                // *** END NEW ***

                data.linkedIngredientId = linkedId;
                data.linkedIngredientQuantity = linkedQty; // *** NEW ***
                if (data.hasOwnProperty('recipe')) {
                    delete data.recipe;
                }
            }

            try { 
                if (id) {
                    await updateDoc(doc(productsCol, id), data);
                } else {
                    await addDoc(productsCol, {...data, createdAt: serverTimestamp()});
                }
                showToast(id ? 'Produit mis à jour !' : 'Produit créé !'); 
                closeModal('product-modal'); 
            } catch(error) { 
                console.error(error); 
                showToast("Erreur lors de l'opération."); 
            } 
        }); 
        
        document.getElementById('products-list').addEventListener('click', async e => { 
            const id = e.target.closest('[data-id]')?.dataset.id; 
            if(!id) return; 
            const target = e.target; 
            if (target.closest('.delete-product-btn')) { 
                if(confirm('Voulez-vous vraiment supprimer ce produit ?')) { 
                    await deleteDoc(doc(productsCol, id)); 
                    showToast('Produit supprimé.'); 
                } 
            } else if (target.closest('.edit-product-btn')) { 
                const product = allProducts.find(p => p.id === id); 
                document.getElementById('product-modal-title').textContent = 'Modifier un Produit'; 
                document.getElementById('product-id').value = id; 
                document.getElementById('product-name').value = product.name; 
                document.getElementById('product-price').value = product.price; 
                document.getElementById('product-type').value = product.type; 
                document.getElementById('product-type').dispatchEvent(new Event('change')); 
                
                if (product.recipe && product.recipe.length > 0) { 
                    currentRecipe = [...product.recipe]; 
                    renderCurrentRecipe(); 
                } else if (product.linkedIngredientId) { 
                    document.getElementById('linked-ingredient-select').value = product.linkedIngredientId; 
                    // *** NEW: Populate linked quantity ***
                    document.getElementById('linked-ingredient-quantity').value = product.linkedIngredientQuantity || 1; // Default to 1 if not set
                    // *** END NEW ***
                } 
                openModal('product-modal'); 
            } 
        });
        
        // --- VENTES ---
        document.getElementById('add-to-order-form').addEventListener('submit', e => { e.preventDefault(); const productId = document.getElementById('order-product-select').value; const quantity = parseInt(document.getElementById('order-product-quantity').value); const product = allProducts.find(p => p.id === productId); if (!product || isNaN(quantity) || quantity <= 0) return; const existingItem = currentOrder.find(item => item.id === productId); if(existingItem) existingItem.quantity += quantity; else currentOrder.push({ id: product.id, name: product.name, quantity: quantity, price: product.price }); renderCurrentOrder(); });
        
        const updateOrderTotal = () => {
            const total = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            // Met à jour le champ input, pas un span
            document.getElementById('current-order-total-input').value = total.toFixed(2); 
        };

        const renderCurrentOrder = () => { const list = document.getElementById('current-order-list'); const placeholder = document.getElementById('order-placeholder'); const processBtn = document.getElementById('process-order-btn'); list.innerHTML = ''; if(currentOrder.length === 0){ list.innerHTML = ''; list.appendChild(placeholder); processBtn.disabled = true; } else { currentOrder.forEach((item, index) => { const li = document.createElement('li'); li.className = 'flex justify-between items-center'; li.innerHTML = `<span>${item.quantity} x ${item.name}</span><button data-index="${index}" class="remove-order-item text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>`; list.appendChild(li); }); processBtn.disabled = false; } updateOrderTotal(); }; document.getElementById('current-order-list').addEventListener('click', e => { const button = e.target.closest('.remove-order-item'); if (button) { currentOrder.splice(button.dataset.index, 1); renderCurrentOrder(); } }); 
        
        document.getElementById('process-order-btn').addEventListener('click', async () => { 
            if (currentOrder.length === 0) return; 
            
            // *** MODIFICATION : Lire le total depuis l'input ***
            const totalPriceInput = document.getElementById('current-order-total-input');
            const totalPrice = parseFloat(totalPriceInput.value);

            if (isNaN(totalPrice) || totalPrice < 0) {
                showToast("Le montant total de la vente est invalide.");
                return;
            }
            // *** FIN MODIFICATION ***
            
            const batch = writeBatch(db); 
            // let totalPrice = 0; // N'est plus calculé ici, lu depuis l'input
            const tempDeductions = new Map(); 

            for (const orderItem of currentOrder) { 
                const product = allProducts.find(p => p.id === orderItem.id); 
                if (!product) { 
                    showToast(`Produit non trouvé : ${orderItem.name}`);
                    return;
                } 
                // totalPrice += product.price * orderItem.quantity; // Déjà fait / lu depuis l'input
                
                if (product.recipe && product.recipe.length > 0) { 
                    for (const recipeItem of product.recipe) { 
                        const current = tempDeductions.get(recipeItem.id) || 0; 
                        tempDeductions.set(recipeItem.id, current + recipeItem.quantity * orderItem.quantity); 
                    } 
                } else if (product.linkedIngredientId) { 
                    // *** MODIFIED: Use linkedIngredientQuantity ***
                    const linkedQtyPerProduct = product.linkedIngredientQuantity || 1; // Default to 1
                    const totalQtyToDeduct = linkedQtyPerProduct * orderItem.quantity;
                    const current = tempDeductions.get(product.linkedIngredientId) || 0; 
                    tempDeductions.set(product.linkedIngredientId, current + totalQtyToDeduct); 
                    // *** END MODIFICATION ***
                } 
            } 
            
            for (const [ingId, qty] of tempDeductions.entries()) { 
                const ing = allIngredients.find(i => i.id === ingId); 
                if (!ing || ing.quantity < qty) { 
                    showToast(`Stock insuffisant pour: ${ing ? ing.name : 'inconnu'}`); 
                    return; 
                } 
                batch.update(doc(ingredientsCol, ingId), { quantity: increment(-qty) }); 
            } 
            
            const saleDateInput = document.getElementById('sale-date').value;
            const saleDate = saleDateInput ? new Date(saleDateInput) : new Date();
            saleDate.setHours(12, 0, 0, 0); // Normalize to midday to avoid timezone issues

            batch.set(doc(ordersCol), { 
                items: currentOrder, 
                totalPrice: totalPrice, // Utilise le total de l'input
                createdAt: serverTimestamp(),
                saleDate: saleDate 
            }); 
            
            try { 
                await batch.commit(); 
                showToast('Vente validée, stock mis à jour !'); 
                currentOrder = []; 
                renderCurrentOrder(); 
                totalPriceInput.value = '0.00'; // Réinitialiser le champ total
            } catch (error) { 
                console.error("Batch commit failed: ", error); 
                showToast(`Erreur: ${error.message}`); 
            } 
        }); 
        
        document.getElementById('order-history-list').addEventListener('click', async e => { 
            const deleteBtn = e.target.closest('.delete-order-btn'); 
            if (deleteBtn) { 
                const orderId = deleteBtn.dataset.id; 
                const order = orderHistory.find(o => o.id === orderId); 
                if (!order) return; 
                if (confirm("Voulez-vous vraiment supprimer cette vente ?\n\nLe stock utilisé sera automatiquement restauré.")) { 
                    const batch = writeBatch(db); 
                    for (const item of order.items) { 
                        const prod = allProducts.find(p => p.id === item.id); 
                        if (!prod) continue; 
                        
                        if (prod.recipe && prod.recipe.length > 0) { 
                            for (const recipeItem of prod.recipe) { 
                                batch.update(doc(ingredientsCol, recipeItem.id), { quantity: increment(recipeItem.quantity * item.quantity) }); 
                            } 
                        } else if (prod.linkedIngredientId) { 
                            // *** MODIFIED: Use linkedIngredientQuantity ***
                            const linkedQtyPerProduct = prod.linkedIngredientQuantity || 1;
                            const totalQtyToRestore = linkedQtyPerProduct * item.quantity;
                            batch.update(doc(ingredientsCol, prod.linkedIngredientId), { quantity: increment(totalQtyToRestore) }); 
                            // *** END MODIFICATION ***
                        } 
                    } 
                    batch.delete(doc(ordersCol, orderId)); 
                    try { 
                        await batch.commit(); 
                        showToast("Vente supprimée et stock restauré."); 
                    } catch (error) { 
                        console.error("Error restoring stock:", error); 
                        showToast("Erreur lors de la suppression."); 
                    } 
                } 
            } 
        });

        const handleDateFilter = () => {
            const filterValue = document.getElementById('history-date-filter').value;
            if (!filterValue) {
                renderOrderHistory(orderHistory);
                return;
            }

            const filterDate = new Date(filterValue);
            filterDate.setUTCHours(0, 0, 0, 0);
            const filterTime = filterDate.getTime();

            const filtered = orderHistory.filter(order => {
                const orderDateSource = order.saleDate || order.createdAt;
                if (!orderDateSource) return false;

                const orderDate = orderDateSource.seconds ? new Date(orderDateSource.seconds * 1000) : orderDateSource;
                orderDate.setUTCHours(0, 0, 0, 0);
                
                return orderDate.getTime() === filterTime;
            });
            renderOrderHistory(filtered);
        };

        document.getElementById('history-date-filter').addEventListener('input', handleDateFilter);

        
        // --- PERTES ---
        document.getElementById('declare-loss-btn').addEventListener('click', () => { document.getElementById('loss-form').reset(); populateProductSelects(); populateIngredientSelects(); document.querySelector('input[name="loss-type"][value="product"]').checked = true; document.getElementById('loss-product-section').classList.remove('hidden'); document.getElementById('loss-ingredient-section').classList.add('hidden'); document.getElementById('loss-product-select').required = true; document.getElementById('loss-ingredient-select').required = false; openModal('loss-modal'); });
        document.getElementById('cancel-loss').addEventListener('click', () => closeModal('loss-modal'));
        document.querySelectorAll('input[name="loss-type"]').forEach(radio => { radio.addEventListener('change', (e) => { const isProduct = e.target.value === 'product'; document.getElementById('loss-product-section').classList.toggle('hidden', !isProduct); document.getElementById('loss-ingredient-section').classList.toggle('hidden', isProduct); document.getElementById('loss-product-select').required = isProduct; document.getElementById('loss-ingredient-select').required = !isProduct; }); });
        
        document.getElementById('loss-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const type = document.querySelector('input[name="loss-type"]:checked').value; 
            const quantity = parseFloat(document.getElementById('loss-quantity').value); 
            const reason = document.getElementById('loss-reason').value; 
            if (isNaN(quantity) || quantity <= 0) { return showToast("La quantité doit être un nombre positif."); } 
            
            const batch = writeBatch(db); 
            let lossData = { reason, createdAt: serverTimestamp(), quantity }; 
            let success = true; 

            if (type === 'product') { 
                const productId = document.getElementById('loss-product-select').value; 
                const product = allProducts.find(p => p.id === productId); 
                if (!product) return showToast("Produit non trouvé."); 

                lossData.itemId = productId; 
                lossData.itemName = product.name; 
                lossData.type = 'product'; 
                
                const tempDeductions = new Map(); 
                if (product.recipe && product.recipe.length > 0) { 
                    for (const recipeItem of product.recipe) { 
                        const current = tempDeductions.get(recipeItem.id) || 0; 
                        tempDeductions.set(recipeItem.id, current + recipeItem.quantity * quantity); 
                    } 
                } else if (product.linkedIngredientId) { 
                    // *** MODIFIED: Use linkedIngredientQuantity ***
                    const linkedQtyPerProduct = product.linkedIngredientQuantity || 1;
                    const totalQtyToDeduct = linkedQtyPerProduct * quantity;
                    const current = tempDeductions.get(product.linkedIngredientId) || 0; 
                    tempDeductions.set(product.linkedIngredientId, current + totalQtyToDeduct); 
                    // *** END MODIFICATION ***
                } 

                for (const [ingId, qtyToDeduct] of tempDeductions.entries()) { 
                    const ing = allIngredients.find(i => i.id === ingId); 
                    if (!ing || ing.quantity < qtyToDeduct) { 
                        showToast(`Stock insuffisant pour: ${ing ? ing.name : 'inconnu'}`); 
                        success = false; 
                        break; 
                    } 
                    batch.update(doc(ingredientsCol, ingId), { quantity: increment(-qtyToDeduct) }); 
                } 
            } else { 
                const ingredientId = document.getElementById('loss-ingredient-select').value; 
                const ingredient = allIngredients.find(i => i.id === ingredientId); 
                if (!ingredient) return showToast("Ingrédient non trouvé."); 
                
                if (ingredient.quantity < quantity) { 
                    showToast(`Stock insuffisant pour: ${ingredient.name}`); 
                    success = false; 
                } else { 
                    lossData.itemId = ingredientId; 
                    lossData.itemName = ingredient.name; 
                    lossData.unit = ingredient.unit; 
                    lossData.type = 'ingredient'; 
                    batch.update(doc(ingredientsCol, ingredientId), { quantity: increment(-quantity) }); 
                } 
            } 

            if (success) { 
                batch.set(doc(lossesCol), lossData); 
                try { 
                    await batch.commit(); 
                    showToast('Perte enregistrée et stock mis à jour !'); 
                    closeModal('loss-modal'); 
                } catch (error) { 
                    console.error("Loss commit failed: ", error); 
                    showToast(`Erreur: ${error.message}`); 
                } 
            } 
        });
        
        document.getElementById('loss-history-list').addEventListener('click', async e => { 
            const deleteBtn = e.target.closest('.delete-loss-btn'); 
            if (deleteBtn) { 
                const lossId = deleteBtn.dataset.id; 
                const loss = allLosses.find(l => l.id === lossId); 
                if (!loss) return; 
                
                if (confirm("Voulez-vous vraiment annuler cette perte ?\n\nLe stock sera restauré.")) { 
                    const batch = writeBatch(db); 
                    if (loss.type === 'product') { 
                        const product = allProducts.find(p => p.id === loss.itemId); 
                        if (product) { 
                            if (product.recipe && product.recipe.length > 0) { 
                                for (const recipeItem of product.recipe) { 
                                    batch.update(doc(ingredientsCol, recipeItem.id), { quantity: increment(recipeItem.quantity * loss.quantity) }); 
                                } 
                            } else if (product.linkedIngredientId) { 
                                // *** MODIFIED: Use linkedIngredientQuantity ***
                                const linkedQtyPerProduct = product.linkedIngredientQuantity || 1;
                                const totalQtyToRestore = linkedQtyPerProduct * loss.quantity;
                                batch.update(doc(ingredientsCol, product.linkedIngredientId), { quantity: increment(totalQtyToRestore) }); 
                                // *** END MODIFICATION ***
                            } 
                        } 
                    } else { 
                        batch.update(doc(ingredientsCol, loss.itemId), { quantity: increment(loss.quantity) }); 
                    } 
                    batch.delete(doc(lossesCol, lossId)); 
                    
                    try { 
                        await batch.commit(); 
                        showToast("Perte annulée et stock restauré."); 
                    } catch (error) { 
                        console.error("Error restoring stock from loss:", error); 
                        showToast("Erreur lors de l'annulation de la perte."); 
                    } 
                } 
            } 
        });

        // --- FOURNISSEURS & ACHATS ---
        document.getElementById('add-supplier-btn').addEventListener('click', () => { document.getElementById('supplier-modal-title').textContent = 'Ajouter un Fournisseur'; document.getElementById('supplier-form').reset(); document.getElementById('supplier-id').value = ''; openModal('supplier-modal'); }); document.getElementById('cancel-supplier').addEventListener('click', () => closeModal('supplier-modal')); document.getElementById('supplier-form').addEventListener('submit', async e => { e.preventDefault(); const id = document.getElementById('supplier-id').value; const data = { name: document.getElementById('supplier-name').value, contact: document.getElementById('supplier-contact').value }; try { if (id) await updateDoc(doc(suppliersCol, id), data); else await addDoc(suppliersCol, data); showToast(id ? 'Fournisseur mis à jour' : 'Fournisseur ajouté'); closeModal('supplier-modal'); } catch(error) { showToast('Erreur'); } }); document.getElementById('suppliers-list').addEventListener('click', async e => { const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id; if (target.classList.contains('delete-supplier-btn')) { if (confirm('Supprimer ce fournisseur ?')) await deleteDoc(doc(suppliersCol, id)); } else if (target.classList.contains('edit-supplier-btn')) { const sup = allSuppliers.find(s => s.id === id); document.getElementById('supplier-id').value = id; document.getElementById('supplier-name').value = sup.name; document.getElementById('supplier-contact').value = sup.contact; openModal('supplier-modal'); } });
        const populateSupplierSelects = () => { const select = document.getElementById('po-supplier-select'); select.innerHTML = '<option value="">Choisir...</option>'; allSuppliers.forEach(s => select.innerHTML += `<option value="${s.id}">${s.name}</option>`); }; 
        
        document.getElementById('add-purchase-order-btn').addEventListener('click', () => { 
            document.getElementById('purchase-order-form').reset(); 
            document.getElementById('po-id').value = ''; 
            document.getElementById('po-modal-title').textContent = 'Nouvelle Commande Fournisseur'; 
            // *** NEW: Reset payment status radio to default ***
            document.querySelector('input[name="po-payment-status"][value="unpaid"]').checked = true;
            // *** END NEW ***
            currentPurchaseOrderItems = []; 
            renderCurrentPurchaseOrderItems(); 
            openModal('purchase-order-modal'); 
        }); 
        document.getElementById('cancel-purchase-order').addEventListener('click', () => closeModal('purchase-order-modal'));
        
        const updatePurchaseOrderTotal = () => {
            // Recalculate total based on currentPurchaseOrderItems prices (price per unit * quantity)
            const total = currentPurchaseOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
             document.getElementById('po-total-cost-input').value = total.toFixed(2); // Met à jour l'input
        };
        
        // --- MODIFICATION: renderCurrentPurchaseOrderItems (Pour inclure les inputs) ---
        const renderCurrentPurchaseOrderItems = () => { 
            const list = document.getElementById('po-items-list'); 
            list.innerHTML = ''; // Vider la liste
            
            // Ajouter un en-tête si des articles sont présents
            if (currentPurchaseOrderItems.length > 0) {
                 list.innerHTML = `
                    <div class="flex justify-between items-center text-sm font-medium text-gray-500 mb-1 px-2">
                        <div class="flex-grow grid grid-cols-4 gap-2 items-center">
                            <span class="col-span-2">Article</span>
                            <span class="text-right">Quantité</span>
                            <span class="text-right">Prix/Unité</span>
                        </div>
                        <span class="ml-2 w-6"></span> <!-- Espace pour le bouton supprimer -->
                    </div>
                `;
            }

            currentPurchaseOrderItems.forEach((item, index) => { 
                const li = document.createElement('div'); 
                li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded'; 
                
                li.innerHTML = `
                    <div class="flex-grow grid grid-cols-4 gap-2 items-center">
                        <span class="col-span-2 text-sm">${item.name} (${item.unit})</span>
                        
                        <label class="sr-only" for="po-item-qty-${index}">Quantité ${item.name}</label>
                        <input type="number" step="any" min="0" value="${item.quantity}" data-index="${index}" data-field="quantity"
                               id="po-item-qty-${index}"
                               class="po-item-input w-full p-1 border border-gray-300 rounded-lg shadow-sm text-right">
                        
                        <label class="sr-only" for="po-item-price-${index}">Prix ${item.name}</label>
                        <input type="number" step="any" min="0" value="${(item.price || 0).toFixed(2)}" data-index="${index}" data-field="price"
                               id="po-item-price-${index}"
                               class="po-item-input w-full p-1 border border-gray-300 rounded-lg shadow-sm text-right">
                    </div>
                    <button type="button" data-index="${index}" class="remove-po-item-btn text-red-500 hover:text-red-700 ml-2 w-6 flex-shrink-0">
                        <i class="fas fa-times-circle"></i>
                    </button>
                `;
                
                list.appendChild(li); 
            }); 
            updatePurchaseOrderTotal(); 
        };
        // --- FIN MODIFICATION ---
        
        document.getElementById('add-po-item-btn').addEventListener('click', () => { 
            const select = document.getElementById('po-ingredient-select'); 
            const ingredientId = select.value; 
            const quantityInput = document.getElementById('po-quantity');
            const priceInput = document.getElementById('po-price'); // Input for price per unit
            const quantity = parseFloat(quantityInput.value); 
            const pricePerUnit = parseFloat(priceInput.value); 
            
            if (!ingredientId || isNaN(quantity) || quantity <= 0 || isNaN(pricePerUnit) || pricePerUnit < 0) {
                 return showToast('Veuillez sélectionner un ingrédient et entrer une quantité et un prix par unité valides.'); 
            }
            const ingredient = allIngredients.find(i => i.id === ingredientId); 
            
            currentPurchaseOrderItems.push({
                id: ingredient.id, 
                name: ingredient.name, 
                unit: ingredient.unit, 
                quantity, 
                price: pricePerUnit // Store price per unit correctly
            }); 
            
            renderCurrentPurchaseOrderItems(); 
            select.value = ''; 
            quantityInput.value = ''; 
            priceInput.value = ''; 
        }); 
        
        // --- MODIFICATION: Listener pour les changements d'input dans la liste PO ---
        document.getElementById('po-items-list').addEventListener('change', e => {
            const input = e.target;
            // Vérifier si c'est un de nos nouveaux inputs
            if (input.classList.contains('po-item-input')) {
                const index = parseInt(input.dataset.index, 10);
                const field = input.dataset.field; // 'quantity' ou 'price'
                const value = parseFloat(input.value);

                if (index >= 0 && index < currentPurchaseOrderItems.length && field && !isNaN(value)) {
                    // Mettre à jour le tableau
                    currentPurchaseOrderItems[index][field] = value;
                    
                    // Mettre à jour le total
                    updatePurchaseOrderTotal();
                }
            }
        });
        // --- FIN MODIFICATION ---
        
        document.getElementById('po-items-list').addEventListener('click', e => { const button = e.target.closest('.remove-po-item-btn'); if (button) { currentPurchaseOrderItems.splice(button.dataset.index, 1); renderCurrentPurchaseOrderItems(); } }); 
        
        // --- Corrected Purchase Order Form Submission ---
        document.getElementById('purchase-order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Form submitted"); // Debug log 1
            const poId = document.getElementById('po-id').value;
            const supplierId = document.getElementById('po-supplier-select').value;
            const fileInput = document.getElementById('po-invoice-file');
            const file = fileInput.files[0];
            console.log("File selected:", file ? file.name : "None"); // Debug log 2

            if (!supplierId || currentPurchaseOrderItems.length === 0) {
                showToast('Fournisseur et articles requis.');
                return;
            }

            // *** MODIFICATION : Lire le total depuis l'input ***
            const totalCost = parseFloat(document.getElementById('po-total-cost-input').value);
            if (isNaN(totalCost) || totalCost < 0) {
                 showToast("Le total de la commande est invalide.");
                 return;
            }
            // *** FIN MODIFICATION ***
            
            // *** NEW: Get payment status ***
            const paymentStatus = document.querySelector('input[name="po-payment-status"]:checked').value;
            // *** END NEW ***


            let invoiceUrl = '';
            const existingPo = poId ? allPurchaseOrders.find(po => po.id === poId) : null;

            // Preserve existing URL if editing and no new file is selected
            if (existingPo && existingPo.invoiceUrl && !file) {
                invoiceUrl = existingPo.invoiceUrl;
                console.log("Preserving existing invoice URL:", invoiceUrl); // Debug log 3a
            }

            // Function to handle the database save operation
            const saveOrderData = async (url) => {
                try {
                    // totalCost est maintenant lu depuis l'input, plus besoin de le recalculer
                    const data = {
                        supplierId,
                        items: currentPurchaseOrderItems,
                        totalCost: totalCost, // Utilise le total de l'input
                        invoiceUrl: url,
                        paymentStatus: paymentStatus // *** NEW: Add to data ***
                    };
                    console.log("Data to save:", data); // Debug log 5

                    if (poId) {
                        console.log("Updating existing PO:", poId); // Debug log 6a
                         // Preserve existing statuses/dates not managed by the form
                        if (existingPo) {
                            data.status = existingPo.status || 'pending';
                            data.createdAt = existingPo.createdAt || serverTimestamp(); // Keep original creation date
                            if (existingPo.receivedAt) {
                                data.receivedAt = existingPo.receivedAt; 
                            }
                            if (paymentStatus === 'paid' && !existingPo.paidAt) {
                                data.paidAt = serverTimestamp(); // Add paidAt timestamp only if changing to paid
                            } else if (existingPo.paidAt) {
                                data.paidAt = existingPo.paidAt; // Preserve existing paidAt
                            }
                        }
                        await updateDoc(doc(purchaseOrdersCol, poId), data);
                        showToast('Commande fournisseur mise à jour');
                    } else {
                        console.log("Adding new PO"); // Debug log 6b
                        data.status = 'pending';
                        data.createdAt = serverTimestamp();
                        if (paymentStatus === 'paid') {
                             data.paidAt = serverTimestamp(); // Add paidAt timestamp if created as paid
                        }
                        await addDoc(purchaseOrdersCol, data);
                        showToast('Commande fournisseur créée');
                    }
                    console.log("Database operation successful"); // Debug log 7
                    closeModal('purchase-order-modal');
                } catch (dbError) {
                    console.error("Error saving purchase order to DB:", dbError); // Log DB error specifically
                    showToast(`Erreur lors de l'enregistrement en base de données: ${dbError.message}`);
                } finally {
                     console.log("Resetting file input in finally block"); // Debug log 8
                    fileInput.value = ''; // Reset file input in finally block
                }
            };

            // Process file upload first if a file exists
            if (file) {
                try {
                    console.log("Attempting to upload file..."); // Debug log 3b
                    const storageRef = ref(storage, `invoices/${appId}/${Date.now()}-${file.name}`);
                    const uploadTask = await uploadBytes(storageRef, file);
                    console.log("Upload task snapshot:", uploadTask); // More detailed log
                    invoiceUrl = await getDownloadURL(uploadTask.ref); // Correct way to get URL after uploadBytes
                    console.log("File uploaded successfully, URL:", invoiceUrl); // Debug log 4
                    await saveOrderData(invoiceUrl); // Save data AFTER getting URL
                } catch (uploadError) {
                    console.error("Error uploading file:", uploadError); // Log upload error specifically
                    showToast(`Erreur lors de l'envoi de la facture: ${uploadError.message}`);
                     console.log("Resetting file input after upload error"); // Debug log 9
                    fileInput.value = ''; // Reset file input on upload error
                }
            } else {
                // No file to upload, proceed directly to saving data with potentially existing URL
                 console.log("No file to upload, saving data directly."); // Debug log 10
                await saveOrderData(invoiceUrl);
            }
        });
        
        document.getElementById('purchase-orders-list').addEventListener('click', async e => { 
            const target = e.target.closest('button[data-id]'); 
            if (!target) return; 
            const poId = target.dataset.id; 
            
            if (target.classList.contains('receive-po-btn')) { 
                const poDoc = await getDoc(doc(purchaseOrdersCol, poId)); 
                const purchaseOrder = poDoc.data(); 
                const batch = writeBatch(db); 
                purchaseOrder.items.forEach(item => { 
                    const ingRef = doc(ingredientsCol, item.id); 
                    // Make sure quantity and price are numbers before incrementing
                    const quantityToAdd = Number(item.quantity) || 0; 
                    if (quantityToAdd > 0) {
                        batch.update(ingRef, { quantity: increment(quantityToAdd) }); 
                    } else {
                        console.warn(`Invalid quantity found for item ${item.name} in PO ${poId}. Skipping stock update for this item.`);
                    }
                }); 
                batch.update(doc(purchaseOrdersCol, poId), { status: 'received', receivedAt: serverTimestamp() }); 
                await batch.commit(); 
                showToast('Stock mis à jour !'); 
            } else if (target.classList.contains('delete-po-btn')) { 
                 const poToDelete = allPurchaseOrders.find(po => po.id === poId);
                if (confirm('Voulez-vous vraiment supprimer cette commande fournisseur ? Cette action est irréversible.')) { 
                    try { 
                        // Delete associated invoice from storage if it exists
                         if (poToDelete && poToDelete.invoiceUrl) {
                             try {
                                 const fileRef = ref(storage, poToDelete.invoiceUrl);
                                 await deleteObject(fileRef);
                                 console.log("Associated invoice deleted from storage.");
                             } catch (storageError) {
                                 // Log error but continue deleting the DB record
                                 console.error("Error deleting invoice from storage:", storageError);
                                 showToast("Erreur lors de la suppression de la facture associée, mais la commande sera supprimée.");
                             }
                         }
                        await deleteDoc(doc(purchaseOrdersCol, poId)); 
                        showToast('Commande fournisseur supprimée.'); 
                    } catch (error) { 
                        console.error("Error deleting purchase order:", error); 
                        showToast('Erreur lors de la suppression.'); 
                    } 
                } 
            } else if (target.classList.contains('edit-po-btn')) { 
                const purchaseOrder = allPurchaseOrders.find(po => po.id === poId); 
                if (!purchaseOrder) return; 
                document.getElementById('po-modal-title').textContent = 'Modifier la Commande Fournisseur'; 
                document.getElementById('po-id').value = poId; 
                document.getElementById('po-supplier-select').value = purchaseOrder.supplierId; 
                
                // *** NEW: Set payment status radio ***
                const paymentStatusValue = purchaseOrder.paymentStatus || 'unpaid'; // Default to unpaid if not set
                document.querySelector(`input[name="po-payment-status"][value="${paymentStatusValue}"]`).checked = true;
                // *** END NEW ***

                // Ensure items have price (backward compatibility or just robustness)
                 currentPurchaseOrderItems = purchaseOrder.items.map(item => ({
                     ...item,
                     price: Number(item.price) || 0 // Ensure price is a number, default to 0 if missing/invalid
                 }));
                renderCurrentPurchaseOrderItems(); // Calcule et affiche le total basé sur les items
                
                // *** MODIFICATION : Remplir l'input avec le total SAUVEGARDÉ (qui peut être manuel) ***
                const calculatedTotal = currentPurchaseOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                document.getElementById('po-total-cost-input').value = (purchaseOrder.totalCost || calculatedTotal).toFixed(2);
                // *** FIN MODIFICATION ***

                document.getElementById('po-invoice-file').value = ''; 
                openModal('purchase-order-modal'); 
            } else if (target.classList.contains('reorder-po-btn')) {
                 const poToReorder = allPurchaseOrders.find(po => po.id === poId);
                 if (!poToReorder) return;
                 document.getElementById('purchase-order-form').reset();
                 document.getElementById('po-id').value = ''; // Clear ID for new order
                 document.getElementById('po-modal-title').textContent = 'Nouvelle Commande Fournisseur (Relance)';
                 document.getElementById('po-supplier-select').value = poToReorder.supplierId;
                 
                 // *** NEW: Reset payment status on reorder ***
                 document.querySelector('input[name="po-payment-status"][value="unpaid"]').checked = true;
                 // *** END NEW ***
                 
                 // Ensure items have price when reordering
                 currentPurchaseOrderItems = poToReorder.items.map(item => ({
                     ...item,
                    price: Number(item.price) || 0 // Ensure price is a number
                 })); 
                 renderCurrentPurchaseOrderItems(); // Calcule et affiche le total auto
                 document.getElementById('po-invoice-file').value = ''; // Clear potential old invoice
                 openModal('purchase-order-modal');
            } else if (target.classList.contains('pay-po-btn')) {
                // *** NEW: Logic to mark as paid ***
                if (confirm("Voulez-vous marquer cette commande comme 'Payé' ?")) {
                    try {
                        await updateDoc(doc(purchaseOrdersCol, poId), { 
                            paymentStatus: 'paid',
                            paidAt: serverTimestamp() // Optional: add a paid timestamp
                        });
                        showToast('Commande marquée comme payée !');
                    } catch (error) {
                        console.error("Erreur lors de la mise à jour du paiement:", error);
                        showToast('Erreur lors de la mise à jour.');
                    }
                }
                // *** END NEW ***
            }
        });
        
       // --- IMPORT API SALES (Using Proxy for Auth) ---
        document.getElementById('import-api-sales-btn').addEventListener('click', () => {
             // Reset form fields to default (today's date)
            document.getElementById('api-start-date').value = getTodayDateString();
            document.getElementById('api-end-date').value = getTodayDateString();
            openModal('api-import-modal');
        });
        document.getElementById('cancel-api-import').addEventListener('click', () => closeModal('api-import-modal'));

        document.getElementById('api-import-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const startDate = document.getElementById('api-start-date').value;
            const endDate = document.getElementById('api-end-date').value;
            const loader = document.getElementById('api-import-loader');
            const statusText = document.getElementById('api-import-status');
            const submitButton = document.getElementById('process-api-import-btn');

            if (!startDate || !endDate) {
                showToast("Veuillez sélectionner les dates de début et de fin.");
                return;
            }
             if (!PROXY_URL || PROXY_URL === "https://votre-proxy-url-ici.onrender.com") {
                 showToast("Erreur: L'URL du PROXY_URL n'est pas configurée dans le script.");
                 return;
            }


            loader.classList.remove('hidden');
            statusText.textContent = 'Authentification en cours...';
            submitButton.disabled = true;
            let salesImportedCount = 0; 
            let salesSkippedCount = 0; 
            let allSalesData = []; 

            try {
                // --- Step 1: Authenticate via Proxy ---
                console.log("Attempting API authentication via proxy...");
                const authResponse = await fetch(`${PROXY_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                    // Le corps (username/password) est géré par le proxy
                });

                 const authData = await authResponse.json(); // Toujours essayer de parser JSON

                if (!authResponse.ok) {
                    console.error("Proxy Auth failed response:", authData);
                     // Essayer d'afficher un message plus clair si possible
                    const detailMsg = authData?.details?.message || authData?.details || authData?.message || `Status ${authResponse.status}`;
                    throw new Error(`Échec d'authentification via proxy: ${detailMsg}`);
                }

                const token = authData?.token; 
                
                if (!token) {
                    console.error("Proxy Auth response data (token not found):", authData);
                    throw new Error("Jeton non reçu du proxy.");
                }
                console.log("Proxy Authentication successful.");
                statusText.textContent = 'Récupération des ventes...';


                // --- Step 2: Fetch Sales Data via Proxy (using obtained token) ---
                console.log(`Fetching sales from ${startDate} to ${endDate} via proxy...`);

                // Fetch potentially multiple pages
                let currentPage = 1;
                const pageSize = 100; 
                let hasMorePages = true;

                while(hasMorePages) {
                     // Construire l'URL pour appeler NOTRE proxy
                    const proxySalesUrl = `${PROXY_URL}/api/sales?pageNum=${currentPage}&pageSize=${pageSize}&startDate=${startDate}&endDate=${endDate}&token=${encodeURIComponent(token)}`;

                    console.log(`Fetching page ${currentPage} from Proxy: ${proxySalesUrl}`);

                    const salesResponse = await fetch(proxySalesUrl, {
                        method: 'GET'
                        // Les en-têtes (Authorization) sont gérés par le proxy
                    });
                    
                    const salesResult = await salesResponse.json(); // Toujours essayer de parser

                    if (!salesResponse.ok) {
                         console.error(`Proxy Sales API Error Response (Page ${currentPage}):`, salesResult);
                         const detailMsg = salesResult?.details?.message || salesResult?.details || salesResult?.message || `Status ${salesResponse.status}`;
                        throw new Error(`Erreur Proxy Ventes (Page ${currentPage}): ${detailMsg}`);
                    }


                     console.log(`Page ${currentPage} response code: ${salesResult.code}, msg: ${salesResult.msg}`);

                    if (salesResult.code !== 200 || !salesResult.data) {
                         console.error("Proxy Sales API invalid data structure:", salesResult);
                        throw new Error(`Erreur Proxy Ventes (Page ${currentPage}): ${salesResult.msg || 'Données invalides ou code non 200 renvoyé par le proxy'}`);
                    }
                    
                    allSalesData = allSalesData.concat(salesResult.data);

                    // Check if there might be more pages 
                    if (!salesResult.data || salesResult.data.length < pageSize) { 
                        hasMorePages = false;
                    } else {
                        currentPage++;
                    }
                     // Safety break
                     if (currentPage > 50) { 
                         console.warn("Stopped fetching after 50 pages.");
                         hasMorePages = false; 
                     }
                }

                 console.log(`Total sales items fetched via proxy: ${allSalesData.length}`);
                 statusText.textContent = `Traitement de ${allSalesData.length} articles...`;

                if (allSalesData.length === 0) {
                     showToast("Aucune vente trouvée pour la période sélectionnée via API.");
                     closeModal('api-import-modal');
                     return; 
                 }


                // --- Step 3: Process and Save Sales Data ---
                const groupedSales = allSalesData.reduce((acc, item) => {
                    // ... (logique de regroupement et de matching produit - INCHANGÉE) ...
                     const billNo = item.billNo;
                     if (!acc[billNo]) {
                         acc[billNo] = {
// ... (code précédent)
                             billNo: billNo,
                             items: [],
                             totalPrice: 0,
                             saleDate: null // On initialise à null
                         };

                         // On essaie de parser la date de l'API (qui contient l'heure)
                         if (item.operDate) {
                             const tempDate = new Date(item.operDate.replace(' ', 'T') + 'Z');
                             // Si la date est valide, on l'utilise (avec l'heure)
                             if (!isNaN(tempDate.getTime())) {
                                 acc[billNo].saleDate = tempDate;
                             } else {
                                 console.warn(`Invalid operDate '${item.operDate}' for bill ${billNo}. Using current date and time.`);
                             }
                         }
                         // Si la date API est absente ou invalide, on prend la date et l'heure actuelles
                         if (!acc[billNo].saleDate) {
                             acc[billNo].saleDate = new Date();
                         }
// ... (suite du code)
                     }
                      const productNameLower = (item.goodsName || '').trim().toLowerCase(); 
                      const matchedProduct = allProducts.find(p => p.name.trim().toLowerCase() === productNameLower);

                      if (matchedProduct) {
                         const quantity = parseFloat(item.numNum);
                         const price = parseFloat(item.numPrice); 
								 // V V V AJOUTEZ CES LIGNES V V V
		// V V V NOUVELLE LOGIQUE CORRIGÉE V V V
						const priceAdd = parseFloat(item.numPriceAdd) || 0;
						
						let discountPercent = parseFloat(item.discount);
						
						// Si 'discount' n'est pas un nombre (ex: undefined, null, ""),
						// on considère qu'il n'y a pas de rabais (donc on paie 100%).
						if (isNaN(discountPercent)) {
							discountPercent = 100;
						}
						
						// On convertit le pourcentage en multiplicateur
						const discountMultiplier = discountPercent / 100;
						// ^ ^ ^ FIN DE LA NOUVELLE LOGIQUE ^ ^ ^
						// ^ ^ ^ FIN DES AJOUTS ^ ^ ^
                         if (!isNaN(quantity) && quantity > 0 && !isNaN(price)) {
                             acc[billNo].items.push({
                                 id: matchedProduct.id, 
                                 name: matchedProduct.name, 
                                 quantity: quantity,
                                 price: price 
                             });
		// V V V MODIFIEZ CETTE LIGNE V V V
							// Original : acc[billNo].totalPrice += price * quantity;
							acc[billNo].totalPrice += (price * quantity + priceAdd) * discountMultiplier;
							// ^ ^ ^ FIN DE LA MODIFICATION ^ ^ ^
                         } else {
                             console.warn(`Produit ${item.goodsName || 'N/A'} ignoré dans la facture ${billNo}: quantité ou prix invalide.`);
                         }
                      } else {
                           console.warn(`Produit API "${item.goodsName || 'N/A'}" non trouvé dans la liste des produits Solo. Ignoré pour la facture ${billNo}.`);
                      }
                    
                    return acc;
                }, {});

                const salesToSave = Object.values(groupedSales).filter(sale => sale.items.length > 0); 
                 console.log(`Sales grouped and filtered: ${salesToSave.length} bills`);
                
                if (salesToSave.length === 0) {
                     showToast("Aucune vente valide à importer (produits non trouvés ou données incorrectes).");
                     closeModal('api-import-modal');
                     return;
                 }


                // --- Step 4: Check Stock and Save Batch ---
                 const batch = writeBatch(db);
                 const failedStockChecks = [];
                 statusText.textContent = `Vérification du stock pour ${salesToSave.length} commandes...`;


                 for (const sale of salesToSave) {
                     // ... (logique de vérification stock et création batch - INCHANGÉE) ...
                     const tempDeductions = new Map();
                     let stockAvailable = true;

                     for (const saleItem of sale.items) {
                         const product = allProducts.find(p => p.id === saleItem.id); 
                         if (!product) continue; 

                         if (product.recipe && product.recipe.length > 0) {
                             for (const recipeItem of product.recipe) {
                                 const current = tempDeductions.get(recipeItem.id) || 0;
                                 tempDeductions.set(recipeItem.id, current + recipeItem.quantity * saleItem.quantity);
                             }
                         } else if (product.linkedIngredientId) { 
                             // *** MODIFIED: Use linkedIngredientQuantity ***
                             const linkedQtyPerProduct = product.linkedIngredientQuantity || 1;
                             const totalQtyToDeduct = linkedQtyPerProduct * saleItem.quantity;
                             const current = tempDeductions.get(product.linkedIngredientId) || 0;
                             tempDeductions.set(product.linkedIngredientId, current + totalQtyToDeduct);
                             // *** END MODIFICATION ***
                         }
                     }

                     // Check stock for this specific sale
                     for (const [ingId, qty] of tempDeductions.entries()) {
                         const ing = allIngredients.find(i => i.id === ingId);
                         if (!ing || ing.quantity < qty) {
                             stockAvailable = false;
                             const failedProdName = sale.items.find(i => {
                                 const p = allProducts.find(pr => pr.id === i.id);
                                 return (p?.recipe?.some(r => r.id === ingId) || p?.linkedIngredientId === ingId);
                             })?.name || 'inconnu';
                             failedStockChecks.push(`Stock insuffisant pour facture ${sale.billNo} (produit: ${failedProdName}, ingrédient: ${ing?.name || 'inconnu'})`);
                             break; // Stop checking stock for this sale
                         }
                     }

                     if (stockAvailable) {
                         // Add stock deductions to batch
                         for (const [ingId, qty] of tempDeductions.entries()) {
                             batch.update(doc(ingredientsCol, ingId), { quantity: increment(-qty) });
                         }
                         // Add sale record to batch
                         batch.set(doc(collection(db, ordersCol.path)), { 
                             items: sale.items,
                             totalPrice: sale.totalPrice,
                             createdAt: serverTimestamp(), 
                             saleDate: sale.saleDate,
								billNo: sale.billNo
                         });
                         salesImportedCount++;
                     } else {
                         salesSkippedCount++;
                     }
                 }

                // --- Step 5: Commit Batch ---
                 if (salesImportedCount > 0) {
                     statusText.textContent = `Enregistrement de ${salesImportedCount} vente(s)...`;
                     await batch.commit();
                     let successMsg = `${salesImportedCount} vente(s) importée(s) avec succès via API.`;
                     if (salesSkippedCount > 0) {
                          successMsg += ` ${salesSkippedCount} vente(s) ignorée(s) (stock insuffisant).`;
                          console.warn("Ventes ignorées (stock):", failedStockChecks.join('\n'));
                      }
                     showToast(successMsg);
                 } else if (salesSkippedCount > 0) {
                      showToast(`Aucune vente importée via API. ${salesSkippedCount} vente(s) ignorée(s) (stock insuffisant).`);
                      console.warn("Ventes ignorées (stock):", failedStockChecks.join('\n'));
                 } else {
                       showToast("Aucune vente valide trouvée à importer via API."); 
                 }


            } catch (error) {
                console.error("Erreur détaillée lors de l'importation API via proxy:", error);
                 let userMessage = `Erreur: ${error.message}`;
                 // Adapter les messages d'erreur pour le contexte proxy
                  if (error.message.includes("authentification via proxy")) {
                       userMessage = `Échec d'authentification proxy. Vérifiez les logs du proxy.`;
                 } else if (error.message.includes("Jeton non reçu du proxy")) {
                       userMessage = "Le proxy n'a pas réussi à obtenir un jeton. Vérifiez les logs du proxy.";
                 } else if (error.message.includes("Proxy Ventes")) {
                       userMessage = "Erreur lors de la récupération des ventes via le proxy.";
                 } else if (error instanceof TypeError && error.message.includes('fetch')) {
                       userMessage = `Erreur réseau en contactant le proxy (${PROXY_URL}). Est-il déployé et l'URL est-elle correcte ?`;
                 }
                showToast(userMessage);
            } finally {
                loader.classList.add('hidden');
                statusText.textContent = ''; // Clear status text
                submitButton.disabled = false;
                 // Close modal only if there was some success or no data initially
                 if(salesImportedCount > 0 || (salesSkippedCount === 0 && salesImportedCount === 0 && allSalesData.length === 0)) { 
                     closeModal('api-import-modal');
                 }
            }
        });


        // --- IMPORT/EXPORT CSV ---
        const CSV_INSTRUCTIONS = { 
            ingredients: `<p>4 colonnes: <strong>nom,quantite,unite,cout</strong></p><pre>nom,quantite,unite,cout\nTomates,10,kg,2.5\n</pre>`, 
            products: `<p>4 colonnes: <strong>nom,prix,type,details</strong></p>
                        <p>Pizza/Entrée/Dessert details: "NomIngrédient1:qty1:unit1;NomIngrédient2:qty2:unit2"</p>
                        <p>Boisson/Autre details: "NomArticleStock:qtyConsommée"</p>
                        <pre>Margherita,8.5,Pizza,"Pâte:1:p;Sauce:0.1:kg"\nCoca,2,Boisson,"Canette Coca:1"</pre>`, 
            orders: `<p>3 colonnes: <strong>date,produits,quantites</strong></p><p>Format date: JJ/MM/AAAA</p><pre>21/10/2025,"Margherita;Coca","2;1"</pre>` 
        }; 

        document.getElementById('import-ingredients-btn').addEventListener('click', () => { importType = 'ingredients'; document.getElementById('import-modal-title').textContent = 'Importer des Ingrédients'; document.getElementById('import-instructions').innerHTML = CSV_INSTRUCTIONS.ingredients; openModal('import-modal'); }); 
        document.getElementById('import-products-btn').addEventListener('click', () => { importType = 'products'; document.getElementById('import-modal-title').textContent = 'Importer des Produits'; document.getElementById('import-instructions').innerHTML = CSV_INSTRUCTIONS.products; openModal('import-modal'); }); 
        document.getElementById('import-orders-btn').addEventListener('click', () => { importType = 'orders'; document.getElementById('import-modal-title').textContent = 'Importer des Ventes (CSV)'; document.getElementById('import-instructions').innerHTML = CSV_INSTRUCTIONS.orders; openModal('import-modal'); }); 
        document.getElementById('cancel-import').addEventListener('click', () => closeModal('import-modal')); 
        document.getElementById('csv-file-input').addEventListener('change', () => { document.getElementById('process-import-btn').disabled = !document.getElementById('csv-file-input').files.length; }); 
        document.getElementById('process-import-btn').addEventListener('click', async () => { 
            const file = document.getElementById('csv-file-input').files[0]; 
            if (!file) return showToast("Veuillez choisir un fichier."); 
            document.getElementById('process-import-btn').disabled = true; 
            const reader = new FileReader(); 
            reader.onload = async (event) => { 
                const lines = event.target.result.split('\n').filter(line => line.trim() !== ''); 
                if (lines.length <= 1) { // Check if only header or empty
                     showToast("Le fichier CSV est vide ou ne contient que l'en-tête.");
                     closeModal('import-modal'); 
                     document.getElementById('csv-file-input').value = ''; 
                     document.getElementById('process-import-btn').disabled = false; 
                     return;
                }
                const header = lines.shift(); // Remove header line
                try { 
                    if (importType === 'ingredients') await importIngredients(lines); 
                    else if (importType === 'products') await importProducts(lines); 
                    else if (importType === 'orders') await importOrders(lines); 
                    showToast('Importation terminée !'); 
                } catch (error) { 
                    console.error("Import error:", error); 
                    showToast(`Erreur lors de l'importation: ${error.message}. Vérifiez la ligne correspondante dans votre fichier.`); 
                } finally { 
                    closeModal('import-modal'); 
                    document.getElementById('csv-file-input').value = ''; 
                    document.getElementById('process-import-btn').disabled = false; 
                } 
            }; 
            reader.readAsText(file); 
        });
        
        async function importIngredients(lines) { 
            const batch = writeBatch(db); 
            lines.forEach((line, index) => { 
                try {
                    const [name, quantity, unit, cost] = line.trim().split(','); 
                    if (name && quantity && unit) { 
                        // Use collection() and doc() to ensure a new document reference
                        batch.set(doc(collection(db, ingredientsCol.path)), { name: name.trim(), quantity: parseFloat(quantity), unit: unit.trim(), cost: parseFloat(cost) || 0, createdAt: serverTimestamp() }); 
                    } else {
                        console.warn(`Ligne ingrédient ignorée (données manquantes): Ligne ${index + 2}`, line);
                    }
                } catch(e) {
                     throw new Error(`Erreur à la ligne ${index + 2} (ingrédients) : ${e.message}`);
                }
            }); 
            await batch.commit(); 
        }

        async function importProducts(lines) { 
            const batch = writeBatch(db); 
            lines.forEach((line, index) => { 
                try {
                    const values = line.trim().split(','); 
                    const name = values[0], price = values[1], type = values[2], details = values.slice(3).join(','); 
                    if (!name || !price || !type || !details) {
                        console.warn(`Ligne produit ignorée (données manquantes): Ligne ${index + 2}`, line);
                        return; // Skip this line
                    }; 
                    const data = { name: name.trim(), price: parseFloat(price), type: type.trim(), createdAt: serverTimestamp() }; 
                    
                    if (['Pizza', 'Entrée', 'Dessert'].includes(data.type)) { // Recipe product
                         data.recipe = details.trim().replace(/"/g, '').split(';').map(part => { 
                             const [ingName, ingQty, ingUnit] = part.split(':'); 
                             if(!ingName || !ingQty || !ingUnit) throw new Error(`Format de recette incorrect pour ${name}`);
                             const ing = allIngredients.find(i => i.name.toLowerCase() === ingName.trim().toLowerCase()); 
                             if (!ing) throw new Error(`Ingrédient introuvable: ${ingName} pour le produit ${name}`); 
                             return { id: ing.id, name: ing.name, quantity: parseFloat(ingQty), unit: ingUnit.trim() }; 
                         }); 
                         if (data.recipe.length === 0 || data.recipe.some(r => !r.id)) throw new Error(`Recette invalide ou vide pour ${name}`);
                    
                    } else { // Linked product (Boisson, Autre)
                        // *** MODIFIED: Handle new linked format "Article:Qty" ***
                        const parts = details.trim().replace(/"/g, '').split(':');
                        const ingName = parts[0];
                        const ingQty = parseFloat(parts[1]);

                        if (!ingName || isNaN(ingQty) || ingQty <= 0) {
                            throw new Error(`Format de lien incorrect pour ${name}. Attendu: "NomArticleStock:Qty"`);
                        }

                        const linked = allIngredients.find(i => i.name.toLowerCase() === ingName.trim().toLowerCase()); 
                        if (!linked) throw new Error(`Article en stock introuvable: ${ingName} pour le produit ${name}`); 
                        data.linkedIngredientId = linked.id; 
                        data.linkedIngredientQuantity = ingQty;
                        // *** END MODIFICATION ***
                    } 
                    // Use collection() and doc() to ensure a new document reference
                    batch.set(doc(collection(db, productsCol.path)), data); 
                 } catch(e) {
                     throw new Error(`Erreur à la ligne ${index + 2} (produits) : ${e.message}`);
                 }
            }); 
            await batch.commit(); 
        }
        
        async function importOrders(lines) { 
            const batch = writeBatch(db); 
            for(const [index, line] of lines.entries()) { 
                 try {
                    const [dateRaw, pNamesRaw, qtiesRaw] = line.trim().split(','); 
                    if(!dateRaw || !pNamesRaw || !qtiesRaw) {
                         console.warn(`Ligne vente ignorée (données manquantes): Ligne ${index + 2}`, line);
                        continue; // Skip this line
                    }; 
                    
                    const [day, month, year] = dateRaw.trim().split('/');
                    if (!day || !month || !year || day.length !== 2 || month.length !== 2 || year.length !== 4) {
                         throw new Error(`Format de date invalide (attendu JJ/MM/AAAA) pour ${dateRaw}`);
                    }
                    const saleDate = new Date(`${year}-${month}-${day}T12:00:00Z`); // Use ISO format with time and Z for UTC
                    if (isNaN(saleDate.getTime())) {
                        throw new Error(`Date invalide: ${dateRaw}`);
                    }

                    const pNames = pNamesRaw.replace(/"/g, '').split(';'); 
                    const qties = qtiesRaw.replace(/"/g, '').split(';'); 
                    if (pNames.length !== qties.length) throw new Error(`Nombre de produits et quantités incohérent`);
                    
                    let items = [], total = 0; 
                    let deductions = new Map(); // Track deductions for this specific order line

                    for (let i = 0; i < pNames.length; i++) { 
                        const name = pNames[i].trim();
                        const qtyStr = qties[i].trim();
                        const qty = parseInt(qtyStr); 
                         if (isNaN(qty) || qty <= 0) throw new Error(`Quantité invalide: ${qtyStr} pour ${name}`);

                        const prod = allProducts.find(p => p.name.toLowerCase() === name.toLowerCase()); 
                        if (!prod) throw new Error(`Produit introuvable: ${name}`); 
                        items.push({ id: prod.id, name: prod.name, quantity: qty, price: prod.price }); 
                        total += prod.price * qty; 

                        // Aggregate deductions needed for this order line
                        if (prod.recipe && prod.recipe.length > 0) { 
                            for (const rItem of prod.recipe) {
                                const currentDeduction = deductions.get(rItem.id) || 0;
                                deductions.set(rItem.id, currentDeduction + (rItem.quantity * qty));
                            } 
                        } else if(prod.linkedIngredientId) {
                            const linkedQtyPerProduct = prod.linkedIngredientQuantity || 1; // *** NEW ***
                            const totalQtyToDeduct = linkedQtyPerProduct * qty; // *** NEW ***
                            const currentDeduction = deductions.get(prod.linkedIngredientId) || 0;
                            deductions.set(prod.linkedIngredientId, currentDeduction + totalQtyToDeduct); // *** MODIFIED ***
                        }
                    } 

                    // Apply deductions via batch update
                     for(const [ingId, qtyToDeduct] of deductions.entries()) {
                         // Note: We don't check stock here during import, assuming historical data is correct
                         // or stock adjustment isn't the primary goal of historical import.
                         // If stock checking IS needed, you'd query the current stock first.
                        batch.update(doc(ingredientsCol, ingId), { quantity: increment(-qtyToDeduct) }); 
                     }

                     // Use collection() and doc() to ensure a new document reference
                    batch.set(doc(collection(db, ordersCol.path)), { items, totalPrice: total, createdAt: serverTimestamp(), saleDate }); 
                 } catch(e) {
                     throw new Error(`Erreur à la ligne ${index + 2} (ventes) : ${e.message}`);
                 }
            } 
            await batch.commit(); 
        }


        const downloadCSV = (content, filename) => { const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
        document.getElementById('export-ingredients-btn').addEventListener('click', () => { let csv = "nom,quantite,unite,cout\n"; allIngredients.forEach(i => { csv += `${i.name},${i.quantity},${i.unit},${i.cost || 0}\n`; }); downloadCSV(csv, 'ingredients.csv'); });
        document.getElementById('export-products-btn').addEventListener('click', () => { 
            let csv = "nom,prix,type,details\n"; 
            allProducts.forEach(p => { 
                let d = ''; 
                if (p.type === 'Pizza' || p.type === 'Entrée' || p.type === 'Dessert') { 
                    if(p.recipe) d = `"${p.recipe.map(r => `${r.name}:${r.quantity}:${r.unit}`).join(';')}"`; 
                } else { // Linked product
                    // *** MODIFIED: Export in new format "Article:Qty" ***
                    const l = allIngredients.find(i => i.id === p.linkedIngredientId); 
                    const q = p.linkedIngredientQuantity || 1;
                    d = l ? `"${l.name}:${q}"` : '"NON LIÉ:1"'; 
                    // *** END MODIFICATION ***
                } 
                csv += `${p.name},${p.price},${p.type},${d}\n`; 
            }); 
            downloadCSV(csv, 'produits.csv'); 
        });
        document.getElementById('export-orders-btn').addEventListener('click', () => { 
            let csv = "date,produits,quantites,prix_total\n"; 
            orderHistory.forEach(o => { 
                const date = formatDateToDDMMYYYY(o.saleDate || o.createdAt); 
                const p = o.items.map(i => i.name).join(';'); 
                const q = o.items.map(i => i.quantity).join(';'); // Ligne corrigée
                csv += `${date},"${p}","${q}",${o.totalPrice.toFixed(2)}\n`; 
            }); 
            downloadCSV(csv, 'historique_ventes.csv'); 
        });
        
    </script>
</body>
</html>
