<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>solo - Gestion Pizzeria</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .tab-link.active { border-color: #1f2937; color: #1f2937; font-weight: 600; }

    .low-stock { background-color: #fee2e2 !important; }
    .low-stock-text { color: #b91c1c; font-weight: 600; }

    .modal { display: none; }
    .modal.flex { display: flex; }

    .header-font { font-family: 'Poppins', sans-serif; font-weight: 800; }

    /* Ces classes @apply sont déjà dans ton code d’origine */
    .btn-primary { @apply bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-900 transition-all transform hover:scale-105; }
    .btn-secondary { @apply bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-all; }
    .input-style { @apply p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-800 focus:border-gray-800; }

    .kpi-filter-btn.active { @apply bg-gray-800 text-white shadow-inner; }

    .loader {
      border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
      width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; margin: 0 auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .tab-link { @apply whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors; }
  </style>
</head>
<body class="text-gray-800">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
    <!-- En-tête -->
    <header class="mb-8 text-center">
      <h1 class="header-font text-5xl md:text-6xl font-extrabold text-gray-900 tracking-tight">solo</h1>
      <p class="text-gray-500 uppercase tracking-widest mt-1 text-sm">Pizzeria Napoletana</p>
    </header>

    <!-- Barre de navigation par onglets -->
    <div class="mb-8">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-4 justify-center flex-wrap" aria-label="Tabs">
          <button class="tab-link active" data-tab="dashboard"><i class="fas fa-chart-line mr-2"></i>Tableau de Bord</button>
          <button class="tab-link" data-tab="ingredients"><i class="fas fa-box mr-2"></i>Stock</button>
          <button class="tab-link" data-tab="products"><i class="fas fa-utensils mr-2"></i>Produits</button>
          <button class="tab-link" data-tab="purchases"><i class="fas fa-truck mr-2"></i>Achats</button>
          <button class="tab-link" data-tab="orders"><i class="fas fa-receipt mr-2"></i>Ventes & Pertes</button>
          <!-- NOUVEL ONGLET RH -->
          <button class="tab-link" data-tab="hr"><i class="fas fa-users mr-2"></i>RH</button>
        </nav>
      </div>
    </div>

    <!-- Contenu des onglets -->
    <main>
      <!-- Tableau de Bord -->
      <div id="dashboard-content" class="tab-content active">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h2 class="text-2xl font-semibold text-gray-800">Indicateurs de Performance</h2>
            <p id="kpi-filter-label" class="text-sm text-gray-500">Période : Tout le temps</p>
          </div>
          <button id="toggle-kpi-filters-btn" class="btn-secondary"><i class="fas fa-filter mr-2"></i>Filtrer</button>
        </div>

        <div id="kpi-filter-container" class="hidden mb-6 bg-white p-4 rounded-2xl shadow-lg">
          <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4">
            <div class="flex gap-2">
              <button data-filter="today" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Aujourd'hui</button>
              <button data-filter="yesterday" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Hier</button>
              <button data-filter="week" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Cette semaine</button>
              <button data-filter="month" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Ce mois</button>
            </div>
            <div class="flex items-center gap-2">
              <input type="date" id="kpi-start-date" class="input-style p-1 text-sm">
              <span>à</span>
              <input type="date" id="kpi-end-date" class="input-style p-1 text-sm">
              <button id="kpi-filter-range-btn" class="btn-primary py-1 px-3 text-sm">Appliquer</button>
            </div>
            <button id="kpi-reset-filter-btn" class="text-gray-500 hover:text-gray-800 text-sm font-medium">Réinitialiser</button>
          </div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6 mb-8">
          <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Ventes</h3>
            <p id="kpi-total-sales" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Achats (Reçus)</h3>
            <p id="kpi-total-purchases" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Achats (Non Payés)</h3>
            <p id="kpi-unpaid-purchases" class="text-3xl font-bold text-red-600 mt-1">0.00 Mad</p>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Pertes</h3>
            <p id="kpi-total-losses" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
          </div>
          <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Ventes (Nbre)</h3>
            <p id="kpi-total-orders" class="text-3xl font-bold text-gray-900 mt-1">0</p>
          </div>
          <!-- NOUVEAU KPI -->
          <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">TOTAL SALAIRE (Mensuel)</h3>
            <p id="kpi-total-salaries" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
          </div>
        </div>

        <h2 class="text-2xl font-semibold mb-4 text-gray-800">Alertes de Stock</h2>
        <div id="low-stock-alerts" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          <div id="low-stock-placeholder" class="text-center col-span-full py-10 text-gray-500">
            <i class="fas fa-check-circle fa-2x text-green-500 mb-2"></i><p>Aucune alerte de stock bas pour le moment.</p>
          </div>
        </div>
      </div>

      <!-- Ingrédients -->
      <div id="ingredients-content" class="tab-content">
        <!-- (inchangé) -->
        <!-- ... TON CONTENU ORIGINAL ICI (identique) ... -->
      </div>

      <!-- Produits -->
      <div id="products-content" class="tab-content">
        <!-- (inchangé) -->
        <!-- ... TON CONTENU ORIGINAL ICI (identique) ... -->
      </div>

      <!-- Achats / Fournisseurs -->
      <div id="purchases-content" class="tab-content">
        <!-- (inchangé) -->
        <!-- ... TON CONTENU ORIGINAL ICI (identique) ... -->
      </div>

      <!-- Ventes -->
      <div id="orders-content" class="tab-content">
        <!-- (inchangé) -->
        <!-- ... TON CONTENU ORIGINAL ICI (identique) ... -->
      </div>

      <!-- *** NOUVEL ONGLET RH *** -->
      <div id="hr-content" class="tab-content">
        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
          <h2 class="text-2xl font-semibold text-gray-800">Ressources Humaines</h2>
          <div class="flex gap-2">
            <button id="add-employee-btn" class="btn-primary">
              <i class="fas fa-user-plus mr-2"></i>Ajouter un Salarié
            </button>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-lg">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nom</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date d'embauche</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Salaire (Mad)</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Salaire Mois Courant</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Absences (mois)</th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody id="employees-list" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
            <div id="employees-placeholder" class="text-center py-10 text-gray-500 hidden">
              <p>Aucun salarié. Ajoutez-en un pour commencer !</p>
            </div>
          </div>
        </div>

        <div class="mt-8">
          <h3 class="text-xl font-semibold text-gray-700 mb-3">Absences récentes</h3>
          <div id="absence-history-list" class="space-y-3">
            <div id="absence-history-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-2xl shadow-lg">
              <p>Aucune absence déclarée.</p>
            </div>
          </div>
        </div>
      </div>
      <!-- *** FIN ONGLET RH *** -->

    </main>
  </div>

  <!-- Modals existants (inchangés) -->
  <!-- ... TOUS TES MODALS D’ORIGINE ICI (identiques) ... -->

  <!-- *** MODALS RH *** -->
  <div id="employee-modal" class="modal fixed z-20 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
      <h3 id="employee-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Ajouter un salarié</h3>
      <form id="employee-form">
        <input type="hidden" id="employee-id">
        <div class="space-y-4">
          <div>
            <label for="employee-name" class="block text-sm font-medium text-gray-700">Nom complet</label>
            <input type="text" id="employee-name" required class="mt-1 w-full input-style" placeholder="Ex: Ahmed El ...">
          </div>
          <div>
            <label for="employee-hire-date" class="block text-sm font-medium text-gray-700">Date d'embauche</label>
            <input type="date" id="employee-hire-date" required class="mt-1 w-full input-style">
          </div>
          <div>
            <label for="employee-salary" class="block text-sm font-medium text-gray-700">Salaire mensuel (Mad)</label>
            <input type="number" id="employee-salary" min="0" step="0.01" required class="mt-1 w-full input-style" placeholder="0.00">
          </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" class="btn-secondary" id="cancel-employee">Annuler</button>
          <button type="submit" class="btn-primary">Sauvegarder</button>
        </div>
      </form>
    </div>
  </div>

  <div id="absence-modal" class="modal fixed z-20 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
      <h3 class="text-xl font-semibold mb-4 text-gray-800">Déclarer une absence</h3>
      <form id="absence-form">
        <input type="hidden" id="absence-employee-id">
        <div class="space-y-4">
          <div>
            <label for="absence-date" class="block text-sm font-medium text-gray-700">Date</label>
            <input type="date" id="absence-date" required class="mt-1 w-full input-style">
          </div>
          <div>
            <label for="absence-note" class="block text-sm font-medium text-gray-700">Motif / Note (optionnel)</label>
            <textarea id="absence-note" rows="3" class="mt-1 w-full input-style" placeholder="Ex: Maladie, retard, ..."></textarea>
          </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" class="btn-secondary" id="cancel-absence">Annuler</button>
          <button type="submit" class="btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
  <!-- *** FIN MODALS RH *** -->

  <div id="toast" class="hidden fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg">
    <p id="toast-message"></p>
  </div>

  <!-- Ton script existant, + ajouts RH -->
  <script type="module">
    // --- IMPORTS FIREBASE (inchangés) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc, serverTimestamp, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // --- CONFIG (inchangé) ---
    const firebaseConfigFromUser = {
      apiKey: "AIzaSyCzUX90zSN2zG9O97g7TNyTmTSNte9OT-E",
      authDomain: "solopro-6521a.firebaseapp.com",
      projectId: "solopro-6521a",
      storageBucket: "solopro-6521a.appspot.com",
      messagingSenderId: "126450282941",
      appId: "1:126450282941:web:10e5255e6ee7c75fa8e2d4"
    };
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigFromUser;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pizzeria-pro';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

    const PROXY_URL = "https://solo-proxy.onrender.com"; // (inchangé pour tes ventes API)

    // --- INIT FIREBASE (inchangé) ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- COLLECTIONS REFS (Ajout RH) ---
    let ingredientsCol, productsCol, ordersCol, suppliersCol, purchaseOrdersCol, lossesCol;
    let employeesCol, absencesCol, payrollCol;

    // --- ETAT GLOBAL ---
    let allIngredients = [];
    let allProducts = [];
    let orderHistory = [];
    let allSuppliers = [];
    let allLosses = [];
    let allPurchaseOrders = [];
    let currentRecipe = [];
    let currentOrder = [];
    let currentPurchaseOrderItems = [];
    let importType = '';

    // RH
    let allEmployees = [];
    let allAbsences = [];
    let allPayroll = [];

    const LOW_STOCK_THRESHOLD = 10;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Collections existantes
        ingredientsCol     = collection(db, `artifacts/${appId}/public/data/ingredients`);
        productsCol        = collection(db, `artifacts/${appId}/public/data/products`);
        ordersCol          = collection(db, `artifacts/${appId}/public/data/orders`);
        suppliersCol       = collection(db, `artifacts/${appId}/public/data/suppliers`);
        purchaseOrdersCol  = collection(db, `artifacts/${appId}/public/data/purchaseOrders`);
        lossesCol          = collection(db, `artifacts/${appId}/public/data/losses`);
        // *** NOUVELLES COLLECTIONS RH ***
        employeesCol       = collection(db, `artifacts/${appId}/public/data/employees`);
        absencesCol        = collection(db, `artifacts/${appId}/public/data/absences`);
        payrollCol         = collection(db, `artifacts/${appId}/public/data/payroll`);

        listenToAllCollections();

        const todayStr = getTodayDateString();
        const saleDateEl = document.getElementById('sale-date');
        if (saleDateEl) saleDateEl.value = todayStr;

        const apiStart = document.getElementById('api-start-date');
        const apiEnd   = document.getElementById('api-end-date');
        if (apiStart && apiEnd) {
          apiStart.value = todayStr;
          apiEnd.value = todayStr;
        }
      } else {
        try {
          if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
          else await signInAnonymously(auth);
        } catch (error) { console.error("Auth failed:", error); }
      }
    });

    function listenToAllCollections() {
      // existants
      onSnapshot(suppliersCol, s => { allSuppliers = s.docs.map(d => ({ id: d.id, ...d.data() })); renderSuppliers(); populateSupplierSelects(); });
      onSnapshot(purchaseOrdersCol, s => { allPurchaseOrders = s.docs.map(d => ({ id: d.id, ...d.data() })); allPurchaseOrders.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); renderPurchaseOrders(allPurchaseOrders); updateAndRenderKPIs(); });
      onSnapshot(ingredientsCol, s => { allIngredients = s.docs.map(d => ({ id: d.id, ...d.data() })); allIngredients.sort((a,b) => a.name.localeCompare(b.name)); renderIngredients(); updateAndRenderKPIs(); populateIngredientSelects(); renderProducts(); });
      onSnapshot(productsCol, s => { allProducts = s.docs.map(d => ({ id: d.id, ...d.data() })); allProducts.sort((a,b) => a.name.localeCompare(b.name)); renderProducts(); populateProductSelects(); updateAndRenderKPIs(); });
      onSnapshot(ordersCol, s => { orderHistory = s.docs.map(d => ({ id: d.id, ...d.data() })); orderHistory.sort((a,b) => (b.saleDate?.seconds || b.createdAt?.seconds || 0) - (a.saleDate?.seconds || a.createdAt?.seconds || 0)); renderOrderHistory(orderHistory); updateAndRenderKPIs(); });
      onSnapshot(lossesCol, s => { allLosses = s.docs.map(d => ({ id: d.id, ...d.data() })); allLosses.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); renderLossHistory(); updateAndRenderKPIs(); });

      // *** RH ***
      onSnapshot(employeesCol, s => {
        allEmployees = s.docs.map(d => ({ id: d.id, ...d.data() }));
        allEmployees.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
        renderEmployees();
        updateAndRenderKPIs();
      });
      onSnapshot(absencesCol, s => {
        allAbsences = s.docs.map(d => ({ id: d.id, ...d.data() }));
        renderAbsenceHistory();
      });
      onSnapshot(payrollCol, s => {
        allPayroll = s.docs.map(d => ({ id: d.id, ...d.data() }));
        renderEmployees(); // met à jour l’affichage payé/non payé
      });
    }

    // --- HELPERS (originaux + petits ajouts) ---
    const showToast = (m) => { const t = document.getElementById('toast'); document.getElementById('toast-message').textContent = m; t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000); };
    const openModal  = id => document.getElementById(id).classList.add('flex');
    const closeModal = id => document.getElementById(id).classList.remove('flex');

    const getTodayDateString = () => {
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth() + 1).padStart(2, '0');
      const d = String(today.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    };
    const formatDateToDDMMYYYY = (date) => {
      if (!date) return 'Date inconnue';
      const d = date.seconds ? new Date(date.seconds * 1000) : date;
      if (isNaN(d.getTime())) return 'Date invalide';
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return `${day}/${month}/${year} à ${hours}h${minutes}`;
    };
    const toDate = (timestamp) => timestamp ? (timestamp.seconds ? new Date(timestamp.seconds * 1000) : timestamp) : null;

    // Utilitaire RH
    const monthKey = (d = new Date()) => {
      const dd = (d.seconds ? new Date(d.seconds * 1000) : d);
      return `${dd.getFullYear()}-${String(dd.getMonth()+1).padStart(2,'0')}`;
    };

    // --- NAVIGATION (inchangé) ---
    document.querySelectorAll('.tab-link').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');
      });
    });

    // --- KPIs (ajout total salaires) ---
    const updateAndRenderKPIs = (startDate, endDate, label = "Période : Tout le temps") => {
      const kpiLabelEl = document.getElementById('kpi-filter-label');
      if (kpiLabelEl) kpiLabelEl.textContent = label;

      const filteredOrders = !startDate ? orderHistory : orderHistory.filter(o => {
        const orderDate = toDate(o.saleDate || o.createdAt);
        return orderDate && orderDate >= startDate && orderDate <= endDate;
      });

      const filteredPurchases = !startDate ? allPurchaseOrders.filter(p => p.status === 'received') : allPurchaseOrders.filter(p => {
        const receivedDate = toDate(p.receivedAt);
        return p.status === 'received' && receivedDate && receivedDate >= startDate && receivedDate <= endDate;
      });

      const filteredUnpaidPurchases = !startDate
        ? allPurchaseOrders.filter(p => p.status === 'received' && p.paymentStatus !== 'paid')
        : allPurchaseOrders.filter(p => {
            const receivedDate = toDate(p.receivedAt);
            return p.status === 'received' && p.paymentStatus !== 'paid' && receivedDate && receivedDate >= startDate && receivedDate <= endDate;
          });

      const filteredLosses = !startDate ? allLosses : allLosses.filter(l => {
        const lossDate = toDate(l.createdAt);
        return lossDate && lossDate >= startDate && lossDate <= endDate;
      });

      const totalSales = filteredOrders.reduce((s,o)=> s + o.totalPrice, 0);
      const totalPurchases = filteredPurchases.reduce((s,po)=> s + (po.totalCost || 0), 0);
      const totalUnpaidPurchases = filteredUnpaidPurchases.reduce((s,po)=> s + (po.totalCost || 0), 0);
      const totalOrders = filteredOrders.length;
      const totalLossesValue = filteredLosses.reduce((sum, loss) => {
        let lossCost = 0;
        if (loss.type === 'product') {
          const product = allProducts.find(p => p.id === loss.itemId);
          if (product) lossCost = calculateProductCost(product) * loss.quantity;
        } else {
          const ingredient = allIngredients.find(i => i.id === loss.itemId);
          if (ingredient) lossCost = (ingredient.cost || 0) * loss.quantity;
        }
        return sum + lossCost;
      }, 0);

      // *** TOTAL SALAIRE (mensuel) ***
      const totalSalaries = allEmployees.reduce((s,e) => s + (parseFloat(e.salary)||0), 0);

      const el = (id) => document.getElementById(id);
      if (el('kpi-total-sales')) el('kpi-total-sales').textContent = `${totalSales.toFixed(2)} Mad`;
      if (el('kpi-total-purchases')) el('kpi-total-purchases').textContent = `${totalPurchases.toFixed(2)} Mad`;
      if (el('kpi-unpaid-purchases')) el('kpi-unpaid-purchases').textContent = `${totalUnpaidPurchases.toFixed(2)} Mad`;
      if (el('kpi-total-losses')) el('kpi-total-losses').textContent = `${totalLossesValue.toFixed(2)} Mad`;
      if (el('kpi-total-orders')) el('kpi-total-orders').textContent = totalOrders;
      if (el('kpi-total-salaries')) el('kpi-total-salaries').textContent = `${totalSalaries.toFixed(2)} Mad`;

      // Alertes stock (inchangé)
      const container = document.getElementById('low-stock-alerts');
      const placeholder = document.getElementById('low-stock-placeholder');
      if (!container) return;
      container.innerHTML = '';
      const lowStockItems = allIngredients.filter(ing => ing.quantity < LOW_STOCK_THRESHOLD);
      if (lowStockItems.length === 0) {
        container.appendChild(placeholder);
      } else {
        lowStockItems.forEach(item => {
          const alertDiv = document.createElement('div');
          alertDiv.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow';
          alertDiv.innerHTML = `<p class="font-bold">${item.name}</p><p>Stock restant: ${item.quantity} ${item.unit}</p>`;
          container.appendChild(alertDiv);
        });
      }
    };

    // ------------- TOUT TON CODE EXISTANT (ingrédients, produits, ventes, achats, pertes, import/export, API, etc.) RESTE IDENTIQUE -------------
    // Pour éviter un message gigantesque, je garde “tel quel” tes handlers existants.
    // >>> COLLE ICI TON SCRIPT ORIGINAL ENTRE CETTE LIGNE ET LA SECTION RH SUIVANTE <<<
    // (rassure-toi: l’onglet RH fonctionne indépendamment et n’impacte pas les autres parties)

    // ===================== RH : Rendu & Actions =====================

    // Rendu liste des salariés
    function renderEmployees() {
      const list = document.getElementById('employees-list');
      const placeholder = document.getElementById('employees-placeholder');
      if (!list) return;

      list.innerHTML = '';
      if (allEmployees.length === 0) {
        if (placeholder) placeholder.classList.remove('hidden');
        return;
      }
      if (placeholder) placeholder.classList.add('hidden');

      const currentMk = monthKey(new Date());

      allEmployees.forEach(emp => {
        const tr = document.createElement('tr');

        // statut paiement du mois courant
        const paidRecord = allPayroll.find(p => p.employeeId === emp.id && p.monthKey === currentMk);
        const isPaid = !!paidRecord;

        // absences du mois courant
        const absCount = allAbsences.filter(a => a.employeeId === emp.id && monthKey(a.date) === currentMk).length;

        tr.innerHTML = `
          <td class="px-4 py-3 font-medium text-gray-900">${emp.name || '-'}</td>
          <td class="px-4 py-3 text-gray-700">${emp.hireDate ? formatDateToDDMMYYYY(emp.hireDate) : '-'}</td>
          <td class="px-4 py-3">
            <div class="flex items-center gap-2">
              <input type="number" step="0.01" min="0" value="${emp.salary ? Number(emp.salary).toFixed(2) : '0.00'}" class="w-28 input-style emp-salary-input" data-id="${emp.id}">
              <button class="text-gray-600 hover:text-gray-900 emp-save-salary" title="Sauvegarder" data-id="${emp.id}">
                <i class="fas fa-save"></i>
              </button>
            </div>
          </td>
          <td class="px-4 py-3">
            <span class="inline-block text-xs font-bold py-1 px-2 rounded-full ${isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
              ${isPaid ? 'Payé' : 'Non Payé'}
            </span>
          </td>
          <td class="px-4 py-3 text-gray-700">${absCount}</td>
          <td class="px-4 py-3 text-right">
            <div class="flex justify-end gap-2">
              <button class="btn-secondary text-xs declare-absence" data-id="${emp.id}">
                <i class="fas fa-user-clock mr-1"></i> Absence
              </button>
              ${isPaid
                ? `<button class="btn-secondary text-xs unpay-salary" data-payroll-id="${paidRecord?.id}" data-emp="${emp.id}">
                    <i class="fas fa-rotate-left mr-1"></i> Annuler Paiement
                   </button>`
                : `<button class="btn-primary text-xs pay-salary" data-id="${emp.id}">
                    <i class="fas fa-check mr-1"></i> Marquer Payé
                   </button>`
              }
              <button class="text-gray-500 hover:text-gray-800 edit-employee" title="Modifier" data-id="${emp.id}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="text-red-600 hover:text-red-800 delete-employee" title="Supprimer" data-id="${emp.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        `;
        list.appendChild(tr);
      });
    }

    // Rendu historique absences (les plus récentes d’abord)
    function renderAbsenceHistory() {
      const list = document.getElementById('absence-history-list');
      const placeholder = document.getElementById('absence-history-placeholder');
      if (!list) return;

      list.innerHTML = '';
      if (allAbsences.length === 0) {
        if (placeholder) placeholder.classList.remove('hidden');
        return;
      }
      if (placeholder) placeholder.classList.add('hidden');

      const sorted = [...allAbsences].sort((a,b) => (b.date?.seconds||0) - (a.date?.seconds||0));
      sorted.forEach(ab => {
        const emp = allEmployees.find(e => e.id === ab.employeeId);
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl shadow-md';
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <p class="font-bold text-gray-700">${emp?.name || 'Salarié inconnu'}</p>
              <p class="text-sm text-gray-600">Absence du ${formatDateToDDMMYYYY(ab.date)}</p>
              ${ab.note ? `<p class="text-xs text-gray-500 italic mt-1">"${ab.note}"</p>` : ''}
            </div>
            <button class="text-gray-400 hover:text-red-600 delete-absence" data-id="${ab.id}" title="Supprimer">
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    // ---------- Actions RH : Modals ----------
    const addEmpBtn = document.getElementById('add-employee-btn');
    const cancelEmpBtn = document.getElementById('cancel-employee');
    const empForm = document.getElementById('employee-form');

    if (addEmpBtn) addEmpBtn.addEventListener('click', () => {
      document.getElementById('employee-modal-title').textContent = 'Ajouter un salarié';
      document.getElementById('employee-id').value = '';
      document.getElementById('employee-form').reset();
      openModal('employee-modal');
    });
    if (cancelEmpBtn) cancelEmpBtn.addEventListener('click', () => closeModal('employee-modal'));

    if (empForm) empForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('employee-id').value;
      const name = document.getElementById('employee-name').value.trim();
      const hireDateRaw = document.getElementById('employee-hire-date').value;
      const salary = parseFloat(document.getElementById('employee-salary').value);
      if (!name || !hireDateRaw || isNaN(salary) || salary < 0) {
        showToast('Veuillez remplir correctement le formulaire salarié.');
        return;
      }
      const hireDate = new Date(hireDateRaw);
      const data = { name, hireDate, salary };
      try {
        if (id) await updateDoc(doc(employeesCol, id), data);
        else await addDoc(employeesCol, { ...data, createdAt: serverTimestamp() });
        showToast(id ? 'Salarié mis à jour' : 'Salarié ajouté');
        closeModal('employee-modal');
      } catch (err) {
        console.error(err);
        showToast("Erreur lors de l'enregistrement du salarié.");
      }
    });

    // Déclarer une absence
    const cancelAbsBtn = document.getElementById('cancel-absence');
    if (cancelAbsBtn) cancelAbsBtn.addEventListener('click', () => closeModal('absence-modal'));

    const absenceForm = document.getElementById('absence-form');
    if (absenceForm) absenceForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const empId = document.getElementById('absence-employee-id').value;
      const dateRaw = document.getElementById('absence-date').value;
      const note = document.getElementById('absence-note').value.trim();
      if (!empId || !dateRaw) { showToast('Veuillez choisir une date.'); return; }
      const date = new Date(dateRaw);
      try {
        await addDoc(absencesCol, { employeeId: empId, date, note, createdAt: serverTimestamp() });
        showToast('Absence enregistrée.');
        closeModal('absence-modal');
      } catch (e2) {
        console.error(e2);
        showToast("Erreur lors de l'enregistrement de l'absence.");
      }
    });

    // ---------- Délégations d’événements (table RH) ----------
    const empList = document.getElementById('employees-list');
    if (empList) {
      empList.addEventListener('click', async (e) => {
        const btn = e.target.closest('button');
        const input = e.target.closest('input.emp-salary-input');

        // Sauvegarde salaire
        if (btn && btn.classList.contains('emp-save-salary')) {
          const id = btn.dataset.id;
          const inputEl = empList.querySelector(`input.emp-salary-input[data-id="${id}"]`);
          const val = parseFloat(inputEl?.value);
          if (isNaN(val) || val < 0) return showToast('Salaire invalide.');
          try {
            await updateDoc(doc(employeesCol, id), { salary: val });
            showToast('Salaire mis à jour');
          } catch (er) { console.error(er); showToast('Erreur de mise à jour.'); }
        }

        // Déclarer absence
        if (btn && btn.classList.contains('declare-absence')) {
          const id = btn.dataset.id;
          document.getElementById('absence-form').reset();
          document.getElementById('absence-employee-id').value = id;
          document.getElementById('absence-date').value = getTodayDateString();
          openModal('absence-modal');
        }

        // Marquer salaire payé (mois courant)
        if (btn && btn.classList.contains('pay-salary')) {
          const id = btn.dataset.id;
          const mk = monthKey(new Date());
          try {
            await addDoc(payrollCol, { employeeId: id, monthKey: mk, paidAt: serverTimestamp() });
            showToast('Salaire marqué comme payé (mois courant).');
          } catch (er) { console.error(er); showToast('Erreur lors du marquage payé.'); }
        }

        // Annuler paiement du salaire (supprimer l’enregistrement du mois)
        if (btn && btn.classList.contains('unpay-salary')) {
          const payrollId = btn.dataset.payrollId;
          try {
            await deleteDoc(doc(payrollCol, payrollId));
            showToast('Paiement du mois annulé.');
          } catch (er) { console.error(er); showToast('Erreur lors de l’annulation.'); }
        }

        // Modifier salarié
        if (btn && btn.classList.contains('edit-employee')) {
          const id = btn.dataset.id;
          const emp = allEmployees.find(e => e.id === id);
          if (!emp) return;
          document.getElementById('employee-modal-title').textContent = 'Modifier un salarié';
          document.getElementById('employee-id').value = id;
          document.getElementById('employee-name').value = emp.name || '';
          const hd = emp.hireDate ? toDate(emp.hireDate) : null;
          document.getElementById('employee-hire-date').value = hd ? `${hd.getFullYear()}-${String(hd.getMonth()+1).padStart(2,'0')}-${String(hd.getDate()).padStart(2,'0')}` : '';
          document.getElementById('employee-salary').value = emp.salary ?? 0;
          openModal('employee-modal');
        }

        // Supprimer salarié
        if (btn && btn.classList.contains('delete-employee')) {
          const id = btn.dataset.id;
          if (!confirm('Supprimer ce salarié ?')) return;
          try {
            // Option simple: suppression employee. (Absences / payroll restent en base pour historique)
            await deleteDoc(doc(employeesCol, id));
            showToast('Salarié supprimé.');
          } catch (er) { console.error(er); showToast('Erreur lors de la suppression.'); }
        }
      });
    }

    // Supprimer une absence depuis l’historique
    const absList = document.getElementById('absence-history-list');
    if (absList) {
      absList.addEventListener('click', async (e) => {
        const btn = e.target.closest('button.delete-absence');
        if (!btn) return;
        const id = btn.dataset.id;
        if (!confirm('Supprimer cette absence ?')) return;
        try {
          await deleteDoc(doc(absencesCol, id));
          showToast('Absence supprimée.');
        } catch (er) { console.error(er); showToast('Erreur lors de la suppression.'); }
      });
    }

    // ===================== FIN RH =====================

    // NOTE: tout le reste de ton code (renderIngredients, renderProducts, ventes, achats,
    // pertes, imports CSV, import API via proxy, etc.) reste identique à ta version fournie.
  </script>
</body>
</html>
