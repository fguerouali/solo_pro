<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>solo - Gestion Pizzeria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cccccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaaaaa; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .tab-link.active { 
            border-color: #1f2937; /* gray-800 */
            color: #1f2937; /* gray-800 */
            font-weight: 600;
        }

        .low-stock { background-color: #fee2e2 !important; }
        .low-stock-text { color: #b91c1c; font-weight: 600; }
        
        .modal { display: none; }
        .modal.flex { display: flex; }

        .header-font { font-family: 'Poppins', sans-serif; font-weight: 800; }

        .btn-primary { @apply bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-900 transition-all transform hover:scale-105; }
        .btn-secondary { @apply bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-all; }
        .input-style { @apply p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-800 focus:border-gray-800; }
        
        .kpi-filter-btn.active {
            @apply bg-gray-800 text-white shadow-inner;
        }

        /* Spinner Styles */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block; /* Or block, depending on layout */
            margin: 0 auto; /* Center if block */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles pour la page de login */
        #login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Page de Login -->
    <div id="login-page">
        <div class="login-card">
            <div class="text-center mb-8">
                <h1 class="header-font text-4xl font-extrabold text-gray-900 mb-2">solo</h1>
                <p class="text-gray-500 uppercase tracking-widest text-sm">Pizzeria Napoletana</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-2"></i>Nom d'utilisateur
                    </label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-gray-800 transition-all"
                        placeholder="Entrez votre nom d'utilisateur"
                        autocomplete="username"
                    >
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-2"></i>Mot de passe
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-gray-800 transition-all"
                        placeholder="Entrez votre mot de passe"
                        autocomplete="current-password"
                    >
                </div>
                
                <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="login-error-message"></span>
                </div>
                
                <button 
                    type="submit" 
                    id="login-submit-btn"
                    class="w-full bg-gray-800 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-900 transition-all transform hover:scale-105 flex items-center justify-center"
                >
                    <span id="login-submit-text">Se connecter</span>
                    <div id="login-loader" class="loader hidden ml-2"></div>
                </button>
            </form>
        </div>
    </div>

    <!-- Application principale (masquée jusqu'à authentification) -->
    <div id="app-container" class="hidden">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <!-- En-tête -->
        <header class="mb-8 text-center relative">
            <button 
                onclick="logout()" 
                class="absolute top-0 right-0 btn-secondary text-sm"
                title="Se déconnecter"
            >
                <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
            </button>
            <h1 class="header-font text-5xl md:text-6xl font-extrabold text-gray-900 tracking-tight">
                solo
            </h1>
            <p class="text-gray-500 uppercase tracking-widest mt-1 text-sm">Pizzeria Napoletana</p>
        </header>

        <!-- Barre de navigation par onglets -->
        <div class="mb-8">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-4 justify-center flex-wrap" aria-label="Tabs">
                    <button class="tab-link active" data-tab="dashboard"><i class="fas fa-chart-line mr-2"></i>Tableau de Bord</button>
                    <button class="tab-link" data-tab="ingredients"><i class="fas fa-box mr-2"></i>Stock</button>
                    <button class="tab-link" data-tab="products"><i class="fas fa-utensils mr-2"></i>Produits</button>
                    <button class="tab-link" data-tab="purchases"><i class="fas fa-truck mr-2"></i>Achats</button>
                    <button class="tab-link" data-tab="orders"><i class="fas fa-receipt mr-2"></i>Ventes & Pertes</button>
					<button class="tab-link" data-tab="charges"><i class="fas fa-file-invoice-dollar mr-2"></i>Charges</button>
					<button class="tab-link" data-tab="rh"><i class="fas fa-users mr-2"></i>RH</button>
					<button class="tab-link" data-tab="finance"><i class="fas fa-coins mr-2"></i>Finance</button>

                </nav>
            </div>
        </div>

        <!-- Contenu des onglets -->
        <main>
            <!-- Tableau de Bord -->
            <div id="dashboard-content" class="tab-content active">
                 <!-- Bouton pour afficher les filtres -->
                <div class="flex justify-between items-center mb-4">
                    <div>
                         <h2 class="text-2xl font-semibold text-gray-800">Indicateurs de Performance</h2>
                         <p id="kpi-filter-label" class="text-sm text-gray-500">Période : Tout le temps</p>
                    </div>
                    <button id="toggle-kpi-filters-btn" class="btn-secondary"><i class="fas fa-filter mr-2"></i>Filtrer</button>
                </div>

                <!-- Conteneur des filtres (caché par défaut) -->
                <div id="kpi-filter-container" class="hidden mb-6 bg-white p-4 rounded-2xl shadow-lg">
                    <div class="flex flex-wrap items-center justify-center gap-2 md:gap-4">
                        <!-- Filtres Prédéfinis -->
                        <div class="flex gap-2">
                             <button data-filter="today" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Aujourd'hui</button>
							 <button data-filter="yesterday" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Hier</button>                              <button data-filter="week" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Cette semaine</button>
                             <button data-filter="month" class="kpi-filter-btn btn-secondary py-1 px-3 text-sm">Ce mois</button>
                        </div>
                        <!-- Plage de Dates Personnalisée -->
                        <div class="flex items-center gap-2">
                            <input type="date" id="kpi-start-date" class="input-style p-1 text-sm">
                            <span>à</span>
                            <input type="date" id="kpi-end-date" class="input-style p-1 text-sm">
                            <button id="kpi-filter-range-btn" class="btn-primary py-1 px-3 text-sm">Appliquer</button>
                        </div>
                        <button id="kpi-reset-filter-btn" class="text-gray-500 hover:text-gray-800 text-sm font-medium">Réinitialiser</button>
                    </div>
                </div>


                <!-- KPIs -->
<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6 mb-8">
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Ventes</h3>
                        <p id="kpi-total-sales" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Achats (Reçus)</h3>
                        <p id="kpi-total-purchases" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Achats (Non Payés)</h3>
                        <p id="kpi-unpaid-purchases" class="text-3xl font-bold text-red-600 mt-1">0.00 Mad</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Pertes</h3>
                        <p id="kpi-total-losses" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-lg text-center">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Ventes (Nbre)</h3>
                        <p id="kpi-total-orders" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                    </div>
					<div class="bg-white p-4 rounded-2xl shadow-lg text-center">
    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Pizzas Vendues</h3>
    <p id="kpi-total-pizzas" class="text-3xl font-bold text-gray-900 mt-1">0</p>
</div>
<div class="bg-white p-4 rounded-2xl shadow-lg text-center">
    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Panier Moyen</h3>
    <p id="kpi-avg-order-value" class="text-3xl font-bold text-gray-900 mt-1">0.00 Mad</p>
</div>
<div class="bg-white p-4 rounded-2xl shadow-lg text-center">
    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Taux de Perte</h3>
    <p id="kpi-loss-rate" class="text-3xl font-bold text-red-600 mt-1">0 %</p>
</div>
<div class="bg-white p-4 rounded-2xl shadow-lg text-center">
    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Marge Brute</h3>
    <p id="kpi-gross-margin" class="text-3xl font-bold text-green-600 mt-1">0.00 Mad</p>
</div>
<div class="bg-white p-4 rounded-2xl shadow-lg text-center">
    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Taux Marge Brute</h3>
    <p id="kpi-gross-margin-rate" class="text-3xl font-bold text-green-600 mt-1">0 %</p>
</div><div class="bg-white p-4 rounded-2xl shadow-lg text-center">
    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Total Charges</h3>
    <p id="kpi-total-charges" class="text-3xl font-bold text-red-600 mt-1">0.00 Mad</p>
</div>

<div class="bg-white p-4 rounded-2xl shadow-lg text-center">
    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Bénéfice Net</h3>
    <p id="kpi-net-profit" class="text-3xl font-bold text-green-600 mt-1">0.00 Mad</p>
</div>
                </div>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Top 5 Pizzas -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-pizza-slice text-red-500 mr-2"></i>
            Top 5 Pizzas
        </h3>
        <div id="top-pizzas-list" class="space-y-3">
            <p class="text-center text-gray-500 py-4">Aucune donnée disponible</p>
        </div>
    </div>

    <!-- Top 5 Boissons -->
    <div class="bg-white p-6 rounded-2xl shadow-lg">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-wine-bottle text-blue-500 mr-2"></i>
            Top 5 Boissons
        </h3>
        <div id="top-drinks-list" class="space-y-3">
            <p class="text-center text-gray-500 py-4">Aucune donnée disponible</p>
        </div>
    </div>
</div>
                <h2 class="text-2xl font-semibold mb-4 text-gray-800">Alertes de Stock</h2>
                <div id="low-stock-alerts" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <div id="low-stock-placeholder" class="text-center col-span-full py-10 text-gray-500">
                        <i class="fas fa-check-circle fa-2x text-green-500 mb-2"></i><p>Aucune alerte de stock bas pour le moment.</p>
                    </div>
                </div>
            </div>

            <!-- Ingrédients -->
            <div id="ingredients-content" class="tab-content">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Gestion du Stock</h2>
                    <div class="flex gap-2">
                        <button id="import-ingredients-btn" class="btn-secondary"><i class="fas fa-upload mr-2"></i>Importer</button>
                        <button id="export-ingredients-btn" class="btn-secondary"><i class="fas fa-download mr-2"></i>Exporter</button>
                        <button id="add-ingredient-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Ajouter</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <table id="ingredients-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ingrédient</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité en stock</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Coût / Unité</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ingredients-list" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                     <div id="ingredients-placeholder" class="hidden text-center py-10 text-gray-500">
                        <p>Aucun ingrédient. Ajoutez-en un pour commencer !</p>
                    </div>
                </div>
            </div>

            <!-- Produits -->
            <div id="products-content" class="tab-content">
                 <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Gestion des Produits</h2>
                    <div class="flex gap-2">
                        <button id="import-products-btn" class="btn-secondary"><i class="fas fa-upload mr-2"></i>Importer</button>
                        <button id="export-products-btn" class="btn-secondary"><i class="fas fa-download mr-2"></i>Exporter</button>
                        <button id="add-product-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Créer un Produit</button>
                    </div>
                </div>
                <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                     <div id="products-placeholder" class="text-center col-span-full py-10 text-gray-500">
                        <p>Aucun produit créé. Créez votre premier produit !</p>
                    </div>
                </div>
            </div>
            
            <!-- Achats / Fournisseurs -->
            <div id="purchases-content" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Section Fournisseurs -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-2xl font-semibold text-gray-800">Fournisseurs</h2>
                             <button id="add-supplier-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Ajouter</button>
                        </div>
                        <div id="suppliers-list" class="space-y-3">
                            <div id="suppliers-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-lg">
                                <p>Aucun fournisseur ajouté.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Section Commandes Fournisseurs -->
                    <div>
                         <div class="flex justify-between items-center mb-4">
                             <h2 class="text-2xl font-semibold text-gray-800">Commandes Fournisseurs</h2>
                             <button id="add-purchase-order-btn" class="btn-primary"><i class="fas fa-plus mr-2"></i>Nouvelle Commande</button>
                        </div>
                        <div id="purchase-orders-list" class="space-y-3">
                            <div id="purchase-orders-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-lg">
                                <p>Aucune commande fournisseur.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ventes -->
            <div id="orders-content" class="tab-content">
                 <h2 class="text-2xl font-semibold text-gray-800 mb-4">Nouvelle Vente</h2>
                 <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                       <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg">
                           <h3 class="text-lg font-medium mb-4">Ajouter des produits à la vente</h3>
                           <form id="add-to-order-form" class="flex items-end gap-4">
                               <div class="flex-grow">
                                   <label for="order-product-select" class="block text-sm font-medium text-gray-700">Produit</label>
                                   <select id="order-product-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-800 focus:border-gray-800"></select>
                               </div>
                               <div>
                                   <label for="order-product-quantity" class="block text-sm font-medium text-gray-700">Quantité</label>
                                   <input type="number" id="order-product-quantity" value="1" min="1" class="mt-1 block w-24 p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-gray-800 focus:border-gray-800">
                               </div>
                               <button type="submit" class="bg-gray-800 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-900 h-10">Ajouter</button>
                           </form>
                       </div>
                       <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                           <h3 class="text-lg font-medium mb-4">Détail Vente</h3>
                           <div class="mb-4">
                               <label for="sale-date" class="block text-sm font-medium text-gray-700">Date de la vente</label>
                               <input type="date" id="sale-date" class="mt-1 block w-full input-style">
                           </div>
                           <ul id="current-order-list" class="space-y-2 mb-4">
                               <li id="order-placeholder" class="text-gray-500">La vente est vide.</li>
                           </ul>
                           <div class="border-t pt-4">
                               <div class="flex justify-between items-center">
                                   <label for="current-order-total-input" class="text-lg font-semibold text-gray-800">Total (Ajustable)</label>
                                   <div class="flex items-center">
                                       <input type="number" step="0.01" id="current-order-total-input" class="text-2xl font-bold text-gray-900 text-right w-40 input-style p-1" placeholder="0.00">
                                       <span class="text-xl font-bold text-gray-900 ml-2">Mad</span>
                                   </div>
                               </div>
                           </div>
                           <button id="process-order-btn" class="w-full mt-4 bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                               Valider & Déduire du Stock
                           </button>
                       </div>
                 </div>

                 <!-- Section Historique -->
                 <div class="mt-12">
                       <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                            <div class="flex items-center gap-4">
                                <h2 class="text-2xl font-semibold text-gray-800">Historique</h2>
                                <div class="flex items-center gap-2 bg-gray-100 p-2 rounded-lg shadow-sm">
                                    <input type="checkbox" id="select-all-orders" class="h-5 w-5 text-gray-800 rounded cursor-pointer border-gray-300 focus:ring-gray-800">
                                    <span class="text-sm font-medium text-gray-600">Tout</span>
                                    <button id="delete-selected-orders-btn" class="hidden bg-red-600 text-white text-xs font-bold px-3 py-2 rounded hover:bg-red-700 transition-colors flex items-center shadow-sm">
                                        <i class="fas fa-trash mr-1"></i> Supprimer (<span id="selected-count">0</span>)
                                    </button>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <label for="history-date-filter" class="text-sm font-medium text-gray-700">Filtrer par date :</label>
                                <input type="date" id="history-date-filter" class="input-style p-1 text-sm">
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                                <button id="declare-loss-btn" class="btn-secondary bg-yellow-400 hover:bg-yellow-500 text-yellow-900"><i class="fas fa-exclamation-triangle mr-2"></i>Déclarer une perte</button>
                                <button id="import-api-sales-btn" class="btn-secondary bg-blue-400 hover:bg-blue-500 text-blue-900"><i class="fas fa-cloud-download-alt mr-2"></i>Importer Ventes (API)</button>
                                <button id="import-orders-btn" class="btn-secondary"><i class="fas fa-upload mr-2"></i>Importer Ventes (CSV)</button>
                                <button id="export-orders-btn" class="btn-secondary"><i class="fas fa-download mr-2"></i>Exporter Ventes</button>
                            </div>
                        </div>
                       <!-- Ventes -->
                       <h3 class="text-xl font-semibold text-gray-700 mb-3">Ventes</h3>
                       <div id="order-history-list" class="space-y-4">
                           <div id="order-history-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-2xl shadow-lg">
                               <i class="fas fa-history fa-2x text-gray-400 mb-2"></i>
                               <p>Aucune vente dans l'historique.</p>
                           </div>
                       </div>
                       <!-- Pertes -->
                       <h3 class="text-xl font-semibold text-gray-700 mt-8 mb-3">Pertes</h3>
                       <div id="loss-history-list" class="space-y-4">
                           <div id="loss-history-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-2xl shadow-lg">
                               <i class="fas fa-box-open fa-2x text-gray-400 mb-2"></i>
                               <p>Aucune perte déclarée.</p>
                           </div>
                       </div>
                 </div>
            </div>

<div id="charges-content" class="tab-content">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ajouter une Charge</h2>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <form id="charge-form">
                    <div class="space-y-4">
                        <div>
                            <label for="charge-name" class="block text-sm font-medium text-gray-700">Nom de la Charge</label>
                            <input type="text" id="charge-name" placeholder="Ex: Loyer, Salaire, Electricité..." required class="mt-1 w-full input-style">
                        </div>
                        <div>
                            <label for="charge-amount" class="block text-sm font-medium text-gray-700">Montant (Mad)</label>
                            <input type="number" id="charge-amount" min="0" step="0.01" required class="mt-1 w-full input-style">
                        </div>
                        <div>
                            <label for="charge-date" class="block text-sm font-medium text-gray-700">Date de la Charge</label>
                            <input type="date" id="charge-date" required class="mt-1 w-full input-style">
                        </div>
                    </div>
                    <div class="mt-6">
                        <button type="submit" class="btn-primary w-full">Enregistrer la Charge</button>
                    </div>
                </form>
            </div>
        </div>

        <div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Historique des Charges</h2>
            <div id="charges-list" class="space-y-3">
                <div id="charges-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-2xl shadow-lg">
                    <i class="fas fa-file-invoice-dollar fa-2x text-gray-400 mb-2"></i>
                    <p>Aucune charge enregistrée.</p>
                </div>
                </div>
        </div>
    </div>
</div></div>
</main>

<!-- AJOUTEZ CETTE SECTION COMPLÈTE AVANT </main> -->
<div id="rh-content" class="tab-content">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Section Gestion des Salariés -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Gestion des Salariés</h2>
                <button id="add-employee-btn" class="btn-primary"><i class="fas fa-user-plus mr-2"></i>Ajouter</button>
            </div>
            <div id="employees-list" class="space-y-3">
                <div id="employees-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-2xl shadow-lg">
                    <i class="fas fa-users fa-2x text-gray-400 mb-2"></i>
                    <p>Aucun salarié enregistré.</p>
                </div>
            </div>
        </div>

        <!-- Section Paiement des Salaires -->
        <div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Paiement des Salaires</h2>
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                <div class="mb-4">
                    <label for="salary-month" class="block text-sm font-medium text-gray-700">Mois de paiement</label>
                    <input type="month" id="salary-month" class="mt-1 w-full input-style">
                </div>
                <button id="calculate-salaries-btn" class="btn-secondary w-full">
                    <i class="fas fa-calculator mr-2"></i>Calculer les salaires du mois
                </button>
            </div>

            <!-- Résultats de calcul -->
            <div id="salary-calculations" class="hidden bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Salaires à payer</h3>
                <div id="salary-results-list" class="space-y-3 mb-4"></div>
                <div class="border-t pt-4 flex justify-between items-center">
                    <span class="text-lg font-semibold text-gray-800">Total à payer :</span>
                    <span id="total-salary-amount" class="text-2xl font-bold text-red-600">0.00 Mad</span>
                </div>
                <button id="pay-all-salaries-btn" class="btn-primary w-full mt-4">
                    <i class="fas fa-money-bill-wave mr-2"></i>Payer tous les salaires
                </button>
            </div>
        </div>
    </div>

    <!-- Historique des paiements -->
    <div class="mt-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Historique des Paiements</h2>
        <div id="salary-payments-history" class="space-y-3">
            <div id="salary-payments-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-2xl shadow-lg">
                <i class="fas fa-file-invoice-dollar fa-2x text-gray-400 mb-2"></i>
                <p>Aucun paiement de salaire enregistré.</p>
            </div>
        </div>
    </div>
</div>
<!-- ONGLET FINANCE -->
<div id="finance-content" class="tab-content">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Section Déclaration Journalière -->
        <div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Déclaration Journalière</h2>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <form id="daily-payment-form">
                    <div class="space-y-4">
                        <div>
                            <label for="payment-date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="payment-date" required class="mt-1 w-full input-style">
                        </div>
                        <div>
                            <label for="tpe-amount" class="block text-sm font-medium text-gray-700">Montant TPE (Mad)</label>
                            <input type="number" id="tpe-amount" min="0" step="0.01" value="0" required class="mt-1 w-full input-style">
                        </div>
                        <div>
                            <label for="glovo-amount" class="block text-sm font-medium text-gray-700">Montant Glovo TPE (Mad)</label>
                            <input type="number" id="glovo-amount" min="0" step="0.01" value="0" required class="mt-1 w-full input-style">
                        </div>
                        <!-- ✅ NOUVEAU CHAMP AJOUTÉ -->
                        <div>
                            <label for="glovo-cash-amount" class="block text-sm font-medium text-gray-700">Montant Glovo Espèces (Mad)</label>
                            <input type="number" id="glovo-cash-amount" min="0" step="0.01" value="0" required class="mt-1 w-full input-style">
                        </div>
                    </div>
                    
                    <!-- Calcul Automatique -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Total ventes du jour :</span>
                                <span id="day-total-sales" class="font-semibold text-gray-900">0.00 Mad</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">TPE + Glovo :</span>
                                <span id="day-digital-payments" class="font-semibold text-blue-600">0.00 Mad</span>
                            </div>
                            <div class="flex justify-between border-t pt-2 mt-2">
                                <span class="text-gray-800 font-semibold">Espèces attendues en caisse :</span>
                                <span id="day-expected-cash" class="font-bold text-green-600 text-lg">0.00 Mad</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <button type="submit" class="btn-primary w-full">
                            <i class="fas fa-save mr-2"></i>Enregistrer la déclaration
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Section Historique -->
        <div>
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Historique des Déclarations</h2>
            <div id="daily-payments-list" class="space-y-3">
                <div id="daily-payments-placeholder" class="text-center py-10 text-gray-500 bg-white rounded-2xl shadow-lg">
                    <i class="fas fa-file-invoice fa-2x text-gray-400 mb-2"></i>
                    <p>Aucune déclaration enregistrée.</p>
                </div>
            </div>
        </div>
    </div>
</div>
</main>

        
    </div>

    <!-- Modals -->
    <div id="ingredient-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <h3 id="ingredient-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Ajouter un ingrédient</h3>
            <form id="ingredient-form">
                <input type="hidden" id="ingredient-id">
                <div class="space-y-4">
                    <div><label for="ingredient-name" class="block text-sm font-medium text-gray-700">Nom</label><input type="text" id="ingredient-name" required class="mt-1 w-full input-style"></div>
                    <div><label for="ingredient-quantity" class="block text-sm font-medium text-gray-700">Quantité</label><input type="number" id="ingredient-quantity" min="0" step="any" required class="mt-1 w-full input-style"></div>
                    <div><label for="ingredient-unit" class="block text-sm font-medium text-gray-700">Unité (kg, L, pièces...)</label><input type="text" id="ingredient-unit" required class="mt-1 w-full input-style"></div>
                    <div><label for="ingredient-cost" class="block text-sm font-medium text-gray-700">Coût par unité (Mad)</label><input type="number" id="ingredient-cost" min="0" step="any" placeholder="1.50" class="mt-1 w-full input-style"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-ingredient">Annuler</button><button type="submit" class="btn-primary">Sauvegarder</button></div>
            </form>
        </div>
    </div>
    
    <div id="product-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-2xl">
            <h3 id="product-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Créer un Produit</h3>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2"><label for="product-name" class="block text-sm font-medium text-gray-700">Nom du Produit</label><input type="text" id="product-name" required class="mt-1 w-full input-style"></div>
                    <div><label for="product-price" class="block text-sm font-medium text-gray-700">Prix de Vente (Mad)</label><input type="number" id="product-price" min="0" step="0.01" required class="mt-1 w-full input-style"></div>
                </div>
                <div class="mt-4"><label for="product-type" class="block text-sm font-medium text-gray-700">Type de produit</label>
                    <select id="product-type" class="mt-1 w-full input-style">
                        <option value="Entrée">Entrée</option>
                        <option value="Pizza">Pizza</option>
                        <option value="Dessert">Dessert</option>
                        <option value="Boisson">Boisson</option>
                        <option value="Autre">Autre</option>
                    </select>
                </div>
                <div id="recipe-section" class="mt-6">
                    <div class="flex justify-between items-center mb-2">
                         <h4 class="text-lg font-medium text-gray-800">Recette</h4>
                         <p class="text-sm font-semibold text-gray-600">Coût de revient: <span id="current-recipe-cost">0.00 Mad</span></p>
                    </div>
                    <div id="recipe-ingredients-list" class="space-y-2 mb-3"></div>
                    <div class="flex items-end gap-3"><div class="flex-grow"><label class="block text-sm font-medium">Ingrédient</label><select id="recipe-ingredient-select" class="mt-1 w-full input-style"></select></div><div><label class="block text-sm font-medium">Quantité</label><input type="number" id="recipe-quantity" min="0" step="any" class="mt-1 w-28 input-style"></div><button type="button" id="add-recipe-ingredient-btn" class="btn-secondary h-10">Ajouter</button></div>
                </div>
                
                <!-- MODIFICATION: Ajout champ quantité pour produits liés -->
                <div id="linked-ingredient-section" class="mt-6 hidden">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Article en Stock</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label for="linked-ingredient-select" class="block text-sm font-medium">Lier à l'article</label>
                            <select id="linked-ingredient-select" class="mt-1 w-full input-style"></select>
                        </div>
                        <div>
                            <label for="linked-ingredient-quantity" class="block text-sm font-medium">Quantité Consommée</label>
                            <input type="number" id="linked-ingredient-quantity" value="1" min="0" step="any" class="mt-1 w-full input-style">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Quantité de l'article en stock consommée par vente de 1 produit.</p>
                </div>
                <!-- FIN MODIFICATION -->

                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-product">Annuler</button><button type="submit" class="btn-primary">Sauvegarder Produit</button></div>
            </form>
        </div>
    </div>

    <div id="import-modal" class="modal fixed z-20 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <h3 id="import-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Importer un fichier CSV</h3>
            <div id="import-instructions" class="text-sm text-gray-600 bg-gray-100 p-3 rounded-lg mb-4"></div>
            <div><label for="csv-file-input" class="block text-sm font-medium text-gray-700">Choisir un fichier .csv</label><input type="file" id="csv-file-input" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100"/></div>
            <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-import">Annuler</button><button type="button" class="btn-primary" id="process-import-btn" disabled>Lancer l'importation</button></div>
        </div>
    </div>

    <!-- Modal Import API Sales (Updated for Proxy) -->
     <div id="api-import-modal" class="modal fixed z-20 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Importer Ventes via API</h3>
            <form id="api-import-form">
                <div class="space-y-4">
                    <div>
                        <label for="api-start-date" class="block text-sm font-medium text-gray-700">Date de début</label>
                        <input type="date" id="api-start-date" required class="mt-1 w-full input-style">
                    </div>
                    <div>
                        <label for="api-end-date" class="block text-sm font-medium text-gray-700">Date de fin</label>
                        <input type="date" id="api-end-date" required class="mt-1 w-full input-style">
                    </div>
                    <!-- Champ jeton supprimé -->
                     <div id="api-import-loader" class="hidden text-center py-4">
                        <div class="loader"></div>
                        <p class="text-sm text-gray-500 mt-2">Authentification et importation...</p>
                    </div>
                     <p id="api-import-status" class="text-sm text-center text-gray-600 mt-2"></p>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="btn-secondary" id="cancel-api-import">Annuler</button>
                    <button type="submit" class="btn-primary" id="process-api-import-btn">Lancer l'importation</button>
                </div>
            </form>
        </div>
    </div>

    <div id="supplier-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
            <h3 id="supplier-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Ajouter un Fournisseur</h3>
            <form id="supplier-form">
                <input type="hidden" id="supplier-id">
                <div class="space-y-4">
                    <div><label for="supplier-name" class="block text-sm font-medium">Nom</label><input type="text" id="supplier-name" required class="mt-1 w-full input-style"></div>
                    <div><label for="supplier-contact" class="block text-sm font-medium">Contact (email, tél...)</label><input type="text" id="supplier-contact" class="mt-1 w-full input-style"></div>
                </div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-supplier">Annuler</button><button type="submit" class="btn-primary">Sauvegarder</button></div>
            </form>
        </div>
    </div>

    <div id="purchase-order-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-2xl">
            <h3 id="po-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Nouvelle Commande Fournisseur</h3>
            <form id="purchase-order-form">
                <input type="hidden" id="po-id">
                <div><label for="po-supplier-select" class="block text-sm font-medium">Fournisseur</label><select id="po-supplier-select" required class="mt-1 w-full input-style"></select></div>
                <!-- Statut de Paiement -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">Statut de Paiement</label>
                    <div class="mt-2 flex gap-4">
                        <label class="flex items-center">
                            <input type="radio" name="po-payment-status" value="unpaid" class="h-4 w-4 text-gray-800 border-gray-300 focus:ring-gray-700" checked>
                            <span class="ml-2 text-sm text-gray-700">Non Payé</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="po-payment-status" value="paid" class="h-4 w-4 text-gray-800 border-gray-300 focus:ring-gray-700">
                            <span class="ml-2 text-sm text-gray-700">Payé</span>
                        </label>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="text-lg font-medium text-gray-800 mb-2">Articles</h4>
                    <!-- MODIFICATION ICI: La liste sera remplie par JS avec des inputs -->
                    <div id="po-items-list" class="space-y-2 mb-3">
                        <!-- Le contenu sera généré par renderCurrentPurchaseOrderItems -->
                    </div>
                    <!-- FIN MODIFICATION -->
                    <div class="grid grid-cols-1 md:grid-cols-4 items-end gap-3">
                        <div class="md:col-span-2"><label class="block text-sm font-medium">Ingrédient</label><select id="po-ingredient-select" class="mt-1 w-full input-style"></select></div>
                        <div><label class="block text-sm font-medium">Quantité</label><input type="number" id="po-quantity" min="0" step="any" class="mt-1 w-full input-style"></div>
                        <div><label class="block text-sm font-medium">Prix/Unité (Mad)</label><input type="number" id="po-price" min="0" step="any" class="mt-1 w-full input-style"></div>
                    </div>
                     <button type="button" id="add-po-item-btn" class="btn-secondary h-10 w-full mt-3">Ajouter à la commande</button>
                </div>
                <div class="border-t pt-4 mt-4">
                    <div class="flex justify-between items-center">
                        <label for="po-total-cost-input" class="text-lg font-semibold text-gray-800">Total Commande (Ajustable)</label>
                         <div class="flex items-center">
                            <input type="number" step="0.01" id="po-total-cost-input" class="text-2xl font-bold text-gray-900 text-right w-48 input-style p-1" placeholder="0.00">
                             <span class="text-xl font-bold text-gray-900 ml-2">Mad</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4"><label for="po-invoice-file" class="block text-sm font-medium text-gray-700">Facture (Optionnel)</label><input type="file" id="po-invoice-file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100"/></div>
                <div class="mt-6 flex justify-end space-x-3"><button type="button" class="btn-secondary" id="cancel-purchase-order">Annuler</button><button type="submit" class="btn-primary">Enregistrer Commande</button></div>
            </form>
        </div>
    </div>

    <div id="loss-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Déclarer une Perte</h3>
            <form id="loss-form">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Type de perte</label>
                        <div class="mt-2 flex gap-4">
                            <label class="flex items-center"><input type="radio" name="loss-type" value="product" class="h-4 w-4 text-gray-800 border-gray-300 focus:ring-gray-700" checked>&nbsp;Produit Fini</label>
                            <label class="flex items-center"><input type="radio" name="loss-type" value="ingredient" class="h-4 w-4 text-gray-800 border-gray-300 focus:ring-gray-700">&nbsp;Ingrédient Brut</label>
                        </div>
                    </div>
                    
                    <div id="loss-product-section">
                        <label for="loss-product-select" class="block text-sm font-medium text-gray-700">Produit</label>
                        <select id="loss-product-select" required class="mt-1 w-full input-style"></select>
                    </div>
                    <div id="loss-ingredient-section" class="hidden">
                         <label for="loss-ingredient-select" class="block text-sm font-medium text-gray-700">Ingrédient</label>
                        <select id="loss-ingredient-select" class="mt-1 w-full input-style"></select>
                    </div>
                     <div>
                        <label for="loss-quantity" class="block text-sm font-medium text-gray-700">Quantité Perdue</label>
                        <input type="number" id="loss-quantity" min="0" step="any" required class="mt-1 w-full input-style">
                    </div>
                     <div>
                        <label for="loss-reason" class="block text-sm font-medium text-gray-700">Raison / Note (optionnel)</label>
                        <textarea id="loss-reason" rows="3" class="mt-1 w-full input-style"></textarea>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" class="btn-secondary" id="cancel-loss">Annuler</button>
                    <button type="submit" class="btn-primary bg-yellow-500 hover:bg-yellow-600">Confirmer la Perte</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-5 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>
<div id="employee-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
        <h3 id="employee-modal-title" class="text-xl font-semibold mb-4 text-gray-800">Ajouter un Salarié</h3>
        <form id="employee-form">
            <input type="hidden" id="employee-id">
            <div class="space-y-4">
                <div>
                    <label for="employee-name" class="block text-sm font-medium text-gray-700">Nom complet</label>
                    <input type="text" id="employee-name" required class="mt-1 w-full input-style">
                </div>
                <div>
                    <label for="employee-salary" class="block text-sm font-medium text-gray-700">Salaire mensuel (Mad)</label>
                    <input type="number" id="employee-salary" min="0" step="0.01" required class="mt-1 w-full input-style">
                </div>
                <div>
                    <label for="employee-start-date" class="block text-sm font-medium text-gray-700">Date d'embauche</label>
                    <input type="date" id="employee-start-date" required class="mt-1 w-full input-style">
                </div>
                <div>
                    <label for="employee-active" class="flex items-center">
                        <input type="checkbox" id="employee-active" checked class="h-4 w-4 text-gray-800 border-gray-300 rounded focus:ring-gray-700">
                        <span class="ml-2 text-sm text-gray-700">Actif</span>
                    </label>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" class="btn-secondary" id="cancel-employee">Annuler</button>
                <button type="submit" class="btn-primary">Sauvegarder</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Absences -->
<div id="absences-modal" class="modal fixed z-10 inset-0 overflow-y-auto bg-black bg-opacity-50 items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Gérer les Absences</h3>
        <p class="text-sm text-gray-600 mb-4">Salarié: <span id="absence-employee-name" class="font-semibold"></span></p>
        
        <form id="absence-form" class="mb-6">
            <input type="hidden" id="absence-employee-id">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label for="absence-month" class="block text-sm font-medium text-gray-700">Mois</label>
                    <input type="month" id="absence-month" required class="mt-1 w-full input-style">
                </div>
                <div>
                    <label for="absence-days" class="block text-sm font-medium text-gray-700">Jours d'absence</label>
                    <input type="number" id="absence-days" min="0" max="26" step="0.5" required class="mt-1 w-full input-style">
                </div>
            </div>
            <button type="submit" class="btn-primary w-full mt-4">Enregistrer l'absence</button>
        </form>

        <div class="border-t pt-4">
            <h4 class="font-semibold text-gray-800 mb-3">Historique des absences</h4>
            <div id="absences-list" class="space-y-2 max-h-60 overflow-y-auto">
                <p class="text-sm text-gray-500 text-center py-4">Aucune absence enregistrée.</p>
            </div>
        </div>

        <div class="mt-6 flex justify-end">
            <button type="button" class="btn-secondary" id="cancel-absences">Fermer</button>
        </div>
    </div>
</div>

<!-- CSS Additionnel -->
    <!-- CSS Additionnel -->
    <style>
        .tab-link { @apply whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300 transition-colors; }
    </style>

    <script type="module">
        // --- IMPORTS FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc, serverTimestamp, writeBatch, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURATION ---
        const firebaseConfigFromUser = {
            apiKey: "AIzaSyCzUX90zSN2zG9O97g7TNyTmTSNte9OT-E",
            authDomain: "solopro-6521a.firebaseapp.com",
            projectId: "solopro-6521a",
            storageBucket: "solopro-6521a.appspot.com",
            messagingSenderId: "126450282941",
            appId: "1:126450282941:web:10e5255e6ee7c75fa8e2d4"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigFromUser;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pizzeria-pro';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
        
        // --- URL du Proxy ---
        // !!! REMPLACEZ PAR L'URL RÉELLE DE VOTRE PROXY DÉPLOYÉ SUR RENDER !!!
        // Par exemple: "https://solo-proxy.onrender.com"
        const PROXY_URL = "https://solo-proxy.onrender.com"; // <= MODIFIEZ CETTE LIGNE

        // --- VARIABLES FIREBASE (initialisées après authentification) ---
        let app, auth, db, storage;

        // --- COLLECTIONS REFS ---
        let ingredientsCol, productsCol, ordersCol, suppliersCol, purchaseOrdersCol, lossesCol,chargesCol;
		let employeesCol, absencesCol, salaryPaymentsCol;
		let dailyPaymentsCol;
        // --- ETAT GLOBAL ---
        let allIngredients = [];
        let allProducts = [];
        let orderHistory = [];
        let allSuppliers = [];
        let allLosses = [];
        let allPurchaseOrders = [];
		let allCharges = [];
		let allEmployees = []; // AJOUTEZ CETTE LIGNE
let allAbsences = []; // AJOUTEZ CETTE LIGNE
let allSalaryPayments = []; // AJOUTEZ CETTE LIGNE
let allDailyPayments = [];
        let currentRecipe = [];
        let currentOrder = [];
        let currentPurchaseOrderItems = [];
        let importType = '';
		let currentSalaryCalculations = []; // AJOUTEZ CETTE LIGNE

        // --- SEUILS ---
        const LOW_STOCK_THRESHOLD = 10;
        
        // --- INITIALISATION FIREBASE (après authentification) ---
        function initFirebase() {
            if (!app) {
                try {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    // Initialiser Firestore avec une configuration pour éviter les erreurs CORS
                    db = getFirestore(app);
                    storage = getStorage(app);
                } catch (error) {
                    console.error("Erreur lors de l'initialisation Firebase:", error);
                    alert("Erreur de connexion à Firebase. Vérifiez que votre domaine est autorisé dans Firebase Console.");
                    return;
                }
            }
            initFirebaseAuth();
        }

        // --- AUTHENTIFICATION FIREBASE ---
        function initFirebaseAuth() {
            if (!auth) return;
            
            onAuthStateChanged(auth, async (user) => {
            if (user) {
                ingredientsCol = collection(db, `artifacts/${appId}/public/data/ingredients`);
                productsCol = collection(db, `artifacts/${appId}/public/data/products`);
                ordersCol = collection(db, `artifacts/${appId}/public/data/orders`);
                suppliersCol = collection(db, `artifacts/${appId}/public/data/suppliers`);
                purchaseOrdersCol = collection(db, `artifacts/${appId}/public/data/purchaseOrders`);
                lossesCol = collection(db, `artifacts/${appId}/public/data/losses`);
				chargesCol = collection(db, `artifacts/${appId}/public/data/charges`); // <-- AJOUTEZ CETTE LIGNE
				        employeesCol = collection(db, `artifacts/${appId}/public/data/employees`);
        absencesCol = collection(db, `artifacts/${appId}/public/data/absences`);
        salaryPaymentsCol = collection(db, `artifacts/${appId}/public/data/salaryPayments`);
		dailyPaymentsCol = collection(db, `artifacts/${appId}/public/data/dailyPayments`);
                listenToAllCollections();
				document.getElementById('payment-date').value = getTodayDateString();
                document.getElementById('sale-date').value = getTodayDateString();
                 // Set default dates for API import modal
                document.getElementById('api-start-date').value = getTodayDateString();
                document.getElementById('api-end-date').value = getTodayDateString();
				document.getElementById('charge-date').value = getTodayDateString();
            } else {
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (error) { console.error("Auth failed:", error); }
            }
        });
        }

        // --- INITIALISER FIREBASE APRÈS AUTHENTIFICATION APP ---
        // Cette fonction sera appelée après l'authentification réussie
        window.initAppAfterAuth = function() {
            initFirebase();
        };
        
        function listenToAllCollections() {
            onSnapshot(suppliersCol, snapshot => { allSuppliers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderSuppliers(); populateSupplierSelects(); });
            onSnapshot(purchaseOrdersCol, snapshot => { allPurchaseOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); allPurchaseOrders.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); renderPurchaseOrders(allPurchaseOrders); updateAndRenderKPIs(); });
            onSnapshot(ingredientsCol, snapshot => { allIngredients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); allIngredients.sort((a,b) => a.name.localeCompare(b.name)); renderIngredients(); updateAndRenderKPIs(); populateIngredientSelects(); renderProducts(); });
            onSnapshot(productsCol, snapshot => { allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); allProducts.sort((a,b) => a.name.localeCompare(b.name)); renderProducts(); populateProductSelects(); updateAndRenderKPIs(); });
            onSnapshot(ordersCol, snapshot => { orderHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); orderHistory.sort((a, b) => (b.saleDate?.seconds || b.createdAt?.seconds || 0) - (a.saleDate?.seconds || a.createdAt?.seconds || 0)); renderOrderHistory(orderHistory); updateAndRenderKPIs(); });
            onSnapshot(lossesCol, snapshot => { allLosses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); allLosses.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); renderLossHistory(); updateAndRenderKPIs(); });onSnapshot(chargesCol, snapshot => {
    allCharges = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    // Trier par date de charge, la plus récente en premier
    allCharges.sort((a, b) => (toDate(b.date)?.getTime() || 0) - (toDate(a.date)?.getTime() || 0));
    renderCharges(allCharges); // Nous allons créer cette fonction
    updateAndRenderKPIs();
});
onSnapshot(employeesCol, snapshot => {
        allEmployees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        allEmployees.sort((a, b) => a.name.localeCompare(b.name));
        renderEmployees();
    });
    
    onSnapshot(absencesCol, snapshot => {
        allAbsences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    });
    
    onSnapshot(salaryPaymentsCol, snapshot => {
        allSalaryPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        allSalaryPayments.sort((a, b) => (toDate(b.paymentDate)?.getTime() || 0) - (toDate(a.paymentDate)?.getTime() || 0));
        renderSalaryPaymentsHistory();
    });
	onSnapshot(dailyPaymentsCol, snapshot => {
    allDailyPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    allDailyPayments.sort((a, b) => (toDate(b.date)?.getTime() || 0) - (toDate(a.date)?.getTime() || 0));
    renderDailyPayments();
});
        }
        
        // --- HELPERS ---
        const showToast = (message) => { const toast = document.getElementById('toast'); document.getElementById('toast-message').textContent = message; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 3000); };
        const openModal = (id) => document.getElementById(id).classList.add('flex');
        const closeModal = (id) => document.getElementById(id).classList.remove('flex');
        
        const getTodayDateString = () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

		const formatDateToDDMMYYYY = (date) => {
		            if (!date) return 'Date inconnue';
		            const d = date.seconds ? new Date(date.seconds * 1000) : date;
		            if (isNaN(d.getTime())) return 'Date invalide';
		            const day = String(d.getDate()).padStart(2, '0');
		            const month = String(d.getMonth() + 1).padStart(2, '0');
		            const year = d.getFullYear();
					// Ajout de l'heure et des minutes
		            const hours = String(d.getHours()).padStart(2, '0');
		            const minutes = String(d.getMinutes()).padStart(2, '0');
		            return `${day}/${month}/${year} à ${hours}h${minutes}`;
		        };

        const toDate = (timestamp) => {
            if (!timestamp) return null;
            return timestamp.seconds ? new Date(timestamp.seconds * 1000) : timestamp;
        };

        // --- NAVIGATION ---
        document.querySelectorAll('.tab-link').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active')); tab.classList.add('active'); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`${tab.dataset.tab}-content`).classList.add('active'); }); });
        
        // --- RENDERING & KPIs ---
        const updateAndRenderKPIs = (startDate, endDate, label = "Période : Tout le temps") => {
             // Update filter label
            document.getElementById('kpi-filter-label').textContent = label;

             // Filter data based on date range if provided
            const filteredOrders = !startDate ? orderHistory : orderHistory.filter(o => {
                const orderDate = toDate(o.saleDate || o.createdAt);
                return orderDate && orderDate >= startDate && orderDate <= endDate;
            });

            const filteredPurchases = !startDate ? allPurchaseOrders.filter(p => p.status === 'received') : allPurchaseOrders.filter(p => {
                const receivedDate = toDate(p.receivedAt);
                return p.status === 'received' && receivedDate && receivedDate >= startDate && receivedDate <= endDate;
            });
            
            // *** NEW: Filter for unpaid *and* received purchases ***
            // Filter by received date, but check paymentStatus
            const filteredUnpaidPurchases = !startDate 
                ? allPurchaseOrders.filter(p => p.status === 'received' && p.paymentStatus !== 'paid')
                : allPurchaseOrders.filter(p => {
                    // Filter based on *received* date for "Achats" period
                    const receivedDate = toDate(p.receivedAt); 
                    return p.status === 'received' && 
                           p.paymentStatus !== 'paid' &&
                           receivedDate && 
                           receivedDate >= startDate && 
                           receivedDate <= endDate;
                });
            // *** END NEW ***


            const filteredLosses = !startDate ? allLosses : allLosses.filter(l => {
                const lossDate = toDate(l.createdAt);
                return lossDate && lossDate >= startDate && lossDate <= endDate;
            });
            const filteredCharges = !startDate ? allCharges : allCharges.filter(c => {
    const chargeDate = toDate(c.date || c.createdAt);
    return chargeDate && chargeDate >= startDate && chargeDate <= endDate;
});
            // --- KPI Calculations ---
            const totalSales = filteredOrders.reduce((sum, order) => sum + order.totalPrice, 0);
            const totalPurchases = filteredPurchases.reduce((sum, po) => sum + (po.totalCost || 0), 0); // This is total *received* purchases
            // *** NEW: Calculate total unpaid purchases (from the *received* ones in the period) ***
            const totalUnpaidPurchases = filteredUnpaidPurchases.reduce((sum, po) => sum + (po.totalCost || 0), 0);
            // *** END NEW ***
            const totalOrders = filteredOrders.length;
            const totalLossesValue = filteredLosses.reduce((sum, loss) => {
                let lossCost = 0;
                if (loss.type === 'product') {
                    const product = allProducts.find(p => p.id === loss.itemId);
                    if (product) lossCost = calculateProductCost(product) * loss.quantity;
                } else {
                    const ingredient = allIngredients.find(i => i.id === loss.itemId);
                    if (ingredient) lossCost = (ingredient.cost || 0) * loss.quantity;
                }
                return sum + lossCost;
            }, 0);
			let totalCogs = 0; // "Cost of Goods Sold" (Coût des Marchandises Vendues)
filteredOrders.forEach(order => {
    order.items.forEach(item => {
        const product = allProducts.find(p => p.id === item.id);
        if (product) {
            // On utilise la fonction qui calcule le coût de revient d'UN produit
            const productCost = calculateProductCost(product);
            // On le multiplie par la quantité vendue et on l'ajoute au total
            totalCogs += productCost * item.quantity;
        }
    });
});
			const totalPizzasSold = filteredOrders.reduce((pizzaCount, order) => {
    // Parcourir chaque article de la commande
    order.items.forEach(item => {
        // Trouver le type de produit correspondant
        const product = allProducts.find(p => p.id === item.id);
        // Si le produit existe et que son type est 'Pizza'
        if (product && product.type === 'Pizza') {
            // Ajouter la quantité vendue au total
            pizzaCount += item.quantity;
        }
    });
    return pizzaCount;
}, 0);// 1. Marge Brute (Mad)
const grossMargin = totalSales - totalCogs;

// 2. Taux de Marge Brute (%)
// On vérifie si totalSales > 0 pour éviter une division par zéro
const grossMarginRate = totalSales > 0 ? (grossMargin / totalSales) * 100 : 0;

// 3. Panier Moyen (Mad)
// On vérifie si totalOrders > 0
const avgOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

// 4. Taux de Perte (%)
// On vérifie si totalSales > 0
const lossRate = totalSales > 0 ? (totalLossesValue / totalSales) * 100 : 0;
const totalCharges = filteredCharges.reduce((sum, charge) => sum + charge.amount, 0);
const netProfit = grossMargin - totalCharges;


// ^ ^ ^ **FIN DES 4 CALCULS** ^ ^ ^
            // --- Update KPI DOM ---
            document.getElementById('kpi-total-sales').textContent = `${totalSales.toFixed(2)} Mad`;
            document.getElementById('kpi-total-purchases').textContent = `${totalPurchases.toFixed(2)} Mad`;
            document.getElementById('kpi-unpaid-purchases').textContent = `${totalUnpaidPurchases.toFixed(2)} Mad`; // *** NEW ***
            document.getElementById('kpi-total-losses').textContent = `${totalLossesValue.toFixed(2)} Mad`;
            document.getElementById('kpi-total-orders').textContent = totalOrders;
document.getElementById('kpi-total-pizzas').textContent = totalPizzasSold;
			document.getElementById('kpi-avg-order-value').textContent = `${avgOrderValue.toFixed(2)} Mad`;
document.getElementById('kpi-loss-rate').textContent = `${lossRate.toFixed(1)} %`;
document.getElementById('kpi-gross-margin').textContent = `${grossMargin.toFixed(2)} Mad`;
document.getElementById('kpi-gross-margin-rate').textContent = `${grossMarginRate.toFixed(1)} %`;
document.getElementById('kpi-total-charges').textContent = `${totalCharges.toFixed(2)} Mad`;
document.getElementById('kpi-net-profit').textContent = `${netProfit.toFixed(2)} Mad`;
  // --- TOP 5 PIZZAS ET BOISSONS ---
            const topPizzas = calculateTop5(filteredOrders, 'Pizza');
            const topDrinks = calculateTop5(filteredOrders, 'Boisson');

            renderTopProducts(topPizzas, 'top-pizzas-list', 'Aucune pizza vendue dans cette période');
            renderTopProducts(topDrinks, 'top-drinks-list', 'Aucune boisson vendue dans cette période');
            // --- Low Stock Alerts (unfiltered) ---
            const container = document.getElementById('low-stock-alerts');
            const placeholder = document.getElementById('low-stock-placeholder');
            container.innerHTML = '';
            const lowStockItems = allIngredients.filter(ing => ing.quantity < LOW_STOCK_THRESHOLD);
            if (lowStockItems.length === 0) {
                container.innerHTML = '';
                container.appendChild(placeholder);
            } else {
                lowStockItems.forEach(item => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow';
                    alertDiv.innerHTML = `<p class="font-bold">${item.name}</p><p>Stock restant: ${item.quantity} ${item.unit}</p>`;
                    container.appendChild(alertDiv);
                });
            }
        };

        const renderIngredients = () => { const list = document.getElementById('ingredients-list'); const placeholder = document.getElementById('ingredients-placeholder'); const table = document.getElementById('ingredients-table'); list.innerHTML = ''; if(allIngredients.length === 0) { table.style.display = 'none'; placeholder.style.display = 'block'; } else { table.style.display = ''; placeholder.style.display = 'none'; allIngredients.forEach(ing => { const isLow = ing.quantity < LOW_STOCK_THRESHOLD; const row = document.createElement('tr'); row.className = isLow ? 'low-stock' : ''; const costDisplay = (ing.cost && ing.cost > 0) ? `${ing.cost.toFixed(2)} Mad` : 'N/A'; row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${ing.name}</td><td class="px-6 py-4 whitespace-nowrap"><span class="${isLow ? 'low-stock-text' : ''}">${ing.quantity}</span> <span class="text-gray-500">${ing.unit}</span></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${costDisplay}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><button data-id="${ing.id}" class="edit-ingredient-btn text-gray-600 hover:text-gray-900 mr-4">Modifier</button><button data-id="${ing.id}" class="delete-ingredient-btn text-red-600 hover:text-red-900">Supprimer</button></td>`; list.appendChild(row); }); } };
            // --- TOP 5 FUNCTIONS ---
        const calculateTop5 = (orders, productType) => {
            const productCounts = {};
            
            orders.forEach(order => {
                order.items.forEach(item => {
                    const product = allProducts.find(p => p.id === item.id);
                    if (product && product.type === productType) {
                        if (!productCounts[item.id]) {
                            productCounts[item.id] = {
                                name: item.name,
                                count: 0,
                                revenue: 0
                            };
                        }
                        productCounts[item.id].count += item.quantity;
                        productCounts[item.id].revenue += item.quantity * item.price;
                    }
                });
            });
            
            const sorted = Object.values(productCounts)
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);
            
            return sorted;
        };

        const renderTopProducts = (topProducts, containerId, emptyMessage) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (topProducts.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">${emptyMessage}</p>`;
                return;
            }
            
            topProducts.forEach((product, index) => {
                const rankColors = ['bg-yellow-400', 'bg-gray-300', 'bg-orange-400', 'bg-blue-100', 'bg-blue-100'];
                const rankColor = rankColors[index] || 'bg-gray-100';
                
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors';
                item.innerHTML = `
                    <div class="flex items-center gap-3 flex-grow">
                        <span class="flex items-center justify-center w-8 h-8 rounded-full ${rankColor} font-bold text-gray-800">
                            ${index + 1}
                        </span>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-900">${product.name}</p>
                            <p class="text-sm text-gray-500">${product.revenue.toFixed(2)} Mad</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-2xl font-bold text-gray-800">${product.count}</p>
                        <p class="text-xs text-gray-500">vendus</p>
                    </div>
                `;
                container.appendChild(item);
            });
        };
        const calculateProductCost = (product) => {
            if (!product) return 0;
            if (product.recipe && product.recipe.length > 0) {
                return product.recipe.reduce((total, recipeItem) => {
                    const ingredient = allIngredients.find(ing => ing.id === recipeItem.id);
                    const ingredientCost = ingredient ? (ingredient.cost || 0) : 0;
                    return total + (ingredientCost * recipeItem.quantity);
                }, 0);
            } else if (product.linkedIngredientId) {
                const linkedIngredient = allIngredients.find(i => i.id === product.linkedIngredientId);
                return linkedIngredient ? (linkedIngredient.cost || 0) : 0;
            }
            return 0;
        };

        const renderProducts = () => { const container = document.getElementById('products-list'); const placeholder = document.getElementById('products-placeholder'); container.innerHTML = ''; if(allProducts.length === 0) { container.innerHTML = ''; container.appendChild(placeholder); } else { allProducts.forEach(product => { const card = document.createElement('div'); card.className = 'bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col justify-between'; const typeIcon = { Entrée: '<i class="fas fa-concierge-bell"></i>', Pizza: '<i class="fas fa-pizza-slice"></i>', Boisson: '<i class="fas fa-wine-bottle"></i>', Dessert: '<i class="fas fa-ice-cream"></i>', Autre: '<i class="fas fa-box"></i>' }; 
        
        let contentHtml = '';
        if (product.recipe && product.recipe.length > 0) {
            let recipeHtml = product.recipe.map(r => {
                const ingredientDetails = allIngredients.find(ing => ing.id === r.id);
                let costHtml = '';
                if (ingredientDetails && ingredientDetails.cost > 0) {
                    const itemCost = r.quantity * ingredientDetails.cost;
                    costHtml = `<span class="font-semibold text-gray-600">${itemCost.toFixed(2)} Mad</span>`;
                }
                return `<li class="flex justify-between items-center">
                            <span>- ${r.quantity} ${r.unit} ${r.name}</span>
                            ${costHtml}
                        </li>`;
            }).join('');

            contentHtml = `<div class="mt-2">
                                <h4 class="font-semibold text-sm text-gray-600">Recette:</h4>
                                <ul class="text-gray-500 text-sm space-y-1 mt-1">${recipeHtml}</ul>
                            </div>`;

        } else if (product.linkedIngredientId) {
            const linkedIngredient = allIngredients.find(i => i.id === product.linkedIngredientId);
            contentHtml = `<div class="mt-2"><h4 class="font-semibold text-sm text-gray-600">Article en stock:</h4><p class="text-gray-500 text-sm">${linkedIngredient ? linkedIngredient.name : 'Non lié'}</p></div>`;
        }
        
        const productCost = calculateProductCost(product); card.innerHTML = `<div class="p-6"><div class="flex justify-between items-start"><div><h3 class="text-xl font-bold text-gray-900">${product.name}</h3><p class="text-gray-500 text-xs">Coût de revient: ${productCost.toFixed(2)} Mad</p></div><span class="text-gray-400 text-xl">${typeIcon[product.type]}</span></div><div class="flex-grow">${contentHtml}</div><p class="text-gray-800 font-bold text-2xl text-right mt-4">${product.price.toFixed(2)} Mad</p></div><div class="bg-gray-50 px-6 py-3 flex justify-end gap-3"><button data-id="${product.id}" class="edit-product-btn text-gray-600 hover:text-gray-900 font-medium">Modifier</button><button data-id="${product.id}" class="delete-product-btn text-red-600 hover:text-red-900 font-medium">Supprimer</button></div>`; container.appendChild(card); }); } };
const renderOrderHistory = (history) => { 
            const container = document.getElementById('order-history-list'); 
            const placeholder = document.getElementById('order-history-placeholder'); 
            
            // Réinitialiser le bouton de suppression massive à chaque affichage
            const selectAllCheckbox = document.getElementById('select-all-orders');
            const deleteBtn = document.getElementById('delete-selected-orders-btn');
            if(selectAllCheckbox) selectAllCheckbox.checked = false;
            if(deleteBtn) deleteBtn.classList.add('hidden');

            container.innerHTML = ''; 
            
            if (history.length === 0) { 
                container.appendChild(placeholder); 
            } else { 
                history.forEach(order => { 
                    const card = document.createElement('div'); 
                    card.className = 'bg-white p-4 rounded-xl shadow-md border-l-4 border-gray-800 transition-all hover:shadow-lg'; 
                    const displayDate = formatDateToDDMMYYYY(order.saleDate || order.createdAt); 
                    
                    const itemsHtml = order.items.map(item => {
                        const refundTag = (item.returned && item.returned > 0) ? `<span class="text-red-600 font-semibold ml-2">(remb)</span>` : '';
                        return `<li>${item.quantity} x ${item.name}${refundTag}</li>`;
                    }).join(''); 
                    
                    const billNoHtml = order.billNo ? `<p class="text-xs text-gray-500 font-mono">Facture API: ${order.billNo}</p>` : '';
                    const discountTagHtml = order.hadDiscount ? `<span class="inline-block bg-yellow-100 text-yellow-800 text-xs font-semibold ml-2 px-2 py-0.5 rounded-full">Rabais</span>` : '';
                    
                    card.innerHTML = `
                    <div class="flex gap-4">
                        <div class="flex flex-col justify-center border-r pr-3 border-gray-100">
                            <input type="checkbox" class="order-checkbox h-5 w-5 text-gray-800 rounded cursor-pointer border-gray-300 focus:ring-gray-800" value="${order.id}">
                        </div>

                        <div class="flex-grow flex justify-between items-start">
                            <div>
                                <p class="font-bold text-gray-700">Vente du ${displayDate}</p>
                                <div class="flex items-center mt-1 gap-2">
                                    ${billNoHtml}
                                    ${discountTagHtml} 
                                </div>
                                <ul class="list-disc list-inside text-sm text-gray-600 mt-2">${itemsHtml}</ul>
                            </div>
                            <div class="flex items-center gap-4 text-right">
                                <p class="font-bold text-lg text-gray-800">${order.totalPrice.toFixed(2)} Mad</p>
                                <button data-id="${order.id}" class="delete-order-btn text-gray-400 hover:text-red-600 transition-colors p-2" title="Supprimer cette vente">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>`; 
                    
                    container.appendChild(card);
                }); 
            } 
        };
        const renderSuppliers = () => { const container = document.getElementById('suppliers-list'); const placeholder = document.getElementById('suppliers-placeholder'); container.innerHTML = ''; if (allSuppliers.length === 0) { container.innerHTML = ''; container.appendChild(placeholder); } else { allSuppliers.forEach(sup => { const div = document.createElement('div'); div.className = "bg-white p-3 rounded-lg shadow-sm flex justify-between items-center"; div.innerHTML = `<div><p class="font-semibold">${sup.name}</p><p class="text-sm text-gray-500">${sup.contact || ''}</p></div><div><button data-id="${sup.id}" class="edit-supplier-btn text-gray-400 hover:text-gray-800 mr-2"><i class="fas fa-edit"></i></button><button data-id="${sup.id}" class="delete-supplier-btn text-gray-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div>`; container.appendChild(div); }); } };
        const renderPurchaseOrders = (purchaseOrders) => { 
            const container = document.getElementById('purchase-orders-list'); 
            const placeholder = document.getElementById('purchase-orders-placeholder'); 
            container.innerHTML = ''; 
            if (purchaseOrders.length === 0) { 
                container.innerHTML = ''; 
                container.appendChild(placeholder); 
            } else { 
                purchaseOrders.forEach(po => { 
                    const supplier = allSuppliers.find(s => s.id === po.supplierId); 
                    const div = document.createElement('div'); 
                    const isReceived = po.status === 'received'; 
                    // *** NEW: Check payment status ***
                    const isPaid = po.paymentStatus === 'paid';
                    // *** END NEW ***
                    div.className = `bg-white p-3 rounded-lg shadow-sm`; 
                    // Display price per unit in the list
                    const itemsHtml = po.items.map(i => `<li>${i.quantity} ${i.unit} - ${i.name} (${(i.price || 0).toFixed(2)} Mad/unité)</li>`).join(''); 
                    // Use the saved totalCost, which might be the manually adjusted one
                    const totalDisplay = `<p class="font-bold text-lg text-gray-800">${(po.totalCost || 0).toFixed(2)} Mad</p>`; 
                    
                    // *** NEW: Actions logic updated ***
                    const actionsHtml = `
                    <div class="flex justify-between items-center mt-3 pt-3 border-t">
                        <div>
                            <button data-id="${po.id}" class="reorder-po-btn text-blue-500 hover:text-blue-800 text-sm font-medium mr-3"><i class="fas fa-redo mr-1"></i> Relancer</button>
                            <button data-id="${po.id}" class="edit-po-btn text-gray-500 hover:text-gray-800 text-sm font-medium mr-3"><i class="fas fa-edit mr-1"></i> Modifier</button>
                            ${!isReceived ? `<button data-id="${po.id}" class="delete-po-btn text-red-500 hover:text-red-800 text-sm font-medium"><i class="fas fa-trash mr-1"></i> Supprimer</button>` : ''}
                        </div>
                        <div class="flex gap-2">
                            ${!isPaid ? `<button data-id="${po.id}" class="pay-po-btn btn-secondary bg-green-100 hover:bg-green-200 text-green-800 text-sm py-1 px-3"><i class="fas fa-check mr-1"></i> Marquer Payé</button>` : ''}
                            ${!isReceived ? `<button data-id="${po.id}" class="receive-po-btn btn-primary text-sm py-1 px-3">Réceptionner</button>` : ''}
                        </div>
                    </div>`; 
                    // *** END NEW ***
                    
                    // *** NEW: Payment status tag added ***
                    const paymentTag = `<span class="text-xs font-bold py-1 px-2 rounded-full ${isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${isPaid ? 'Payé' : 'Non Payé'}</span>`;
                    // *** END NEW ***

                    div.innerHTML = `<div class="p-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-gray-800">${supplier ? supplier.name : 'Fournisseur inconnu'}</p>
                                <p class="text-xs text-gray-500">${formatDateToDDMMYYYY(po.createdAt)}</p>
                                <ul class="text-sm mt-2 list-disc list-inside">${itemsHtml}</ul>
                            </div>
                            <div class="text-right">
                                <div class="flex flex-col items-end gap-1">
                                    <span class="text-xs font-bold py-1 px-2 rounded-full ${isReceived ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${isReceived ? 'Reçue' : 'En attente'}</span>
                                    ${paymentTag} <!-- NEW TAG ADDED -->
                                </div>
                                ${isReceived ? `<p class="text-xs text-gray-500 mt-1">Reçue le ${formatDateToDDMMYYYY(po.receivedAt)}</p>` : ''}
                                ${totalDisplay} 
                                ${po.invoiceUrl ? `<a href="${po.invoiceUrl}" target="_blank" class="block text-sm text-gray-600 hover:text-gray-900 mt-2"><i class="fas fa-file-invoice"></i> Facture</a>` : ''}
                            </div>
                        </div>
                    </div>${actionsHtml}`; 
                    container.appendChild(div); 
                }); 
            } 
        };
        const renderLossHistory = () => { const container = document.getElementById('loss-history-list'); const placeholder = document.getElementById('loss-history-placeholder'); container.innerHTML = ''; if (allLosses.length === 0) { container.innerHTML = ''; container.appendChild(placeholder); } else { allLosses.forEach(loss => { const card = document.createElement('div'); card.className = 'bg-yellow-50 p-4 rounded-xl shadow-md border-l-4 border-yellow-400'; const date = loss.createdAt ? new Date(loss.createdAt.seconds * 1000).toLocaleString('fr-FR') : 'Date inconnue'; const reasonHtml = loss.reason ? `<p class="text-sm text-gray-500 italic mt-1">"${loss.reason}"</p>` : ''; card.innerHTML = `<div class="flex justify-between items-start"><div><p class="font-bold text-yellow-800">Perte du ${date}</p><p class="text-gray-700 mt-2"><span class="font-semibold">${loss.quantity} ${loss.unit || ''}</span> de <span class="font-semibold">${loss.itemName}</span></p>${reasonHtml}</div><div class="flex items-center gap-4 text-right"><button data-id="${loss.id}" class="delete-loss-btn text-gray-400 hover:text-red-600 transition-colors"><i class="fas fa-trash-alt"></i></button></div></div>`; container.appendChild(card); }); } };
        const renderCharges = (charges) => {
    const container = document.getElementById('charges-list');
    const placeholder = document.getElementById('charges-placeholder');
    container.innerHTML = '';

    if (charges.length === 0) {
        container.appendChild(placeholder);
    } else {
        charges.forEach(charge => {
            const card = document.createElement('div');
            card.className = 'bg-white p-3 rounded-lg shadow-sm flex justify-between items-center';

            // Formater la date en JJ/MM/AAAA (sans l'heure)
            const d = toDate(charge.date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const displayDate = `${day}/${month}/${year}`;

            card.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${charge.name}</p>
                    <p class="text-sm text-gray-500">${displayDate}</p>
                </div>
                <div class="flex items-center gap-4">
                    <p class="font-bold text-lg text-red-600">${charge.amount.toFixed(2)} Mad</p>
                    <button data-id="${charge.id}" class="delete-charge-btn text-gray-400 hover:text-red-600 transition-colors">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
    }
};
// ^ ^ ^ **FIN DE L'AJOUT** ^ ^ ^
        // --- KPI FILTERS ---
        document.getElementById('toggle-kpi-filters-btn').addEventListener('click', () => {
            document.getElementById('kpi-filter-container').classList.toggle('hidden');
        });

        document.querySelectorAll('.kpi-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.kpi-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('kpi-start-date').value = '';
                document.getElementById('kpi-end-date').value = '';

                const filterType = btn.dataset.filter;
                const now = new Date();
                let startDate, endDate = new Date(), label;
                endDate.setHours(23, 59, 59, 999);

                if (filterType === 'today') {
                    startDate = new Date();
                    startDate.setHours(0, 0, 0, 0);
                    label = "Période : Aujourd'hui";
					// V V V **AJOUTEZ CE BLOC** V V V
                } else if (filterType === 'yesterday') {
                    // Définit startDate à hier 00:00
                    startDate = new Date();
                    startDate.setDate(now.getDate() - 1);
                    startDate.setHours(0, 0, 0, 0);
                    
                    // Définit endDate à hier 23:59
                    // (on utilise 'endDate' qui est déjà initialisé à 'new Date()' plus haut)
                    endDate.setDate(now.getDate() - 1);
                    endDate.setHours(23, 59, 59, 999); 
                    
                    label = "Période : Hier";
                // ^ ^ ^ **FIN DE L'AJOUT** ^ ^ ^
                } else if (filterType === 'week') {
                    startDate = new Date(now.setDate(now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1))); // Monday
                    startDate.setHours(0, 0, 0, 0);
                    label = "Période : Cette semaine";
                } else if (filterType === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    startDate.setHours(0, 0, 0, 0);
                    label = "Période : Ce mois";
                }
                updateAndRenderKPIs(startDate, endDate, label);
                document.getElementById('kpi-filter-container').classList.add('hidden');
            });
        });

        document.getElementById('kpi-filter-range-btn').addEventListener('click', () => {
             document.querySelectorAll('.kpi-filter-btn').forEach(b => b.classList.remove('active'));
            const startValue = document.getElementById('kpi-start-date').value;
            const endValue = document.getElementById('kpi-end-date').value;
            if (!startValue || !endValue) return showToast("Veuillez sélectionner une date de début et de fin.");

            const startDate = new Date(startValue);
            startDate.setHours(0, 0, 0, 0);
            const endDate = new Date(endValue);
            endDate.setHours(23, 59, 59, 999);
            
            const label = `Période : du ${formatDateToDDMMYYYY(startDate)} au ${formatDateToDDMMYYYY(endDate)}`;
            updateAndRenderKPIs(startDate, endDate, label);
            document.getElementById('kpi-filter-container').classList.add('hidden');
        });

        document.getElementById('kpi-reset-filter-btn').addEventListener('click', () => {
            document.querySelectorAll('.kpi-filter-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('kpi-start-date').value = '';
            document.getElementById('kpi-end-date').value = '';
            updateAndRenderKPIs(); // No args means all time
            document.getElementById('kpi-filter-container').classList.add('hidden');
        });

        // --- INGREDIENTS ---
        document.getElementById('add-ingredient-btn').addEventListener('click', () => { document.getElementById('ingredient-modal-title').textContent = 'Ajouter un ingrédient'; document.getElementById('ingredient-form').reset(); document.getElementById('ingredient-id').value = ''; openModal('ingredient-modal'); }); document.getElementById('cancel-ingredient').addEventListener('click', () => closeModal('ingredient-modal')); document.getElementById('ingredient-form').addEventListener('submit', async (e) => { e.preventDefault(); const id = document.getElementById('ingredient-id').value; const data = { name: document.getElementById('ingredient-name').value, quantity: parseFloat(document.getElementById('ingredient-quantity').value), unit: document.getElementById('ingredient-unit').value, cost: parseFloat(document.getElementById('ingredient-cost').value) || 0 }; try { if (id) await updateDoc(doc(ingredientsCol, id), data); else await addDoc(ingredientsCol, {...data, createdAt: serverTimestamp()}); showToast(id ? 'Ingrédient mis à jour !' : 'Ingrédient ajouté !'); closeModal('ingredient-modal'); } catch(error) { console.error(error); showToast("Erreur lors de l'opération."); } }); document.getElementById('ingredients-list').addEventListener('click', async e => { const target = e.target.closest('[data-id]'); if (!target) return; const id = target.dataset.id; if (target.classList.contains('delete-ingredient-btn')) { if(confirm('Voulez-vous vraiment supprimer cet ingrédient ?')) { await deleteDoc(doc(ingredientsCol, id)); showToast('Ingrédient supprimé.'); } } else if (target.classList.contains('edit-ingredient-btn')) { const docSnap = await getDoc(doc(ingredientsCol, id)); const data = docSnap.data(); document.getElementById('ingredient-modal-title').textContent = 'Modifier un ingrédient'; document.getElementById('ingredient-id').value = docSnap.id; document.getElementById('ingredient-name').value = data.name; document.getElementById('ingredient-quantity').value = data.quantity; document.getElementById('ingredient-unit').value = data.unit; document.getElementById('ingredient-cost').value = data.cost || ''; openModal('ingredient-modal'); } });
        
        // --- PRODUITS ---
        const populateIngredientSelects = () => {  const recipeSelect = document.getElementById('recipe-ingredient-select');  const linkedSelect = document.getElementById('linked-ingredient-select');  const poSelect = document.getElementById('po-ingredient-select'); const lossIngredientSelect = document.getElementById('loss-ingredient-select'); const options = allIngredients.map(ing => `<option value="${ing.id}">${ing.name} (${ing.unit})</option>`).join('');  recipeSelect.innerHTML = `<option value="">Choisir...</option>${options}`;  linkedSelect.innerHTML = `<option value="">Choisir...</option>${options}`; poSelect.innerHTML = `<option value="">Choisir...</option>${options}`; lossIngredientSelect.innerHTML = `<option value="">Choisir...</option>${options}`};
        const populateProductSelects = () => { const orderSelect = document.getElementById('order-product-select'); const lossSelect = document.getElementById('loss-product-select'); const options = allProducts.map(product => `<option value="${product.id}">${product.name}</option>`).join(''); orderSelect.innerHTML = options; lossSelect.innerHTML = options; }
        document.getElementById('add-product-btn').addEventListener('click', () => { 
            document.getElementById('product-modal-title').textContent = 'Créer un Produit'; 
            document.getElementById('product-form').reset(); 
            document.getElementById('product-id').value = ''; 
            document.getElementById('product-type').dispatchEvent(new Event('change')); 
            currentRecipe = []; 
            renderCurrentRecipe(); 
            // *** NEW: Reset linked quantity field on add ***
            document.getElementById('linked-ingredient-quantity').value = 1;
            // *** END NEW ***
            openModal('product-modal'); 
        });
        document.getElementById('cancel-product').addEventListener('click', () => closeModal('product-modal')); 
        
        document.getElementById('product-type').addEventListener('change', (e) => { 
            const productType = e.target.value;
            const hasRecipe = ['Pizza', 'Dessert', 'Entrée'].includes(productType);
            document.getElementById('recipe-section').style.display = hasRecipe ? 'block' : 'none';
            document.getElementById('linked-ingredient-section').style.display = hasRecipe ? 'none' : 'block';
        }); 
        
        document.getElementById('add-recipe-ingredient-btn').addEventListener('click', () => { const select = document.getElementById('recipe-ingredient-select'); const ingredientId = select.value; const quantity = parseFloat(document.getElementById('recipe-quantity').value); if (!ingredientId || isNaN(quantity) || quantity <= 0) return showToast("Veuillez sélectionner un ingrédient et une quantité valide."); const ingredient = allIngredients.find(ing => ing.id === ingredientId); currentRecipe.push({ id: ingredient.id, name: ingredient.name, quantity: quantity, unit: ingredient.unit }); renderCurrentRecipe(); document.getElementById('recipe-quantity').value = ''; select.value = ''; });
        
        const updateRecipeCost = () => {
             const cost = currentRecipe.reduce((total, recipeItem) => {
                const ingredient = allIngredients.find(ing => ing.id === recipeItem.id);
                return total + ((ingredient?.cost || 0) * recipeItem.quantity);
             }, 0);
            document.getElementById('current-recipe-cost').textContent = `${cost.toFixed(2)} Mad`;
        };
        
        const renderCurrentRecipe = () => { const list = document.getElementById('recipe-ingredients-list'); list.innerHTML = ''; currentRecipe.forEach((item, index) => { const li = document.createElement('div'); li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded'; li.innerHTML = `<span>${item.quantity} ${item.unit} de ${item.name}</span><button type="button" data-index="${index}" class="remove-recipe-item text-red-500 hover:text-red-700"><i class="fas fa-times-circle"></i></button>`; list.appendChild(li); }); updateRecipeCost(); }; 
        document.getElementById('recipe-ingredients-list').addEventListener('click', e => { const button = e.target.closest('.remove-recipe-item'); if (button) { currentRecipe.splice(button.dataset.index, 1); renderCurrentRecipe(); } }); 
        
        document.getElementById('product-form').addEventListener('submit', async e => { 
            e.preventDefault(); 
            const id = document.getElementById('product-id').value; 
            const type = document.getElementById('product-type').value; 
            const data = { name: document.getElementById('product-name').value, price: parseFloat(document.getElementById('product-price').value), type: type }; 
            
            const hasRecipe = ['Pizza', 'Dessert', 'Entrée'].includes(type);

            if (hasRecipe) {
                if (currentRecipe.length === 0) return showToast("La recette ne peut pas être vide pour ce type de produit.");
                data.recipe = currentRecipe;
                if (data.hasOwnProperty('linkedIngredientId')) {
                    delete data.linkedIngredientId;
                }
                 if (data.hasOwnProperty('linkedIngredientQuantity')) { // Clean up
                    delete data.linkedIngredientQuantity;
                }
            } else {
                const linkedId = document.getElementById('linked-ingredient-select').value;
                // *** NEW: Get linked quantity ***
                const linkedQty = parseFloat(document.getElementById('linked-ingredient-quantity').value);
                // *** END NEW ***

                if (!linkedId) return showToast("Veuillez lier ce produit à un article en stock.");
                // *** NEW: Validate linked quantity ***
                if (isNaN(linkedQty) || linkedQty <= 0) {
                    return showToast("Veuillez entrer une quantité consommée valide (positive).");
                }
                // *** END NEW ***

                data.linkedIngredientId = linkedId;
                data.linkedIngredientQuantity = linkedQty; // *** NEW ***
                if (data.hasOwnProperty('recipe')) {
                    delete data.recipe;
                }
            }

            try { 
                if (id) {
                    await updateDoc(doc(productsCol, id), data);
                } else {
                    await addDoc(productsCol, {...data, createdAt: serverTimestamp()});
                }
                showToast(id ? 'Produit mis à jour !' : 'Produit créé !'); 
                closeModal('product-modal'); 
            } catch(error) { 
                console.error(error); 
                showToast("Erreur lors de l'opération."); 
            } 
        }); 
        
        document.getElementById('products-list').addEventListener('click', async e => { 
            const id = e.target.closest('[data-id]')?.dataset.id; 
            if(!id) return; 
            const target = e.target; 
            if (target.closest('.delete-product-btn')) { 
                if(confirm('Voulez-vous vraiment supprimer ce produit ?')) { 
                    await deleteDoc(doc(productsCol, id)); 
                    showToast('Produit supprimé.'); 
                } 
            } else if (target.closest('.edit-product-btn')) { 
                const product = allProducts.find(p => p.id === id); 
                document.getElementById('product-modal-title').textContent = 'Modifier un Produit'; 
                document.getElementById('product-id').value = id; 
                document.getElementById('product-name').value = product.name; 
                document.getElementById('product-price').value = product.price; 
                document.getElementById('product-type').value = product.type; 
                document.getElementById('product-type').dispatchEvent(new Event('change')); 
                
                if (product.recipe && product.recipe.length > 0) { 
                    currentRecipe = [...product.recipe]; 
                    renderCurrentRecipe(); 
                } else if (product.linkedIngredientId) { 
                    document.getElementById('linked-ingredient-select').value = product.linkedIngredientId; 
                    // *** NEW: Populate linked quantity ***
                    document.getElementById('linked-ingredient-quantity').value = product.linkedIngredientQuantity || 1; // Default to 1 if not set
                    // *** END NEW ***
                } 
                openModal('product-modal'); 
            } 
        });
        
        // --- VENTES ---
        document.getElementById('add-to-order-form').addEventListener('submit', e => { e.preventDefault(); const productId = document.getElementById('order-product-select').value; const quantity = parseInt(document.getElementById('order-product-quantity').value); const product = allProducts.find(p => p.id === productId); if (!product || isNaN(quantity) || quantity <= 0) return; const existingItem = currentOrder.find(item => item.id === productId); if(existingItem) existingItem.quantity += quantity; else currentOrder.push({ id: product.id, name: product.name, quantity: quantity, price: product.price }); renderCurrentOrder(); });
        
        const updateOrderTotal = () => {
            const total = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            // Met à jour le champ input, pas un span
            document.getElementById('current-order-total-input').value = total.toFixed(2); 
        };
const orderListPlaceholder = document.getElementById('order-placeholder');
        const renderCurrentOrder = () => { 
    const list = document.getElementById('current-order-list'); 
    
    const processBtn = document.getElementById('process-order-btn'); 
    list.innerHTML = ''; // <-- Vide la liste (enlève Tiramisu, etc.)
    
    if(currentOrder.length === 0){ 
        // list.innerHTML = ''; // <-- SUPPRIMER CETTE LIGNE (redondante)
        list.appendChild(orderListPlaceholder); // <-- UTILISER LA VARIABLE MISE EN CACHE
        processBtn.disabled = true; 
    } else { 
        currentOrder.forEach((item, index) => { 
            const li = document.createElement('li'); 
            li.className = 'flex justify-between items-center'; 
            li.innerHTML = `<span>${item.quantity} x ${item.name}</span><button data-index="${index}" class="remove-order-item text-gray-400 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>`; 
            list.appendChild(li); 
        }); 
        processBtn.disabled = false; 
    } 
    updateOrderTotal(); 
};	
document.getElementById('current-order-list').addEventListener('click', e => { const button = e.target.closest('.remove-order-item'); if (button) { currentOrder.splice(button.dataset.index, 1); renderCurrentOrder(); } }); 
        
        document.getElementById('process-order-btn').addEventListener('click', async () => { 
            if (currentOrder.length === 0) return; 
            
            // *** MODIFICATION : Lire le total depuis l'input ***
            const totalPriceInput = document.getElementById('current-order-total-input');
            const totalPrice = parseFloat(totalPriceInput.value);

            if (isNaN(totalPrice) || totalPrice < 0) {
                showToast("Le montant total de la vente est invalide.");
                return;
            }
            // *** FIN MODIFICATION ***
            
            const batch = writeBatch(db); 
            // let totalPrice = 0; // N'est plus calculé ici, lu depuis l'input
            const tempDeductions = new Map(); 

            for (const orderItem of currentOrder) { 
                const product = allProducts.find(p => p.id === orderItem.id); 
                if (!product) { 
                    showToast(`Produit non trouvé : ${orderItem.name}`);
                    return;
                } 
                // totalPrice += product.price * orderItem.quantity; // Déjà fait / lu depuis l'input
                
                if (product.recipe && product.recipe.length > 0) { 
                    for (const recipeItem of product.recipe) { 
                        const current = tempDeductions.get(recipeItem.id) || 0; 
                        tempDeductions.set(recipeItem.id, current + recipeItem.quantity * orderItem.quantity); 
                    } 
                } else if (product.linkedIngredientId) { 
                    // *** MODIFIED: Use linkedIngredientQuantity ***
                    const linkedQtyPerProduct = product.linkedIngredientQuantity || 1; // Default to 1
                    const totalQtyToDeduct = linkedQtyPerProduct * orderItem.quantity;
                    const current = tempDeductions.get(product.linkedIngredientId) || 0; 
                    tempDeductions.set(product.linkedIngredientId, current + totalQtyToDeduct); 
                    // *** END MODIFICATION ***
                } 
            } 
            
            for (const [ingId, qty] of tempDeductions.entries()) { 
    const ing = allIngredients.find(i => i.id === ingId); 
    if (!ing) {
        showToast(`Ingrédient inconnu détecté`);
        return;
    }
    // ✅ ON DÉDUIT QUOI QU'IL ARRIVE (même si stock insuffisant)
    batch.update(doc(ingredientsCol, ingId), { quantity: increment(-qty) }); 
}
            
            const saleDateInput = document.getElementById('sale-date').value;
            const saleDate = saleDateInput ? new Date(saleDateInput) : new Date();
            saleDate.setHours(12, 0, 0, 0); // Normalize to midday to avoid timezone issues

            batch.set(doc(ordersCol), { 
                items: currentOrder, 
                totalPrice: totalPrice, // Utilise le total de l'input
                createdAt: serverTimestamp(),
                saleDate: saleDate 
            }); 
            
            try { 
                await batch.commit(); 
                showToast('Vente validée, stock mis à jour !'); 
                currentOrder = []; 
                renderCurrentOrder(); 
                totalPriceInput.value = '0.00'; // Réinitialiser le champ total
            } catch (error) { 
                console.error("Batch commit failed: ", error); 
                showToast(`Erreur: ${error.message}`); 
            } 
        }); 
        
        document.getElementById('order-history-list').addEventListener('click', async e => { 
            const deleteBtn = e.target.closest('.delete-order-btn'); 
            if (deleteBtn) { 
                const orderId = deleteBtn.dataset.id; 
                const order = orderHistory.find(o => o.id === orderId); 
                if (!order) return; 
                if (confirm("Voulez-vous vraiment supprimer cette vente ?\n\nLe stock utilisé sera automatiquement restauré.")) { 
                    const batch = writeBatch(db); 
                    for (const item of order.items) { 
                        const prod = allProducts.find(p => p.id === item.id); 
                        if (!prod) continue; 
                        
                        if (prod.recipe && prod.recipe.length > 0) { 
                            for (const recipeItem of prod.recipe) { 
                                batch.update(doc(ingredientsCol, recipeItem.id), { quantity: increment(recipeItem.quantity * item.quantity) }); 
                            } 
                        } else if (prod.linkedIngredientId) { 
                            // *** MODIFIED: Use linkedIngredientQuantity ***
                            const linkedQtyPerProduct = prod.linkedIngredientQuantity || 1;
                            const totalQtyToRestore = linkedQtyPerProduct * item.quantity;
                            batch.update(doc(ingredientsCol, prod.linkedIngredientId), { quantity: increment(totalQtyToRestore) }); 
                            // *** END MODIFICATION ***
                        } 
                    } 
                    batch.delete(doc(ordersCol, orderId)); 
                    try { 
                        await batch.commit(); 
                        showToast("Vente supprimée et stock restauré."); 
                    } catch (error) { 
                        console.error("Error restoring stock:", error); 
                        showToast("Erreur lors de la suppression."); 
                    } 
                } 
            } 
        });

        const handleDateFilter = () => {
            const filterValue = document.getElementById('history-date-filter').value;
            if (!filterValue) {
                renderOrderHistory(orderHistory);
                return;
            }

            const filterDate = new Date(filterValue);
            filterDate.setUTCHours(0, 0, 0, 0);
            const filterTime = filterDate.getTime();

            const filtered = orderHistory.filter(order => {
                const orderDateSource = order.saleDate || order.createdAt;
                if (!orderDateSource) return false;

                const orderDate = orderDateSource.seconds ? new Date(orderDateSource.seconds * 1000) : orderDateSource;
                orderDate.setUTCHours(0, 0, 0, 0);
                
                return orderDate.getTime() === filterTime;
            });
            renderOrderHistory(filtered);
        };

        document.getElementById('history-date-filter').addEventListener('input', handleDateFilter);

        
        // --- PERTES ---
        document.getElementById('declare-loss-btn').addEventListener('click', () => { document.getElementById('loss-form').reset(); populateProductSelects(); populateIngredientSelects(); document.querySelector('input[name="loss-type"][value="product"]').checked = true; document.getElementById('loss-product-section').classList.remove('hidden'); document.getElementById('loss-ingredient-section').classList.add('hidden'); document.getElementById('loss-product-select').required = true; document.getElementById('loss-ingredient-select').required = false; openModal('loss-modal'); });
        document.getElementById('cancel-loss').addEventListener('click', () => closeModal('loss-modal'));
        document.querySelectorAll('input[name="loss-type"]').forEach(radio => { radio.addEventListener('change', (e) => { const isProduct = e.target.value === 'product'; document.getElementById('loss-product-section').classList.toggle('hidden', !isProduct); document.getElementById('loss-ingredient-section').classList.toggle('hidden', isProduct); document.getElementById('loss-product-select').required = isProduct; document.getElementById('loss-ingredient-select').required = !isProduct; }); });
        
        document.getElementById('loss-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const type = document.querySelector('input[name="loss-type"]:checked').value; 
            const quantity = parseFloat(document.getElementById('loss-quantity').value); 
            const reason = document.getElementById('loss-reason').value; 
            if (isNaN(quantity) || quantity <= 0) { return showToast("La quantité doit être un nombre positif."); } 
            
            const batch = writeBatch(db); 
            let lossData = { reason, createdAt: serverTimestamp(), quantity }; 
            let success = true; 

            if (type === 'product') { 
                const productId = document.getElementById('loss-product-select').value; 
                const product = allProducts.find(p => p.id === productId); 
                if (!product) return showToast("Produit non trouvé."); 

                lossData.itemId = productId; 
                lossData.itemName = product.name; 
                lossData.type = 'product'; 
                
                const tempDeductions = new Map(); 
                if (product.recipe && product.recipe.length > 0) { 
                    for (const recipeItem of product.recipe) { 
                        const current = tempDeductions.get(recipeItem.id) || 0; 
                        tempDeductions.set(recipeItem.id, current + recipeItem.quantity * quantity); 
                    } 
                } else if (product.linkedIngredientId) { 
                    // *** MODIFIED: Use linkedIngredientQuantity ***
                    const linkedQtyPerProduct = product.linkedIngredientQuantity || 1;
                    const totalQtyToDeduct = linkedQtyPerProduct * quantity;
                    const current = tempDeductions.get(product.linkedIngredientId) || 0; 
                    tempDeductions.set(product.linkedIngredientId, current + totalQtyToDeduct); 
                    // *** END MODIFICATION ***
                } 

                for (const [ingId, qtyToDeduct] of tempDeductions.entries()) { 
    const ing = allIngredients.find(i => i.id === ingId); 
    if (!ing) {
        showToast(`Ingrédient inconnu détecté`);
        success = false;
        break;
    }
    // ✅ ON DÉDUIT QUOI QU'IL ARRIVE
    batch.update(doc(ingredientsCol, ingId), { quantity: increment(-qtyToDeduct) }); 
}
            } else { 
    const ingredientId = document.getElementById('loss-ingredient-select').value; 
    const ingredient = allIngredients.find(i => i.id === ingredientId); 
    if (!ingredient) return showToast("Ingrédient non trouvé."); 
    
    // ✅ ON DÉDUIT QUOI QU'IL ARRIVE (plus de vérification de stock)
    lossData.itemId = ingredientId; 
    lossData.itemName = ingredient.name; 
    lossData.unit = ingredient.unit; 
    lossData.type = 'ingredient'; 
    batch.update(doc(ingredientsCol, ingredientId), { quantity: increment(-quantity) });}
                    

            if (success) { 
                batch.set(doc(lossesCol), lossData); 
                try { 
                    await batch.commit(); 
                    showToast('Perte enregistrée et stock mis à jour !'); 
                    closeModal('loss-modal'); 
                } catch (error) { 
                    console.error("Loss commit failed: ", error); 
                    showToast(`Erreur: ${error.message}`); 
                } 
            } 
        });
        
        document.getElementById('loss-history-list').addEventListener('click', async e => { 
            const deleteBtn = e.target.closest('.delete-loss-btn'); 
            if (deleteBtn) { 
                const lossId = deleteBtn.dataset.id; 
                const loss = allLosses.find(l => l.id === lossId); 
                if (!loss) return; 
                
                if (confirm("Voulez-vous vraiment annuler cette perte ?\n\nLe stock sera restauré.")) { 
                    const batch = writeBatch(db); 
                    if (loss.type === 'product') { 
                        const product = allProducts.find(p => p.id === loss.itemId); 
                        if (product) { 
                            if (product.recipe && product.recipe.length > 0) { 
                                for (const recipeItem of product.recipe) { 
                                    batch.update(doc(ingredientsCol, recipeItem.id), { quantity: increment(recipeItem.quantity * loss.quantity) }); 
                                } 
                            } else if (product.linkedIngredientId) { 
                                // *** MODIFIED: Use linkedIngredientQuantity ***
                                const linkedQtyPerProduct = product.linkedIngredientQuantity || 1;
                                const totalQtyToRestore = linkedQtyPerProduct * loss.quantity;
                                batch.update(doc(ingredientsCol, product.linkedIngredientId), { quantity: increment(totalQtyToRestore) }); 
                                // *** END MODIFICATION ***
                            } 
                        } 
                    } else { 
                        batch.update(doc(ingredientsCol, loss.itemId), { quantity: increment(loss.quantity) }); 
                    } 
                    batch.delete(doc(lossesCol, lossId)); 
                    
                    try { 
                        await batch.commit(); 
                        showToast("Perte annulée et stock restauré."); 
                    } catch (error) { 
                        console.error("Error restoring stock from loss:", error); 
                        showToast("Erreur lors de l'annulation de la perte."); 
                    } 
                } 
            } 
        });
		// ======================
// === SECTION RH ===
// ======================

// --- Render Functions ---
const renderEmployees = () => {
    const container = document.getElementById('employees-list');
    const placeholder = document.getElementById('employees-placeholder');
    container.innerHTML = '';

    if (allEmployees.length === 0) {
        container.appendChild(placeholder);
    } else {
        allEmployees.forEach(employee => {
            const card = document.createElement('div');
            card.className = `bg-white p-4 rounded-lg shadow-sm ${!employee.active ? 'opacity-60' : ''}`;
            
            const startDate = toDate(employee.startDate);
            const formattedStartDate = startDate ? `${startDate.getDate().toString().padStart(2, '0')}/${(startDate.getMonth() + 1).toString().padStart(2, '0')}/${startDate.getFullYear()}` : 'N/A';
            
            const statusBadge = employee.active 
                ? '<span class="inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Actif</span>'
                : '<span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded-full">Inactif</span>';

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-grow">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-semibold text-gray-900">${employee.name}</h3>
                            ${statusBadge}
                        </div>
                        <p class="text-sm text-gray-600">Salaire: <span class="font-semibold">${employee.monthlySalary.toFixed(2)} Mad/mois</span></p>
                        <p class="text-xs text-gray-500">Embauché le: ${formattedStartDate}</p>
                    </div>
                    <div class="flex gap-2">
                        <button data-id="${employee.id}" class="manage-absences-btn text-yellow-600 hover:text-yellow-800" title="Gérer absences">
                            <i class="fas fa-calendar-times"></i>
                        </button>
                        <button data-id="${employee.id}" class="edit-employee-btn text-gray-600 hover:text-gray-900" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button data-id="${employee.id}" class="delete-employee-btn text-red-600 hover:text-red-900" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }
};

const renderSalaryPaymentsHistory = () => {
    const container = document.getElementById('salary-payments-history');
    const placeholder = document.getElementById('salary-payments-placeholder');
    container.innerHTML = '';

    if (allSalaryPayments.length === 0) {
        container.appendChild(placeholder);
    } else {
        allSalaryPayments.forEach(payment => {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow-sm';
            
            const paymentDate = toDate(payment.paymentDate);
            const formattedDate = paymentDate ? formatDateToDDMMYYYY(paymentDate) : 'Date inconnue';

            const employeesHtml = payment.employees.map(emp => 
                `<li class="flex justify-between text-sm">
                    <span>${emp.name}${emp.absenceDays > 0 ? ` <span class="text-yellow-600">(${emp.absenceDays}j abs.)</span>` : ''}</span>
                    <span class="font-semibold">${emp.finalSalary.toFixed(2)} Mad</span>
                </li>`
            ).join('');

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-grow">
                        <h3 class="font-semibold text-gray-900">Paiement du ${formattedDate}</h3>
                        <p class="text-xs text-gray-500">Mois: ${payment.month}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <p class="text-lg font-bold text-red-600">${payment.totalAmount.toFixed(2)} Mad</p>
                        <button data-id="${payment.id}" class="delete-salary-payment-btn text-gray-400 hover:text-red-600 transition-colors" title="Supprimer ce paiement">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
                <ul class="space-y-1 border-t pt-2 mt-2">
                    ${employeesHtml}
                </ul>
            `;
            container.appendChild(card);
        });
    }
};
// ======================
// === SECTION FINANCE ===
// ======================

// Calculer les ventes d'une date spécifique
const calculateSalesForDate = (dateInput) => {
    const selectedDate = new Date(dateInput);
    selectedDate.setHours(0, 0, 0, 0);
    const nextDay = new Date(selectedDate);
    nextDay.setDate(nextDay.getDate() + 1);
    
    return orderHistory.filter(order => {
        const orderDate = toDate(order.saleDate || order.createdAt);
        if (!orderDate) return false;
        orderDate.setHours(0, 0, 0, 0);
        return orderDate.getTime() === selectedDate.getTime();
    }).reduce((sum, order) => sum + order.totalPrice, 0);
};

// Mettre à jour les calculs en temps réel
const updateDailyPaymentCalculations = () => {
    const dateValue = document.getElementById('payment-date').value;
    const tpeAmount = parseFloat(document.getElementById('tpe-amount').value) || 0;
    const glovoAmount = parseFloat(document.getElementById('glovo-amount').value) || 0;
    
    if (!dateValue) return;
    
    const totalSales = calculateSalesForDate(dateValue);
    const digitalPayments = tpeAmount + glovoAmount;
    const expectedCash = Math.max(0, totalSales - digitalPayments);
    
    document.getElementById('day-total-sales').textContent = `${totalSales.toFixed(2)} Mad`;
    document.getElementById('day-digital-payments').textContent = `${digitalPayments.toFixed(2)} Mad`;
    document.getElementById('day-expected-cash').textContent = `${expectedCash.toFixed(2)} Mad`;
    document.getElementById('day-expected-cash').className = 
        expectedCash < 0 ? 'font-bold text-red-600 text-lg' : 'font-bold text-green-600 text-lg';
};

// Render l'historique des déclarations
const renderDailyPayments = () => {
    const container = document.getElementById('daily-payments-list');
    const placeholder = document.getElementById('daily-payments-placeholder');
    container.innerHTML = '';
    
    if (allDailyPayments.length === 0) {
        container.appendChild(placeholder);
    } else {
        allDailyPayments.forEach(payment => {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-lg shadow-sm';
            
            const date = toDate(payment.date);
            const formattedDate = date ? `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}` : 'Date inconnue';
            
            const totalDigital = payment.tpeAmount + payment.glovoAmount;
            const glovoCash = payment.glovoCashAmount || 0; // ✅ AJOUTÉ
            const expectedCash = payment.totalSales - totalDigital;
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="font-semibold text-gray-900">${formattedDate}</h3>
                        <p class="text-sm text-gray-600">Total ventes : ${payment.totalSales.toFixed(2)} Mad</p>
                        <p class="text-xs text-orange-600">Glovo Cash : ${glovoCash.toFixed(2)} Mad</p>
                    </div>
                    <button data-id="${payment.id}" class="delete-daily-payment-btn text-gray-400 hover:text-red-600 transition-colors">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="grid grid-cols-3 gap-2 text-sm">
                    <div class="bg-blue-50 p-2 rounded">
                        <p class="text-xs text-blue-600">TPE</p>
                        <p class="font-semibold">${payment.tpeAmount.toFixed(2)} Mad</p>
                    </div>
                    <div class="bg-purple-50 p-2 rounded">
                        <p class="text-xs text-purple-600">Glovo</p>
                        <p class="font-semibold">${payment.glovoAmount.toFixed(2)} Mad</p>
                    </div>
                    <div class="bg-green-50 p-2 rounded">
                        <p class="text-xs text-green-600">Espèces</p>
                        <p class="font-semibold">${expectedCash.toFixed(2)} Mad</p>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }
};

// Event Listeners pour Finance
document.getElementById('payment-date').addEventListener('change', updateDailyPaymentCalculations);
document.getElementById('tpe-amount').addEventListener('input', updateDailyPaymentCalculations);
document.getElementById('glovo-amount').addEventListener('input', updateDailyPaymentCalculations);
document.getElementById('glovo-cash-amount').addEventListener('input', updateDailyPaymentCalculations);


// Soumettre la déclaration journalière
document.getElementById('daily-payment-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const dateValue = document.getElementById('payment-date').value;
    const tpeAmount = parseFloat(document.getElementById('tpe-amount').value) || 0;
    const glovoAmount = parseFloat(document.getElementById('glovo-amount').value) || 0;
    
    if (!dateValue) {
        showToast("Veuillez sélectionner une date.");
        return;
    }
    
    const totalSales = calculateSalesForDate(dateValue);
    const paymentDate = new Date(dateValue);
    paymentDate.setHours(12, 0, 0, 0);
    
    // Vérifier si une déclaration existe déjà pour cette date
    const existingPayment = allDailyPayments.find(p => {
        const pDate = toDate(p.date);
        return pDate && pDate.toDateString() === paymentDate.toDateString();
    });
    
   try {
        const glovoCashAmount = parseFloat(document.getElementById('glovo-cash-amount').value) || 0; // ✅ AJOUTÉ
        
        const data = {
            date: paymentDate,
            tpeAmount,
            glovoAmount,
            glovoCashAmount, // ✅ AJOUTÉ
            totalSales,
            expectedCash: totalSales - (tpeAmount + glovoAmount),
            createdAt: serverTimestamp()
        };
        
        if (existingPayment) {
            await updateDoc(doc(dailyPaymentsCol, existingPayment.id), data);
            showToast('Déclaration mise à jour !');
        } else {
            await addDoc(dailyPaymentsCol, data);
            showToast('Déclaration enregistrée !');
        }
        
        // Réinitialiser le formulaire
        document.getElementById('tpe-amount').value = '0';
        document.getElementById('glovo-amount').value = '0';
        document.getElementById('glovo-cash-amount').value = '0'; // ✅ AJOUTÉ
        updateDailyPaymentCalculations();
        
    } catch (error) {
        console.error("Erreur déclaration:", error);
        showToast("Erreur lors de l'enregistrement.");
    }
});

// Supprimer une déclaration
document.getElementById('daily-payments-list').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.delete-daily-payment-btn');
    if (deleteBtn) {
        const paymentId = deleteBtn.dataset.id;
        if (confirm('Supprimer cette déclaration ?')) {
            try {
                await deleteDoc(doc(dailyPaymentsCol, paymentId));
                showToast('Déclaration supprimée.');
            } catch (error) {
                console.error("Erreur suppression:", error);
                showToast("Erreur lors de la suppression.");
            }
        }
    }
});
const renderAbsencesForEmployee = (employeeId) => {
    const container = document.getElementById('absences-list');
    const employeeAbsences = allAbsences.filter(a => a.employeeId === employeeId);
    
    container.innerHTML = '';
    
    if (employeeAbsences.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Aucune absence enregistrée.</p>';
    } else {
        employeeAbsences.sort((a, b) => b.month.localeCompare(a.month));
        employeeAbsences.forEach(absence => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
            div.innerHTML = `
                <div>
                    <span class="text-sm font-medium">${absence.month}</span>
                    <span class="text-xs text-gray-600 ml-2">${absence.days} jour(s)</span>
                </div>
                <button data-id="${absence.id}" class="delete-absence-btn text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
        });
    }
};

// --- Event Handlers ---

// Ajouter un salarié
document.getElementById('add-employee-btn').addEventListener('click', () => {
    document.getElementById('employee-modal-title').textContent = 'Ajouter un Salarié';
    document.getElementById('employee-form').reset();
    document.getElementById('employee-id').value = '';
    document.getElementById('employee-active').checked = true;
    document.getElementById('employee-start-date').value = getTodayDateString();
    openModal('employee-modal');
});

document.getElementById('cancel-employee').addEventListener('click', () => closeModal('employee-modal'));

document.getElementById('employee-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('employee-id').value;
    const data = {
        name: document.getElementById('employee-name').value.trim(),
        monthlySalary: parseFloat(document.getElementById('employee-salary').value),
        startDate: new Date(document.getElementById('employee-start-date').value),
        active: document.getElementById('employee-active').checked
    };

    try {
        if (id) {
            await updateDoc(doc(employeesCol, id), data);
            showToast('Salarié mis à jour !');
        } else {
            await addDoc(employeesCol, { ...data, createdAt: serverTimestamp() });
            showToast('Salarié ajouté !');
        }
        closeModal('employee-modal');
    } catch (error) {
        console.error("Erreur salarié:", error);
        showToast("Erreur lors de l'opération.");
    }
});

// Gérer les actions sur les salariés
document.getElementById('employees-list').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.delete-employee-btn');
    const editBtn = e.target.closest('.edit-employee-btn');
    const absencesBtn = e.target.closest('.manage-absences-btn');

    if (deleteBtn) {
        const employeeId = deleteBtn.dataset.id;
        if (confirm('Voulez-vous vraiment supprimer ce salarié ? Toutes ses absences seront également supprimées.')) {
            try {
                // Supprimer les absences associées
                const employeeAbsences = allAbsences.filter(a => a.employeeId === employeeId);
                for (const absence of employeeAbsences) {
                    await deleteDoc(doc(absencesCol, absence.id));
                }
                // Supprimer le salarié
                await deleteDoc(doc(employeesCol, employeeId));
                showToast('Salarié supprimé.');
            } catch (error) {
                console.error("Erreur suppression salarié:", error);
                showToast("Erreur lors de la suppression.");
            }
        }
    } else if (editBtn) {
        const employeeId = editBtn.dataset.id;
        const employee = allEmployees.find(e => e.id === employeeId);
        if (employee) {
            document.getElementById('employee-modal-title').textContent = 'Modifier le Salarié';
            document.getElementById('employee-id').value = employee.id;
            document.getElementById('employee-name').value = employee.name;
            document.getElementById('employee-salary').value = employee.monthlySalary;
            
            const startDate = toDate(employee.startDate);
            if (startDate) {
                const year = startDate.getFullYear();
                const month = String(startDate.getMonth() + 1).padStart(2, '0');
                const day = String(startDate.getDate()).padStart(2, '0');
                document.getElementById('employee-start-date').value = `${year}-${month}-${day}`;
            }
            
            document.getElementById('employee-active').checked = employee.active;
            openModal('employee-modal');
        }
    } else if (absencesBtn) {
        const employeeId = absencesBtn.dataset.id;
        const employee = allEmployees.find(e => e.id === employeeId);
        if (employee) {
            document.getElementById('absence-employee-id').value = employee.id;
            document.getElementById('absence-employee-name').textContent = employee.name;
            
            // Définir le mois par défaut (mois courant)
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('absence-month').value = `${year}-${month}`;
            
            renderAbsencesForEmployee(employeeId);
            openModal('absences-modal');
        }
    }
});

// Gérer les absences
document.getElementById('cancel-absences').addEventListener('click', () => closeModal('absences-modal'));

document.getElementById('absence-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const employeeId = document.getElementById('absence-employee-id').value;
    const month = document.getElementById('absence-month').value; // Format: YYYY-MM
    const days = parseFloat(document.getElementById('absence-days').value);

    if (days < 0 || days > 26) {
        showToast('Le nombre de jours d\'absence doit être entre 0 et 26.');
        return;
    }

    // Vérifier si une absence existe déjà pour ce mois
    const existingAbsence = allAbsences.find(a => a.employeeId === employeeId && a.month === month);

    try {
        if (existingAbsence) {
            // Mettre à jour l'absence existante
            await updateDoc(doc(absencesCol, existingAbsence.id), { days });
            showToast('Absence mise à jour !');
        } else {
            // Créer une nouvelle absence
            await addDoc(absencesCol, {
                employeeId,
                month,
                days,
                createdAt: serverTimestamp()
            });
            showToast('Absence enregistrée !');
        }
        
        // Réinitialiser le formulaire
        document.getElementById('absence-days').value = '';
        
        // Rafraîchir la liste des absences
        renderAbsencesForEmployee(employeeId);
    } catch (error) {
        console.error("Erreur absence:", error);
        showToast("Erreur lors de l'enregistrement de l'absence.");
    }
});

// Supprimer une absence
document.getElementById('absences-list').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.delete-absence-btn');
    if (deleteBtn) {
        const absenceId = deleteBtn.dataset.id;
        if (confirm('Supprimer cette absence ?')) {
            try {
                await deleteDoc(doc(absencesCol, absenceId));
                showToast('Absence supprimée.');
                const employeeId = document.getElementById('absence-employee-id').value;
                renderAbsencesForEmployee(employeeId);
            } catch (error) {
                console.error("Erreur suppression absence:", error);
                showToast("Erreur lors de la suppression.");
            }
        }
    }
});

// Calculer les salaires
document.getElementById('calculate-salaries-btn').addEventListener('click', () => {
    const monthInput = document.getElementById('salary-month').value;
    
    if (!monthInput) {
        showToast('Veuillez sélectionner un mois.');
        return;
    }

    const activeEmployees = allEmployees.filter(e => e.active);
    
    if (activeEmployees.length === 0) {
        showToast('Aucun salarié actif à payer.');
        return;
    }

    currentSalaryCalculations = [];
    let totalAmount = 0;

    activeEmployees.forEach(employee => {
        const monthlySalary = employee.monthlySalary;
        const dailySalary = monthlySalary / 26; // Base 26 jours
        
        // Récupérer les absences du mois
        const absence = allAbsences.find(a => a.employeeId === employee.id && a.month === monthInput);
        const absenceDays = absence ? absence.days : 0;
        
        // Calculer le salaire final
        const deduction = dailySalary * absenceDays;
        const finalSalary = monthlySalary - deduction;
        
        currentSalaryCalculations.push({
            employeeId: employee.id,
            name: employee.name,
            monthlySalary,
            absenceDays,
            deduction,
            finalSalary
        });
        
        totalAmount += finalSalary;
    });

    // Afficher les résultats
    const resultsContainer = document.getElementById('salary-results-list');
    resultsContainer.innerHTML = '';
    
    currentSalaryCalculations.forEach(calc => {
        const div = document.createElement('div');
        div.className = 'bg-gray-50 p-3 rounded-lg';
        div.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-semibold text-gray-900">${calc.name}</p>
                    <p class="text-xs text-gray-600">Salaire base: ${calc.monthlySalary.toFixed(2)} Mad</p>
                    ${calc.absenceDays > 0 ? `
                        <p class="text-xs text-yellow-600">
                            <i class="fas fa-exclamation-triangle"></i> 
                            ${calc.absenceDays} jour(s) d'absence (-${calc.deduction.toFixed(2)} Mad)
                        </p>
                    ` : '<p class="text-xs text-green-600"><i class="fas fa-check"></i> Aucune absence</p>'}
                </div>
                <p class="text-lg font-bold text-gray-900">${calc.finalSalary.toFixed(2)} Mad</p>
            </div>
        `;
        resultsContainer.appendChild(div);
    });
    
    document.getElementById('total-salary-amount').textContent = `${totalAmount.toFixed(2)} Mad`;
    document.getElementById('salary-calculations').classList.remove('hidden');
});

// Payer tous les salaires
document.getElementById('pay-all-salaries-btn').addEventListener('click', async () => {
    if (currentSalaryCalculations.length === 0) {
        showToast('Aucun salaire à payer.');
        return;
    }

    const monthInput = document.getElementById('salary-month').value;
    
    if (!confirm(`Confirmer le paiement de ${currentSalaryCalculations.length} salaire(s) pour le mois ${monthInput} ?`)) {
        return;
    }

    try {
        const totalAmount = currentSalaryCalculations.reduce((sum, calc) => sum + calc.finalSalary, 0);
        
        // Enregistrer le paiement global
        await addDoc(salaryPaymentsCol, {
            month: monthInput,
            employees: currentSalaryCalculations,
            totalAmount,
            paymentDate: new Date(),
            createdAt: serverTimestamp()
        });

        // Ajouter à la collection charges
        await addDoc(chargesCol, {
            name: `Salaires ${monthInput}`,
            amount: totalAmount,
            date: new Date(),
            createdAt: serverTimestamp(),
            type: 'salary' // Marqueur pour identifier les charges de salaires
        });

        showToast(`Paiement de ${totalAmount.toFixed(2)} Mad enregistré !`);
        
        // Réinitialiser
        document.getElementById('salary-calculations').classList.add('hidden');
        document.getElementById('salary-month').value = '';
        currentSalaryCalculations = [];
        
    } catch (error) {
        console.error("Erreur paiement salaires:", error);
        showToast("Erreur lors du paiement.");
    }
});

// ^ ^ ^ **FIN DU BLOC RH** ^ ^ ^
// === AJOUT: SUPPRESSION DES PAIEMENTS DE SALAIRES ===
// Supprimer un paiement de salaire
document.getElementById('salary-payments-history').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.delete-salary-payment-btn');
    if (deleteBtn) {
        const paymentId = deleteBtn.dataset.id;
        const payment = allSalaryPayments.find(p => p.id === paymentId);
        
        if (!payment) return;
        
        if (confirm(`Voulez-vous vraiment supprimer ce paiement de salaires ?\n\nMontant: ${payment.totalAmount.toFixed(2)} Mad\nMois: ${payment.month}\n\nLa charge associée sera également supprimée.`)) {
            try {
                // 1. Supprimer le paiement de salaire
                await deleteDoc(doc(salaryPaymentsCol, paymentId));
                
                // 2. Trouver et supprimer la charge associée dans les charges
                // On cherche une charge de type 'salary' avec le même montant et le même mois
                const associatedCharge = allCharges.find(charge => 
                    charge.type === 'salary' && 
                    charge.name === `Salaires ${payment.month}` &&
                    Math.abs(charge.amount - payment.totalAmount) < 0.01 // Comparaison avec tolérance
                );
                
                if (associatedCharge) {
                    await deleteDoc(doc(chargesCol, associatedCharge.id));
                    showToast(`Paiement supprimé. Charge de ${payment.totalAmount.toFixed(2)} Mad retirée.`);
                } else {
                    showToast('Paiement supprimé (charge associée non trouvée).');
                }
                
            } catch (error) {
                console.error("Erreur suppression paiement salaire:", error);
                showToast("Erreur lors de la suppression.");
            }
        }
    }
});
// === FIN AJOUT ===
// V V V **AJOUTEZ CE BLOC POUR LES CHARGES** V V V
// --- CHARGES ---

// Gérer l'ajout d'une charge
document.getElementById('charge-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('charge-name').value;
    const amount = parseFloat(document.getElementById('charge-amount').value);
    const dateValue = document.getElementById('charge-date').value;

    if (!name || isNaN(amount) || amount <= 0 || !dateValue) {
        showToast("Veuillez remplir tous les champs avec des valeurs valides.");
        return;
    }

    const chargeDate = new Date(dateValue);
    // Ajuster l'heure à midi pour éviter les problèmes de fuseau horaire
    chargeDate.setHours(12, 0, 0, 0); 

    try {
        await addDoc(chargesCol, {
            name: name,
            amount: amount,
            date: chargeDate,
            createdAt: serverTimestamp()
        });

        showToast('Charge enregistrée !');
        document.getElementById('charge-form').reset();
        // Réinitialiser la date à aujourd'hui après l'ajout
        document.getElementById('charge-date').value = getTodayDateString(); 
    } catch (error) {
        console.error("Erreur ajout charge: ", error);
        showToast("Erreur lors de l'enregistrement de la charge.");
    }
});

// Gérer la suppression d'une charge
document.getElementById('charges-list').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.delete-charge-btn');
    if (deleteBtn) {
        const chargeId = deleteBtn.dataset.id;
        if (confirm("Voulez-vous vraiment supprimer cette charge ?")) {
            try {
                await deleteDoc(doc(chargesCol, chargeId));
                showToast("Charge supprimée.");
            } catch (error) {
                console.error("Erreur suppression charge: ", error);
                showToast("Erreur lors de la suppression.");
            }
        }
    }
});
// ^ ^ ^ **FIN DE L'AJOUT** ^ ^ ^
        // --- FOURNISSEURS & ACHATS ---
        document.getElementById('add-supplier-btn').addEventListener('click', () => { document.getElementById('supplier-modal-title').textContent = 'Ajouter un Fournisseur'; document.getElementById('supplier-form').reset(); document.getElementById('supplier-id').value = ''; openModal('supplier-modal'); }); document.getElementById('cancel-supplier').addEventListener('click', () => closeModal('supplier-modal')); document.getElementById('supplier-form').addEventListener('submit', async e => { e.preventDefault(); const id = document.getElementById('supplier-id').value; const data = { name: document.getElementById('supplier-name').value, contact: document.getElementById('supplier-contact').value }; try { if (id) await updateDoc(doc(suppliersCol, id), data); else await addDoc(suppliersCol, data); showToast(id ? 'Fournisseur mis à jour' : 'Fournisseur ajouté'); closeModal('supplier-modal'); } catch(error) { showToast('Erreur'); } }); document.getElementById('suppliers-list').addEventListener('click', async e => { const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id; if (target.classList.contains('delete-supplier-btn')) { if (confirm('Supprimer ce fournisseur ?')) await deleteDoc(doc(suppliersCol, id)); } else if (target.classList.contains('edit-supplier-btn')) { const sup = allSuppliers.find(s => s.id === id); document.getElementById('supplier-id').value = id; document.getElementById('supplier-name').value = sup.name; document.getElementById('supplier-contact').value = sup.contact; openModal('supplier-modal'); } });
        const populateSupplierSelects = () => { const select = document.getElementById('po-supplier-select'); select.innerHTML = '<option value="">Choisir...</option>'; allSuppliers.forEach(s => select.innerHTML += `<option value="${s.id}">${s.name}</option>`); }; 
        
        document.getElementById('add-purchase-order-btn').addEventListener('click', () => { 
            document.getElementById('purchase-order-form').reset(); 
            document.getElementById('po-id').value = ''; 
            document.getElementById('po-modal-title').textContent = 'Nouvelle Commande Fournisseur'; 
            // *** NEW: Reset payment status radio to default ***
            document.querySelector('input[name="po-payment-status"][value="unpaid"]').checked = true;
            // *** END NEW ***
            currentPurchaseOrderItems = []; 
            renderCurrentPurchaseOrderItems(); 
            openModal('purchase-order-modal'); 
        }); 
        document.getElementById('cancel-purchase-order').addEventListener('click', () => closeModal('purchase-order-modal'));
        
        const updatePurchaseOrderTotal = () => {
            // Recalculate total based on currentPurchaseOrderItems prices (price per unit * quantity)
            const total = currentPurchaseOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
             document.getElementById('po-total-cost-input').value = total.toFixed(2); // Met à jour l'input
        };
        
        // --- MODIFICATION: renderCurrentPurchaseOrderItems (Pour inclure les inputs) ---
        const renderCurrentPurchaseOrderItems = () => { 
            const list = document.getElementById('po-items-list'); 
            list.innerHTML = ''; // Vider la liste
            
            // Ajouter un en-tête si des articles sont présents
            if (currentPurchaseOrderItems.length > 0) {
                 list.innerHTML = `
                    <div class="flex justify-between items-center text-sm font-medium text-gray-500 mb-1 px-2">
                        <div class="flex-grow grid grid-cols-4 gap-2 items-center">
                            <span class="col-span-2">Article</span>
                            <span class="text-right">Quantité</span>
                            <span class="text-right">Prix/Unité</span>
                        </div>
                        <span class="ml-2 w-6"></span> <!-- Espace pour le bouton supprimer -->
                    </div>
                `;
            }

            currentPurchaseOrderItems.forEach((item, index) => { 
                const li = document.createElement('div'); 
                li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded'; 
                
                li.innerHTML = `
                    <div class="flex-grow grid grid-cols-4 gap-2 items-center">
                        <span class="col-span-2 text-sm">${item.name} (${item.unit})</span>
                        
                        <label class="sr-only" for="po-item-qty-${index}">Quantité ${item.name}</label>
                        <input type="number" step="any" min="0" value="${item.quantity}" data-index="${index}" data-field="quantity"
                               id="po-item-qty-${index}"
                               class="po-item-input w-full p-1 border border-gray-300 rounded-lg shadow-sm text-right">
                        
                        <label class="sr-only" for="po-item-price-${index}">Prix ${item.name}</label>
                        <input type="number" step="any" min="0" value="${(item.price || 0).toFixed(2)}" data-index="${index}" data-field="price"
                               id="po-item-price-${index}"
                               class="po-item-input w-full p-1 border border-gray-300 rounded-lg shadow-sm text-right">
                    </div>
                    <button type="button" data-index="${index}" class="remove-po-item-btn text-red-500 hover:text-red-700 ml-2 w-6 flex-shrink-0">
                        <i class="fas fa-times-circle"></i>
                    </button>
                `;
                
                list.appendChild(li); 
            }); 
            updatePurchaseOrderTotal(); 
        };
        // --- FIN MODIFICATION ---
        
        document.getElementById('add-po-item-btn').addEventListener('click', () => { 
            const select = document.getElementById('po-ingredient-select'); 
            const ingredientId = select.value; 
            const quantityInput = document.getElementById('po-quantity');
            const priceInput = document.getElementById('po-price'); // Input for price per unit
            const quantity = parseFloat(quantityInput.value); 
            const pricePerUnit = parseFloat(priceInput.value); 
            
            if (!ingredientId || isNaN(quantity) || quantity <= 0 || isNaN(pricePerUnit) || pricePerUnit < 0) {
                 return showToast('Veuillez sélectionner un ingrédient et entrer une quantité et un prix par unité valides.'); 
            }
            const ingredient = allIngredients.find(i => i.id === ingredientId); 
            
            currentPurchaseOrderItems.push({
                id: ingredient.id, 
                name: ingredient.name, 
                unit: ingredient.unit, 
                quantity, 
                price: pricePerUnit // Store price per unit correctly
            }); 
            
            renderCurrentPurchaseOrderItems(); 
            select.value = ''; 
            quantityInput.value = ''; 
            priceInput.value = ''; 
        }); 
        
        // --- MODIFICATION: Listener pour les changements d'input dans la liste PO ---
        document.getElementById('po-items-list').addEventListener('change', e => {
            const input = e.target;
            // Vérifier si c'est un de nos nouveaux inputs
            if (input.classList.contains('po-item-input')) {
                const index = parseInt(input.dataset.index, 10);
                const field = input.dataset.field; // 'quantity' ou 'price'
                const value = parseFloat(input.value);

                if (index >= 0 && index < currentPurchaseOrderItems.length && field && !isNaN(value)) {
                    // Mettre à jour le tableau
                    currentPurchaseOrderItems[index][field] = value;
                    
                    // Mettre à jour le total
                    updatePurchaseOrderTotal();
                }
            }
        });
        // --- FIN MODIFICATION ---
        
        document.getElementById('po-items-list').addEventListener('click', e => { const button = e.target.closest('.remove-po-item-btn'); if (button) { currentPurchaseOrderItems.splice(button.dataset.index, 1); renderCurrentPurchaseOrderItems(); } }); 
        
        // --- Corrected Purchase Order Form Submission ---
        document.getElementById('purchase-order-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Form submitted"); // Debug log 1
            const poId = document.getElementById('po-id').value;
            const supplierId = document.getElementById('po-supplier-select').value;
            const fileInput = document.getElementById('po-invoice-file');
            const file = fileInput.files[0];
            console.log("File selected:", file ? file.name : "None"); // Debug log 2

            if (!supplierId || currentPurchaseOrderItems.length === 0) {
                showToast('Fournisseur et articles requis.');
                return;
            }

            // *** MODIFICATION : Lire le total depuis l'input ***
            const totalCost = parseFloat(document.getElementById('po-total-cost-input').value);
            if (isNaN(totalCost) || totalCost < 0) {
                 showToast("Le total de la commande est invalide.");
                 return;
            }
            // *** FIN MODIFICATION ***
            
            // *** NEW: Get payment status ***
            const paymentStatus = document.querySelector('input[name="po-payment-status"]:checked').value;
            // *** END NEW ***


            let invoiceUrl = '';
            const existingPo = poId ? allPurchaseOrders.find(po => po.id === poId) : null;

            // Preserve existing URL if editing and no new file is selected
            if (existingPo && existingPo.invoiceUrl && !file) {
                invoiceUrl = existingPo.invoiceUrl;
                console.log("Preserving existing invoice URL:", invoiceUrl); // Debug log 3a
            }

            // Function to handle the database save operation
            const saveOrderData = async (url) => {
                try {
                    // totalCost est maintenant lu depuis l'input, plus besoin de le recalculer
                    const data = {
                        supplierId,
                        items: currentPurchaseOrderItems,
                        totalCost: totalCost, // Utilise le total de l'input
                        invoiceUrl: url,
                        paymentStatus: paymentStatus // *** NEW: Add to data ***
                    };
                    console.log("Data to save:", data); // Debug log 5

                    if (poId) {
                        console.log("Updating existing PO:", poId); // Debug log 6a
                         // Preserve existing statuses/dates not managed by the form
                        if (existingPo) {
                            data.status = existingPo.status || 'pending';
                            data.createdAt = existingPo.createdAt || serverTimestamp(); // Keep original creation date
                            if (existingPo.receivedAt) {
                                data.receivedAt = existingPo.receivedAt; 
                            }
                            if (paymentStatus === 'paid' && !existingPo.paidAt) {
                                data.paidAt = serverTimestamp(); // Add paidAt timestamp only if changing to paid
                            } else if (existingPo.paidAt) {
                                data.paidAt = existingPo.paidAt; // Preserve existing paidAt
                            }
                        }
                        await updateDoc(doc(purchaseOrdersCol, poId), data);
                        showToast('Commande fournisseur mise à jour');
                    } else {
                        console.log("Adding new PO"); // Debug log 6b
                        data.status = 'pending';
                        data.createdAt = serverTimestamp();
                        if (paymentStatus === 'paid') {
                             data.paidAt = serverTimestamp(); // Add paidAt timestamp if created as paid
                        }
                        await addDoc(purchaseOrdersCol, data);
                        showToast('Commande fournisseur créée');
                    }
                    console.log("Database operation successful"); // Debug log 7
                    closeModal('purchase-order-modal');
                } catch (dbError) {
                    console.error("Error saving purchase order to DB:", dbError); // Log DB error specifically
                    showToast(`Erreur lors de l'enregistrement en base de données: ${dbError.message}`);
                } finally {
                     console.log("Resetting file input in finally block"); // Debug log 8
                    fileInput.value = ''; // Reset file input in finally block
                }
            };

            // Process file upload first if a file exists
            if (file) {
                try {
                    console.log("Attempting to upload file..."); // Debug log 3b
                    const storageRef = ref(storage, `invoices/${appId}/${Date.now()}-${file.name}`);
                    const uploadTask = await uploadBytes(storageRef, file);
                    console.log("Upload task snapshot:", uploadTask); // More detailed log
                    invoiceUrl = await getDownloadURL(uploadTask.ref); // Correct way to get URL after uploadBytes
                    console.log("File uploaded successfully, URL:", invoiceUrl); // Debug log 4
                    await saveOrderData(invoiceUrl); // Save data AFTER getting URL
                } catch (uploadError) {
                    console.error("Error uploading file:", uploadError); // Log upload error specifically
                    showToast(`Erreur lors de l'envoi de la facture: ${uploadError.message}`);
                     console.log("Resetting file input after upload error"); // Debug log 9
                    fileInput.value = ''; // Reset file input on upload error
                }
            } else {
                // No file to upload, proceed directly to saving data with potentially existing URL
                 console.log("No file to upload, saving data directly."); // Debug log 10
                await saveOrderData(invoiceUrl);
            }
        });
        
        document.getElementById('purchase-orders-list').addEventListener('click', async e => { 
            const target = e.target.closest('button[data-id]'); 
            if (!target) return; 
            const poId = target.dataset.id; 
            
            if (target.classList.contains('receive-po-btn')) { 
                const poDoc = await getDoc(doc(purchaseOrdersCol, poId)); 
                const purchaseOrder = poDoc.data(); 
                const batch = writeBatch(db); 
                purchaseOrder.items.forEach(item => { 
                    const ingRef = doc(ingredientsCol, item.id); 
                    // Make sure quantity and price are numbers before incrementing
                    const quantityToAdd = Number(item.quantity) || 0; 
                    if (quantityToAdd > 0) {
                        batch.update(ingRef, { quantity: increment(quantityToAdd) }); 
                    } else {
                        console.warn(`Invalid quantity found for item ${item.name} in PO ${poId}. Skipping stock update for this item.`);
                    }
                }); 
                batch.update(doc(purchaseOrdersCol, poId), { status: 'received', receivedAt: serverTimestamp() }); 
                await batch.commit(); 
                showToast('Stock mis à jour !'); 
            
    } else if (target.classList.contains('delete-po-btn')) { 
    const poToDelete = allPurchaseOrders.find(po => po.id === poId);
    if (confirm('Voulez-vous vraiment supprimer cette commande fournisseur ? Cette action est irréversible.')) { 
        try { 
            if (poToDelete && poToDelete.invoiceUrl) {
                try {
                    const fileRef = ref(storage, poToDelete.invoiceUrl);
                    await deleteObject(fileRef);
                    console.log("Associated invoice deleted from storage.");
                } catch (storageError) {
                    console.error("Error deleting invoice from storage:", storageError);
                    showToast("Erreur lors de la suppression de la facture associée, mais la commande sera supprimée.");
                }
            }
            await deleteDoc(doc(purchaseOrdersCol, poId)); 
            showToast('Commande fournisseur supprimée.'); 
        } catch (error) { 
            console.error("Error deleting purchase order:", error); 
            showToast('Erreur lors de la suppression.'); 
        } 
    }
} else if (target.classList.contains('edit-po-btn')) { 
    const purchaseOrder = allPurchaseOrders.find(po => po.id === poId); 
    if (!purchaseOrder) return; 
    
    const isReceived = purchaseOrder.status === 'received';
    
    document.getElementById('po-modal-title').textContent = isReceived 
        ? 'Modifier le Montant (Commande Réceptionnée)' 
        : 'Modifier la Commande Fournisseur'; 
        
    document.getElementById('po-id').value = poId; 
    document.getElementById('po-supplier-select').value = purchaseOrder.supplierId; 
    
    // Désactiver les champs si réceptionné
    document.getElementById('po-supplier-select').disabled = isReceived;
    document.getElementById('po-ingredient-select').disabled = isReceived;
    document.getElementById('po-quantity').disabled = isReceived;
    document.getElementById('po-price').disabled = isReceived;
    document.getElementById('add-po-item-btn').disabled = isReceived;
    
    // Utiliser setTimeout pour les éléments générés dynamiquement
    setTimeout(() => {
        const itemInputs = document.querySelectorAll('.po-item-input');
        itemInputs.forEach(input => input.disabled = isReceived);
        const removeButtons = document.querySelectorAll('.remove-po-item-btn');
        removeButtons.forEach(btn => btn.style.display = isReceived ? 'none' : 'block');
    }, 100);
    
    // Définir le statut de paiement
    const paymentStatusValue = purchaseOrder.paymentStatus || 'unpaid';
    document.querySelector(`input[name="po-payment-status"][value="${paymentStatusValue}"]`).checked = true;
    
    // Désactiver les radios de paiement si réceptionné
    document.querySelectorAll('input[name="po-payment-status"]').forEach(radio => {
        radio.disabled = isReceived;
    });

    // Préparer les items avec prix
    currentPurchaseOrderItems = purchaseOrder.items.map(item => ({
        ...item,
        price: Number(item.price) || 0
    }));
    renderCurrentPurchaseOrderItems();
    
    // Le champ total reste TOUJOURS éditable
    const calculatedTotal = currentPurchaseOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    document.getElementById('po-total-cost-input').value = (purchaseOrder.totalCost || calculatedTotal).toFixed(2);
    document.getElementById('po-total-cost-input').disabled = false;
    
    document.getElementById('po-invoice-file').value = ''; 
    openModal('purchase-order-modal');

            } else if (target.classList.contains('reorder-po-btn')) {
                 const poToReorder = allPurchaseOrders.find(po => po.id === poId);
                 if (!poToReorder) return;
                 document.getElementById('purchase-order-form').reset();
                 document.getElementById('po-id').value = ''; // Clear ID for new order
                 document.getElementById('po-modal-title').textContent = 'Nouvelle Commande Fournisseur (Relance)';
                 document.getElementById('po-supplier-select').value = poToReorder.supplierId;
                 
                 // *** NEW: Reset payment status on reorder ***
                 document.querySelector('input[name="po-payment-status"][value="unpaid"]').checked = true;
                 // *** END NEW ***
                 
                 // Ensure items have price when reordering
                 currentPurchaseOrderItems = poToReorder.items.map(item => ({
                     ...item,
                    price: Number(item.price) || 0 // Ensure price is a number
                 })); 
                 renderCurrentPurchaseOrderItems(); // Calcule et affiche le total auto
                 document.getElementById('po-invoice-file').value = ''; // Clear potential old invoice
                 openModal('purchase-order-modal');
            } else if (target.classList.contains('pay-po-btn')) {
                // *** NEW: Logic to mark as paid ***
                if (confirm("Voulez-vous marquer cette commande comme 'Payé' ?")) {
                    try {
                        await updateDoc(doc(purchaseOrdersCol, poId), { 
                            paymentStatus: 'paid',
                            paidAt: serverTimestamp() // Optional: add a paid timestamp
                        });
                        showToast('Commande marquée comme payée !');
                    } catch (error) {
                        console.error("Erreur lors de la mise à jour du paiement:", error);
                        showToast('Erreur lors de la mise à jour.');
                    }
                }
                // *** END NEW ***
            }
        });
        
       // --- IMPORT API SALES (Using Proxy for Auth) ---
        document.getElementById('import-api-sales-btn').addEventListener('click', () => {
             // Reset form fields to default (today's date)
            document.getElementById('api-start-date').value = getTodayDateString();
            document.getElementById('api-end-date').value = getTodayDateString();
            openModal('api-import-modal');
        });
        document.getElementById('cancel-api-import').addEventListener('click', () => closeModal('api-import-modal'));

document.getElementById('api-import-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const startDate = document.getElementById('api-start-date').value;
    const endDate = document.getElementById('api-end-date').value;
    const loader = document.getElementById('api-import-loader');
    const statusText = document.getElementById('api-import-status');
    const submitButton = document.getElementById('process-api-import-btn');

    if (!startDate || !endDate) return showToast("Dates requises.");

    // 1. Initialisation
    loader.classList.remove('hidden');
    statusText.textContent = 'Connexion...';
    submitButton.disabled = true;
    
    let salesImportedCount = 0; 
    let skippedCount = 0;
    const uniqueRawLines = new Map(); 

    try {
        // 2. Authentification
        if (!PROXY_URL) throw new Error("URL Proxy manquante");
        const authResponse = await fetch(`${PROXY_URL}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const authData = await authResponse.json();
        if (!authResponse.ok || !authData.token) throw new Error("Erreur Auth Proxy.");
        const token = authData.token;

        // 3. Téléchargement
        statusText.textContent = 'Téléchargement...';
        let currentPage = 1;
        const pageSize = 100; 
        const MAX_PAGES_SAFETY = 15; // Sécurité augmentée
        let hasMorePages = true;
        let previousPageFirstBill = null;
        let globalIndex = 0; 

        while(hasMorePages && currentPage <= MAX_PAGES_SAFETY) {
            const url = `${PROXY_URL}/api/sales?pageNum=${currentPage}&pageSize=${pageSize}&startDate=${startDate}&endDate=${endDate}&token=${encodeURIComponent(token)}`;
            
            const response = await fetch(url);
            const result = await response.json();

            if (!response.ok || result.code !== 200 || !result.data || result.data.length === 0) {
                break; 
            }
            
            const pageItems = result.data;

            // DETECTION DE BOUCLE
            if (pageItems[0].billNo === previousPageFirstBill) {
                console.warn("Page identique reçue. Arrêt.");
                break;
            }
            previousPageFirstBill = pageItems[0].billNo;

            let newItemsOnPage = 0;
            for (const item of pageItems) {
                globalIndex++;
                // Signature unique incluant l'index global pour différencier absolument tout
                const signature = `${item.billNo}|${item.goodsName}|${item.numNum}|${item.numPrice}|${globalIndex}`;
                
                if (!uniqueRawLines.has(signature)) {
                    uniqueRawLines.set(signature, item);
                    newItemsOnPage++;
                }
            }

            statusText.textContent = `Page ${currentPage} : ${newItemsOnPage} nouvelles lignes...`;

            if (pageItems.length > 0 && newItemsOnPage === 0) {
                break; 
            }

            if (pageItems.length < pageSize) {
                hasMorePages = false; 
            } else {
                currentPage++;
            }
        }

        const allSalesData = Array.from(uniqueRawLines.values());
        
        if (allSalesData.length === 0) {
             showToast("Aucune nouvelle vente trouvée.");
             closeModal('api-import-modal');
             return; 
        }

        // 4. Traitement
        statusText.textContent = 'Traitement...';
        
        const groupedSales = allSalesData.reduce((acc, item) => {
              const billNo = item.billNo;
              if (!acc[billNo]) {
                  let saleDate = new Date();
                  if (item.operDate) {
                      const d = new Date(item.operDate.replace(' ', 'T')); 
                      if (!isNaN(d.getTime())) saleDate = d; 
                  }
                  acc[billNo] = { billNo, items: [], totalPrice: 0, saleDate, hadDiscount: false };
              }

              const productNameLower = (item.goodsName || '').trim().toLowerCase(); 
              const matchedProduct = allProducts.find(p => p.name.trim().toLowerCase() === productNameLower);

              const quantity = parseFloat(item.numNum) || 0;
              const price = parseFloat(item.numPrice) || 0; 
              const priceAdd = parseFloat(item.numPriceAdd) || 0;
              const numBack = parseFloat(item.numBack) || 0;
              let discountPercent = parseFloat(item.discount);
              if (isNaN(discountPercent)) discountPercent = 100; 
              if (discountPercent < 100) acc[billNo].hadDiscount = true;
              
              const netQuantity = Math.max(0, quantity - numBack);

              if (netQuantity > 0) {
                  const lineTotal = ((price * netQuantity) + priceAdd) * (discountPercent / 100);
                  acc[billNo].totalPrice += lineTotal;

                  // === MODIFICATION PRINCIPALE ICI ===
                  // Nous ne vérifions plus "existingItem". Nous ajoutons tout avec un UUID.
                  
                  if (matchedProduct) {
                      // Cas 1 : Produit identifié
                      acc[billNo].items.push({
                          uuid: crypto.randomUUID(), // IDENTIFIANT UNIQUE
                          id: matchedProduct.id, 
                          name: matchedProduct.name, 
                          quantity: quantity, 
                          price: price, 
                          returned: numBack 
                      });
                  } else {
                      // Cas 2 : Produit inconnu
                      acc[billNo].items.push({
                          uuid: crypto.randomUUID(), // IDENTIFIANT UNIQUE
                          id: 'UNKNOWN_' + globalIndex, // ID unique temporaire
                          name: item.goodsName + ' (Non lié)',
                          quantity: quantity,
                          price: price,
                          returned: numBack,
                          isUnknown: true
                      });
                  }
              }
              return acc;
        }, {});

        const salesToSave = Object.values(groupedSales).filter(sale => sale.items.length > 0);

        // 5. Sauvegarde
        statusText.textContent = `Sauvegarde...`;
        const batch = writeBatch(db);
        
        for (const sale of salesToSave) {
             const alreadyImported = orderHistory.some(o => String(o.billNo) === String(sale.billNo));
             if (alreadyImported) { skippedCount++; continue; }

             const tempDeductions = new Map();
             
             for (const saleItem of sale.items) {
                 if (saleItem.isUnknown) continue; 

                 const product = allProducts.find(p => p.id === saleItem.id); 
                 if (!product) continue; 
                 
                 const qtyToDeduct = Math.max(0, saleItem.quantity - (saleItem.returned || 0));
                 if (qtyToDeduct <= 0) continue;

                 if (product.recipe && product.recipe.length > 0) {
                     for (const recipeItem of product.recipe) {
                         const current = tempDeductions.get(recipeItem.id) || 0;
                         tempDeductions.set(recipeItem.id, current + (recipeItem.quantity * qtyToDeduct));
                     }
                 } else if (product.linkedIngredientId) { 
                     const linkedQty = product.linkedIngredientQuantity || 1;
                     const current = tempDeductions.get(product.linkedIngredientId) || 0;
                     tempDeductions.set(product.linkedIngredientId, current + (linkedQty * qtyToDeduct));
                 }
             }

             // Déduction du stock
             for (const [ingId, qty] of tempDeductions.entries()) {
                 batch.update(doc(ingredientsCol, ingId), { quantity: increment(-qty) });
             }
             
             const safeDocId = String(sale.billNo).replace(/\//g, '_');
             
             // Nettoyage avant sauvegarde
             const itemsToSave = sale.items.map(i => {
                 const { isUnknown, ...rest } = i; 
                 return rest;
             });

             batch.set(doc(ordersCol, safeDocId), { 
                 items: itemsToSave, 
                 totalPrice: sale.totalPrice, 
                 createdAt: serverTimestamp(), 
                 saleDate: sale.saleDate, 
                 billNo: sale.billNo, 
                 hadDiscount: sale.hadDiscount
             });
             salesImportedCount++;
        }

        if (salesImportedCount > 0) {
             await batch.commit();
             showToast(`${salesImportedCount} ventes importées.`);
        } else {
             showToast(skippedCount > 0 ? "Tout est déjà à jour." : "Aucune donnée.");
        }

    } catch (error) {
        console.error(error);
        showToast("Erreur: " + error.message);
    } finally {
        loader.classList.add('hidden');
        statusText.textContent = '';
        submitButton.disabled = false;
        closeModal('api-import-modal');
    }
});


        // --- IMPORT/EXPORT CSV ---
        const CSV_INSTRUCTIONS = { 
            ingredients: `<p>4 colonnes: <strong>nom,quantite,unite,cout</strong></p><pre>nom,quantite,unite,cout\nTomates,10,kg,2.5\n</pre>`, 
            products: `<p>4 colonnes: <strong>nom,prix,type,details</strong></p>
                        <p>Pizza/Entrée/Dessert details: "NomIngrédient1:qty1:unit1;NomIngrédient2:qty2:unit2"</p>
                        <p>Boisson/Autre details: "NomArticleStock:qtyConsommée"</p>
                        <pre>Margherita,8.5,Pizza,"Pâte:1:p;Sauce:0.1:kg"\nCoca,2,Boisson,"Canette Coca:1"</pre>`, 
            orders: `<p>3 colonnes: <strong>date,produits,quantites</strong></p><p>Format date: JJ/MM/AAAA</p><pre>21/10/2025,"Margherita;Coca","2;1"</pre>` 
        }; 

        document.getElementById('import-ingredients-btn').addEventListener('click', () => { importType = 'ingredients'; document.getElementById('import-modal-title').textContent = 'Importer des Ingrédients'; document.getElementById('import-instructions').innerHTML = CSV_INSTRUCTIONS.ingredients; openModal('import-modal'); }); 
        document.getElementById('import-products-btn').addEventListener('click', () => { importType = 'products'; document.getElementById('import-modal-title').textContent = 'Importer des Produits'; document.getElementById('import-instructions').innerHTML = CSV_INSTRUCTIONS.products; openModal('import-modal'); }); 
        document.getElementById('import-orders-btn').addEventListener('click', () => { importType = 'orders'; document.getElementById('import-modal-title').textContent = 'Importer des Ventes (CSV)'; document.getElementById('import-instructions').innerHTML = CSV_INSTRUCTIONS.orders; openModal('import-modal'); }); 
        document.getElementById('cancel-import').addEventListener('click', () => closeModal('import-modal')); 
        document.getElementById('csv-file-input').addEventListener('change', () => { document.getElementById('process-import-btn').disabled = !document.getElementById('csv-file-input').files.length; }); 
        document.getElementById('process-import-btn').addEventListener('click', async () => { 
            const file = document.getElementById('csv-file-input').files[0]; 
            if (!file) return showToast("Veuillez choisir un fichier."); 
            document.getElementById('process-import-btn').disabled = true; 
            const reader = new FileReader(); 
            reader.onload = async (event) => { 
                const lines = event.target.result.split('\n').filter(line => line.trim() !== ''); 
                if (lines.length <= 1) { // Check if only header or empty
                     showToast("Le fichier CSV est vide ou ne contient que l'en-tête.");
                     closeModal('import-modal'); 
                     document.getElementById('csv-file-input').value = ''; 
                     document.getElementById('process-import-btn').disabled = false; 
                     return;
                }
                const header = lines.shift(); // Remove header line
                try { 
                    if (importType === 'ingredients') await importIngredients(lines); 
                    else if (importType === 'products') await importProducts(lines); 
                    else if (importType === 'orders') await importOrders(lines); 
                    showToast('Importation terminée !'); 
                } catch (error) { 
                    console.error("Import error:", error); 
                    showToast(`Erreur lors de l'importation: ${error.message}. Vérifiez la ligne correspondante dans votre fichier.`); 
                } finally { 
                    closeModal('import-modal'); 
                    document.getElementById('csv-file-input').value = ''; 
                    document.getElementById('process-import-btn').disabled = false; 
                } 
            }; 
            reader.readAsText(file); 
        });
        
        async function importIngredients(lines) { 
            const batch = writeBatch(db); 
            lines.forEach((line, index) => { 
                try {
                    const [name, quantity, unit, cost] = line.trim().split(','); 
                    if (name && quantity && unit) { 
                        // Use collection() and doc() to ensure a new document reference
                        batch.set(doc(collection(db, ingredientsCol.path)), { name: name.trim(), quantity: parseFloat(quantity), unit: unit.trim(), cost: parseFloat(cost) || 0, createdAt: serverTimestamp() }); 
                    } else {
                        console.warn(`Ligne ingrédient ignorée (données manquantes): Ligne ${index + 2}`, line);
                    }
                } catch(e) {
                     throw new Error(`Erreur à la ligne ${index + 2} (ingrédients) : ${e.message}`);
                }
            }); 
            await batch.commit(); 
        }

        async function importProducts(lines) { 
            const batch = writeBatch(db); 
            lines.forEach((line, index) => { 
                try {
                    const values = line.trim().split(','); 
                    const name = values[0], price = values[1], type = values[2], details = values.slice(3).join(','); 
                    if (!name || !price || !type || !details) {
                        console.warn(`Ligne produit ignorée (données manquantes): Ligne ${index + 2}`, line);
                        return; // Skip this line
                    }; 
                    const data = { name: name.trim(), price: parseFloat(price), type: type.trim(), createdAt: serverTimestamp() }; 
                    
                    if (['Pizza', 'Entrée', 'Dessert'].includes(data.type)) { // Recipe product
                         data.recipe = details.trim().replace(/"/g, '').split(';').map(part => { 
                             const [ingName, ingQty, ingUnit] = part.split(':'); 
                             if(!ingName || !ingQty || !ingUnit) throw new Error(`Format de recette incorrect pour ${name}`);
                             const ing = allIngredients.find(i => i.name.toLowerCase() === ingName.trim().toLowerCase()); 
                             if (!ing) throw new Error(`Ingrédient introuvable: ${ingName} pour le produit ${name}`); 
                             return { id: ing.id, name: ing.name, quantity: parseFloat(ingQty), unit: ingUnit.trim() }; 
                         }); 
                         if (data.recipe.length === 0 || data.recipe.some(r => !r.id)) throw new Error(`Recette invalide ou vide pour ${name}`);
                    
                    } else { // Linked product (Boisson, Autre)
                        // *** MODIFIED: Handle new linked format "Article:Qty" ***
                        const parts = details.trim().replace(/"/g, '').split(':');
                        const ingName = parts[0];
                        const ingQty = parseFloat(parts[1]);

                        if (!ingName || isNaN(ingQty) || ingQty <= 0) {
                            throw new Error(`Format de lien incorrect pour ${name}. Attendu: "NomArticleStock:Qty"`);
                        }

                        const linked = allIngredients.find(i => i.name.toLowerCase() === ingName.trim().toLowerCase()); 
                        if (!linked) throw new Error(`Article en stock introuvable: ${ingName} pour le produit ${name}`); 
                        data.linkedIngredientId = linked.id; 
                        data.linkedIngredientQuantity = ingQty;
                        // *** END MODIFICATION ***
                    } 
                    // Use collection() and doc() to ensure a new document reference
                    batch.set(doc(collection(db, productsCol.path)), data); 
                 } catch(e) {
                     throw new Error(`Erreur à la ligne ${index + 2} (produits) : ${e.message}`);
                 }
            }); 
            await batch.commit(); 
        }
        
        async function importOrders(lines) { 
            const batch = writeBatch(db); 
            for(const [index, line] of lines.entries()) { 
                 try {
                    const [dateRaw, pNamesRaw, qtiesRaw] = line.trim().split(','); 
                    if(!dateRaw || !pNamesRaw || !qtiesRaw) {
                         console.warn(`Ligne vente ignorée (données manquantes): Ligne ${index + 2}`, line);
                        continue; // Skip this line
                    }; 
                    
                    const [day, month, year] = dateRaw.trim().split('/');
                    if (!day || !month || !year || day.length !== 2 || month.length !== 2 || year.length !== 4) {
                         throw new Error(`Format de date invalide (attendu JJ/MM/AAAA) pour ${dateRaw}`);
                    }
                    const saleDate = new Date(`${year}-${month}-${day}T12:00:00Z`); // Use ISO format with time and Z for UTC
                    if (isNaN(saleDate.getTime())) {
                        throw new Error(`Date invalide: ${dateRaw}`);
                    }

                    const pNames = pNamesRaw.replace(/"/g, '').split(';'); 
                    const qties = qtiesRaw.replace(/"/g, '').split(';'); 
                    if (pNames.length !== qties.length) throw new Error(`Nombre de produits et quantités incohérent`);
                    
                    let items = [], total = 0; 
                    let deductions = new Map(); // Track deductions for this specific order line

                    for (let i = 0; i < pNames.length; i++) { 
                        const name = pNames[i].trim();
                        const qtyStr = qties[i].trim();
                        const qty = parseInt(qtyStr); 
                         if (isNaN(qty) || qty <= 0) throw new Error(`Quantité invalide: ${qtyStr} pour ${name}`);

                        const prod = allProducts.find(p => p.name.toLowerCase() === name.toLowerCase()); 
                        if (!prod) throw new Error(`Produit introuvable: ${name}`); 
                        items.push({ id: prod.id, name: prod.name, quantity: qty, price: prod.price }); 
                        total += prod.price * qty; 

                        // Aggregate deductions needed for this order line
                        if (prod.recipe && prod.recipe.length > 0) { 
                            for (const rItem of prod.recipe) {
                                const currentDeduction = deductions.get(rItem.id) || 0;
                                deductions.set(rItem.id, currentDeduction + (rItem.quantity * qty));
                            } 
                        } else if(prod.linkedIngredientId) {
                            const linkedQtyPerProduct = prod.linkedIngredientQuantity || 1; // *** NEW ***
                            const totalQtyToDeduct = linkedQtyPerProduct * qty; // *** NEW ***
                            const currentDeduction = deductions.get(prod.linkedIngredientId) || 0;
                            deductions.set(prod.linkedIngredientId, currentDeduction + totalQtyToDeduct); // *** MODIFIED ***
                        }
                    } 

                    // Apply deductions via batch update
                     for(const [ingId, qtyToDeduct] of deductions.entries()) {
                         // Note: We don't check stock here during import, assuming historical data is correct
                         // or stock adjustment isn't the primary goal of historical import.
                         // If stock checking IS needed, you'd query the current stock first.
                        batch.update(doc(ingredientsCol, ingId), { quantity: increment(-qtyToDeduct) }); 
                     }

                     // Use collection() and doc() to ensure a new document reference
                    batch.set(doc(collection(db, ordersCol.path)), { items, totalPrice: total, createdAt: serverTimestamp(), saleDate }); 
                 } catch(e) {
                     throw new Error(`Erreur à la ligne ${index + 2} (ventes) : ${e.message}`);
                 }
            } 
            await batch.commit(); 
        }


        const downloadCSV = (content, filename) => { const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", filename); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
        document.getElementById('export-ingredients-btn').addEventListener('click', () => { let csv = "nom,quantite,unite,cout\n"; allIngredients.forEach(i => { csv += `${i.name},${i.quantity},${i.unit},${i.cost || 0}\n`; }); downloadCSV(csv, 'ingredients.csv'); });
        document.getElementById('export-products-btn').addEventListener('click', () => { 
            let csv = "nom,prix,type,details\n"; 
            allProducts.forEach(p => { 
                let d = ''; 
                if (p.type === 'Pizza' || p.type === 'Entrée' || p.type === 'Dessert') { 
                    if(p.recipe) d = `"${p.recipe.map(r => `${r.name}:${r.quantity}:${r.unit}`).join(';')}"`; 
                } else { // Linked product
                    // *** MODIFIED: Export in new format "Article:Qty" ***
                    const l = allIngredients.find(i => i.id === p.linkedIngredientId); 
                    const q = p.linkedIngredientQuantity || 1;
                    d = l ? `"${l.name}:${q}"` : '"NON LIÉ:1"'; 
                    // *** END MODIFICATION ***
                } 
                csv += `${p.name},${p.price},${p.type},${d}\n`; 
            }); 
            downloadCSV(csv, 'produits.csv'); 
        });
        document.getElementById('export-orders-btn').addEventListener('click', () => { 
            let csv = "date,produits,quantites,prix_total\n"; 
            orderHistory.forEach(o => { 
                const date = formatDateToDDMMYYYY(o.saleDate || o.createdAt); 
                const p = o.items.map(i => i.name).join(';'); 
                const q = o.items.map(i => i.quantity).join(';'); // Ligne corrigée
                csv += `${date},"${p}","${q}",${o.totalPrice.toFixed(2)}\n`; 
            }); 
            downloadCSV(csv, 'historique_ventes.csv'); 
        });
        // --- GESTION DE LA SUPPRESSION MASSIVE ---

        // 1. Tout cocher / Tout décocher
        document.getElementById('select-all-orders').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.order-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateDeleteButtonVisibility();
        });

        // 2. Détecter le clic sur une case individuelle
        document.getElementById('order-history-list').addEventListener('change', (e) => {
            if (e.target.classList.contains('order-checkbox')) {
                updateDeleteButtonVisibility();
                
                // Si on décoche une case, on décoche aussi "Tout sélectionner"
                if (!e.target.checked) {
                    document.getElementById('select-all-orders').checked = false;
                }
            }
        });

        // 3. Afficher ou cacher le bouton rouge
        function updateDeleteButtonVisibility() {
            const selectedCount = document.querySelectorAll('.order-checkbox:checked').length;
            const btn = document.getElementById('delete-selected-orders-btn');
            const countSpan = document.getElementById('selected-count');
            
            countSpan.textContent = selectedCount;
            
            if (selectedCount > 0) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        // 4. LA FONCTION DE SUPPRESSION (Stock + Vente)
        document.getElementById('delete-selected-orders-btn').addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedIds.length === 0) return;

            if (!confirm(`⚠️ ATTENTION ⚠️\n\nVous allez supprimer ${selectedIds.length} ventes définitivement.\n\nLe stock des ingrédients sera automatiquement RESTAURÉ.\n\nConfirmer la suppression ?`)) {
                return;
            }

            // Désactiver le bouton pendant le traitement
            const btn = document.getElementById('delete-selected-orders-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader border-white border-t-transparent h-4 w-4"></div> Traitement...';
            btn.disabled = true;

            try {
                const batch = writeBatch(db);
                let operationsCount = 0;

                // Pour chaque vente sélectionnée...
                for (const orderId of selectedIds) {
                    const order = orderHistory.find(o => o.id === orderId);
                    if (!order) continue;

                    // A. Restaurer le stock (Même logique que suppression unitaire)
                    for (const item of order.items) {
                        const prod = allProducts.find(p => p.id === item.id);
                        if (!prod) continue;

                        // Quantité à restaurer (Ventes - Retours)
                        const qtyToRestore = Math.max(0, item.quantity - (item.returned || 0));
                        if (qtyToRestore <= 0) continue;

                        if (prod.recipe && prod.recipe.length > 0) {
                            // Pizza/Plat composé
                            for (const recipeItem of prod.recipe) {
                                batch.update(doc(ingredientsCol, recipeItem.id), { 
                                    quantity: increment(recipeItem.quantity * qtyToRestore) 
                                });
                                operationsCount++;
                            }
                        } else if (prod.linkedIngredientId) {
                            // Boisson/Article simple
                            const linkedQty = prod.linkedIngredientQuantity || 1;
                            batch.update(doc(ingredientsCol, prod.linkedIngredientId), { 
                                quantity: increment(linkedQty * qtyToRestore) 
                            });
                            operationsCount++;
                        }
                    }

                    // B. Supprimer la vente
                    batch.delete(doc(ordersCol, orderId));
                    operationsCount++;
                }

                await batch.commit();
                
                showToast(`${selectedIds.length} ventes supprimées et stock restauré avec succès.`);
                
                // Reset UI
                document.getElementById('select-all-orders').checked = false;
                btn.classList.add('hidden');

            } catch (error) {
                console.error("Erreur suppression massive:", error);
                showToast("Une erreur est survenue lors de la suppression.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });
    </script>

    <!-- Script d'authentification -->
    <script>
        // Configuration des utilisateurs
        const VALID_USERS = [
            { username: 'admin', password: 'admin123' },
            { username: 'test', password: 'test123' }
        ];

        const AUTH_SESSION_KEY = 'solo_auth_session';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 heures

        // Fonctions d'authentification
        function verifyCredentials(username, password) {
            return VALID_USERS.some(user => 
                user.username === username && user.password === password
            );
        }

        function createSession(username) {
            const session = {
                username: username,
                timestamp: Date.now(),
                expiresAt: Date.now() + SESSION_DURATION
            };
            localStorage.setItem(AUTH_SESSION_KEY, JSON.stringify(session));
            return session;
        }

        function getSession() {
            const sessionStr = localStorage.getItem(AUTH_SESSION_KEY);
            if (!sessionStr) return null;
            
            try {
                const session = JSON.parse(sessionStr);
                if (Date.now() > session.expiresAt) {
                    localStorage.removeItem(AUTH_SESSION_KEY);
                    return null;
                }
                return session;
            } catch (e) {
                localStorage.removeItem(AUTH_SESSION_KEY);
                return null;
            }
        }

        function clearSession() {
            localStorage.removeItem(AUTH_SESSION_KEY);
        }

        function showApp() {
            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            if (loginPage) loginPage.classList.add('hidden');
            if (appContainer) appContainer.classList.remove('hidden');
        }

        function showLogin() {
            const loginPage = document.getElementById('login-page');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const errorDiv = document.getElementById('login-error');
            
            if (loginPage) loginPage.classList.remove('hidden');
            if (appContainer) appContainer.classList.add('hidden');
            if (loginForm) loginForm.reset();
            if (errorDiv) errorDiv.classList.add('hidden');
        }

        // Gestion du formulaire de login
        function initLoginForm() {
            const loginForm = document.getElementById('login-form');
            if (!loginForm) {
                console.error('Formulaire de login non trouvé');
                return;
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const submitBtn = document.getElementById('login-submit-btn');
                const submitText = document.getElementById('login-submit-text');
                const loader = document.getElementById('login-loader');
                const errorDiv = document.getElementById('login-error');
                const errorMessage = document.getElementById('login-error-message');

                if (!username || !password) {
                    if (errorMessage) errorMessage.textContent = 'Veuillez remplir tous les champs';
                    if (errorDiv) errorDiv.classList.remove('hidden');
                    return;
                }

                // Afficher le loader
                if (submitBtn) submitBtn.disabled = true;
                if (submitText) submitText.textContent = 'Connexion...';
                if (loader) loader.classList.remove('hidden');
                if (errorDiv) errorDiv.classList.add('hidden');

                // Simuler un délai pour l'authentification
                await new Promise(resolve => setTimeout(resolve, 500));

            // Vérifier les identifiants
            if (verifyCredentials(username, password)) {
                createSession(username);
                showApp();
                // Initialiser Firebase après authentification réussie
                if (typeof initAppAfterAuth === 'function') {
                    initAppAfterAuth();
                }
            } else {
                    if (errorMessage) errorMessage.textContent = 'Nom d\'utilisateur ou mot de passe incorrect';
                    if (errorDiv) errorDiv.classList.remove('hidden');
                    if (submitBtn) submitBtn.disabled = false;
                    if (submitText) submitText.textContent = 'Se connecter';
                    if (loader) loader.classList.add('hidden');
                }
            });
        }

        // Vérification de la session au chargement
        function initAuth() {
            const session = getSession();
            if (session) {
                showApp();
            } else {
                showLogin();
            }
            initLoginForm();
        }

        // Initialiser quand le DOM est prêt
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAuth);
        } else {
            initAuth();
        }

        // Si l'utilisateur est déjà authentifié (session existante), initialiser Firebase
        if (getSession()) {
            // Attendre un peu pour que le DOM soit prêt
            setTimeout(() => {
                if (typeof initAppAfterAuth === 'function') {
                    initAppAfterAuth();
                }
            }, 100);
        }

        // Fonction de déconnexion
        window.logout = function() {
            clearSession();
            showLogin();
        };
    </script>
    </div>
</body>
</html>







